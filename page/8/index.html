<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Sakuraのblog" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="Sakuraのblog">
<meta property="og:url" content="http://eternalsakura13.com/page/8/index.html">
<meta property="og:site_name" content="Sakuraのblog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sakuraのblog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'QOPH9ID41Z',
      apiKey: '',
      indexName: 'sakura',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://eternalsakura13.com/page/8/"/>





  <title>Sakuraのblog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-113420358-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sakuraのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/08/jadx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/jadx/" itemprop="url">解决jadx的反编译卡顿和inconsistent code</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T02:43:05+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="jadx介绍"><a href="#jadx介绍" class="headerlink" title="jadx介绍"></a>jadx介绍</h2><p>jadx 的功能非常的强大,它可以处理大部分反编译的需求。<br>jadx 优点：</p>
<ul>
<li>图形化的界面。</li>
<li>拖拽式的操作。</li>
<li>反编译输出 Java 代码。</li>
<li>导出 Gradle 工程。</li>
<li>反混淆</li>
</ul>
<h2 id="安装-jadx"><a href="#安装-jadx" class="headerlink" title="安装 jadx"></a>安装 jadx</h2><p>Jadx Github ：<br><a href="https://github.com/skylot/jadx" target="_blank" rel="noopener">https://github.com/skylot/jadx</a><br>直接下载最新版就可以了，现在的最新版是 jadx-0.6.1 。下载好解压之后，你会获得这样的目录结构：<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo8gnvuaz4j312c0gw78y.jpg" alt=""></p>
<h2 id="inconsistent-code"><a href="#inconsistent-code" class="headerlink" title="inconsistent code"></a>inconsistent code</h2><p>有时候有代码，反编译的不完整，你会看到 JADX WARNING : inconsistent code 标志的错误。<br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo8gs9rv39j30m80hi410.jpg" alt=""><br>这一段代码，就已经不是 Java 的代码了，不利于我们的阅读。而 jadx 为了应对这样的情况，可以尝试开启 Show inconsistent code 开关。你可以在 File -&gt; Preferences 中找到它。<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo8gsp3ovxj30e50kcq7i.jpg" alt=""><br>开启 inconsistent code 之后，我们再来看看这段代码，就感觉亲切了。<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo8gt1cio6j30m80jk42c.jpg" alt=""><br>这样处理的代码，大部分为伪代码，可能会有错误的地方，具体问题具体分析吧。</p>
<h2 id="反编译错误或者卡顿"><a href="#反编译错误或者卡顿" class="headerlink" title="反编译错误或者卡顿"></a>反编译错误或者卡顿</h2><p>jadx 反编译一些小的 Apk，一点压力都没有，但是对于一些比较重的 Apk，一般 Apk 大于 50MB 的，你都可能遇到使用 jadx 反编译的时候卡死的问题。<br>如果你看了 terminal 中 Log 输出，你应该可以发现，实际上它是因为 OOM 引起的。<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo8gtnai2fj30m80l5aha.jpg" alt=""><br>官方对于这样因为内存不足引发的问题，也提供了一些解决方案。</p>
<h3 id="1、减少处理的线程数。"><a href="#1、减少处理的线程数。" class="headerlink" title="1、减少处理的线程数。"></a>1、减少处理的线程数。</h3><p>jadx 为了加快编译的效率，所以是使用多线程处理的，而多个线程会耗费跟多的内存。所以减小反编译时候的线程数，是一个有效的方法。</p>
<p>如果使用命令行的话，可以使用 -j 1 参数，配置线程数为 1，不配置的话，默认线程数为 4。</p>
<p>而使用 jadx-gui 的话，可以在 Preferences 中，通过配置 Processing threads count 来配置线程数。</p>
<h3 id="2、修改-jadx-脚本"><a href="#2、修改-jadx-脚本" class="headerlink" title="2、修改 jadx 脚本"></a>2、修改 jadx 脚本</h3><p>直接编辑 ./bin 目录下的 jadx 脚本，配置找到 DEFAULT_JVM_OPTS ，将它设置为 DEFAULT_JVM_OPTS=”-Xmx2500M” ，就可以配置当前使用的内存大小。（例如微信，我设置为5个G才跑完，不过貌似跑出来的结果不完整，不过总算是不会崩溃了）</p>
<h3 id="3、使用命令行命令"><a href="#3、使用命令行命令" class="headerlink" title="3、使用命令行命令"></a>3、使用命令行命令</h3><p>如果以上方式都不好用，在没有更好的办法的情况下，你可以直接使用命令行，通过 jadx 的命令进行放编译。并将线程数配置为 1 ，这样虽然慢一些，但是多数情况下，是可以正常输出反编译后的代码的。</p>
<p>举个例子：</p>
<p><code>jadx -d out -j 1 classes.dex</code><br><code>jadx -e -j 1 input.apk</code><br>更多命令，可以通过 jadx -h 命令进行查看。<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo8gv9mh4jj30m80cxwh8.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/08/jni2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/jni2/" itemprop="url">native 方法的动态注册</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T02:35:41+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="动态注册的原理"><a href="#动态注册的原理" class="headerlink" title="动态注册的原理"></a>动态注册的原理</h2><p>JNI 允许我们提供一个函数映射表，注册给 JVM，这样 JVM 就可以用函数映射表来调用相应的函数，而不必通过函数名来查找相关函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java 代码中的函数是 dynamicRegFromJni，调用的 native 方法是 nativeDynamicRegFromJni，该方法没有参数， 返回值是一个字符串。</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jstring <span class="title">nativeDynamicRegFromJni</span><span class="params">(JNIEnv *env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*env) -&gt; NewStringUTF(env, <span class="string">"动态注册调用成功"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//函数映射表</span></span><br><span class="line">JNINativeMethod nativeMethod[] = &#123;&#123;<span class="string">"dynamicRegFromJni"</span>, <span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span>*)nativeDynamicRegFromJni&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *jvm, <span class="keyword">void</span> *reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JNIEnv *env;</span><br><span class="line">    </span><br><span class="line">    jclass clz = (*env) -&gt; FindClass(env, <span class="string">"com/sakura/hellojni/MainActivity"</span>);</span><br><span class="line"></span><br><span class="line">    (*env) -&gt; RegisterNatives(env, clz, nativeMethod, <span class="keyword">sizeof</span>(nativeMethod) / <span class="keyword">sizeof</span>(nativeMethod[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="函数映射表"><a href="#函数映射表" class="headerlink" title="函数映射表"></a>函数映射表</h2><h3 id="JNINativeMethod"><a href="#JNINativeMethod" class="headerlink" title="JNINativeMethod"></a>JNINativeMethod</h3><p>这是一个结构体，在 jni.h 头文件中定义：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature;</span><br><span class="line">    <span class="keyword">void</span>* fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure></p>
<p>Java 与 jni 通过该结构体建立联系，其中有三个变量：</p>
<ul>
<li>name：Java 中函数的名字。</li>
<li>signature：签名符号，描述了函数的参数和返回值</li>
<li>fnPtr：函数指针，指向一个被调用的函数</li>
</ul>
<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>例如<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JNINativeMethod nativeMethod[] = &#123;&#123;<span class="string">"dynamicRegFromJni"</span>, <span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span>*)nativeDynamicRegFromJni&#125;&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，里面有一个成员，该成员第一个参数 “dynamicRegFromJni”,java 函数名；第二个参数“()Ljava/lang/String:”,是签名符号，意思是该函数没有参数，返回一个字符串 ；第三个参数就是要调用的 native 方法。<br>其他例子：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * JNI registration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">    &#123; <span class="string">"isLoggable"</span>,      <span class="string">"(Ljava/lang/String;I)Z"</span>, (<span class="keyword">void</span>*) android_util_Log_isLoggable &#125;,</span><br><span class="line">    &#123; <span class="string">"println_native"</span>,  <span class="string">"(IILjava/lang/String;Ljava/lang/String;)I"</span>, (<span class="keyword">void</span>*) android_util_Log_println_native &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="JNI-OnLoad-函数"><a href="#JNI-OnLoad-函数" class="headerlink" title="JNI_OnLoad()函数"></a>JNI_OnLoad()函数</h2><p>当 java 通过 System.loadLibrary 加载完 JNI 动态库后，紧接着会调用 JNI_OnLoad 的函数。</p>
<h2 id="RegisterNatives"><a href="#RegisterNatives" class="headerlink" title="RegisterNatives"></a>RegisterNatives</h2><p>动态注册的工作就是在这里完成的。<br>RegisterNatives在 jni.h 中是这么定义的：</p>
<h3 id="c"><a href="#c" class="headerlink" title="c++"></a>c++</h3><p><code>jint RegisterNatives(jclass clazz, const JNINativeMethod* methods,jint nMethods)</code><br>该函数有三个参数：<br>clazz: java 类名，通过 FindClass 得到<br>methods: JNINativeMethod 结构体指针<br>nMethods: 方法个数</p>
<p>调用：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*env) -&gt; RegisterNatives(env, clz, nativeMethod, <span class="keyword">sizeof</span>(nativeMethod) / <span class="keyword">sizeof</span>(nativeMethod[<span class="number">0</span>]));</span><br></pre></td></tr></table></figure></p>
<h3 id="c-1"><a href="#c-1" class="headerlink" title="c"></a>c</h3><p><code>jint (*RegisterNatives)(JNIEnv*, jclass, const JNINativeMethod*,jint);</code><br>该函数有四个参数：<br><code>JNIEnv*</code>: env<br>clazz: java 类名，通过 FindClass 得到<br>methods: JNINativeMethod 结构体指针<br>nMethods: 方法个数</p>
<p>调用：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env -&gt; RegisterNatives(clz, nativeMethod, <span class="keyword">sizeof</span>(nativeMethod) / <span class="keyword">sizeof</span>(nativeMethod[<span class="number">0</span>]));</span><br></pre></td></tr></table></figure></p>
<h3 id="c和c"><a href="#c和c" class="headerlink" title="c和c++"></a>c和c++</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">JNIEnv</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这是因为在jni.h中，c++的JNIEnv是_JNIEnv,而c的是<code>JNINativeInterface*</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">JNIEnv</span> &#123;</span></span><br><span class="line">    <span class="comment">/* do not rename this; it does not seem to be entirely opaque */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">functions</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">jint <span class="title">RegisterNatives</span><span class="params">(jclass clazz, <span class="keyword">const</span> JNINativeMethod* methods,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint nMethods)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;RegisterNatives(<span class="keyword">this</span>, clazz, methods, nMethods); &#125;</span><br></pre></td></tr></table></figure>
<p>在c++中，实际上调用的是<code>functions-&gt;RegisterNatives(this, clazz, methods, nMethods)</code><br>而functions是<code>JNINativeInterface*</code>类型的指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    jint (*RegisterNatives)(JNIEnv*, jclass, <span class="keyword">const</span> JNINativeMethod*,jint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c中,<code>JNIEnv *env</code>,实际上是<code>JNINativeInterface **</code>，这样的NINativeInterface的二级指针。<br>所以<br><code>(*env) -&gt; RegisterNatives(env, clz, nativeMethod, sizeof(nativeMethod) / sizeof(nativeMethod[0]))</code><br>就是先通过解引用得到<code>JNINativeInterface *</code>结构体指针，再通过它调用<br><code>jint (*RegisterNatives)(JNIEnv*, jclass, const JNINativeMethod*,jint);</code><br>这个函数指针来使用函数。</p>
<p><strong>tip:之所以是函数指针，是因为c中结构体成员中不能有函数</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/07/trans_gp0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/trans_gp0/" itemprop="url">Google Project Zero 成员教你如何入门搞安全（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T21:01:04+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂项/" itemprop="url" rel="index">
                    <span itemprop="name">杂项</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>已经有很多人（包括我谷歌的同事, Parisa 和 Michal 已经就这个话题写过自己的感受, 我建议你仔细阅读.我知道我写的这些可能已经有人说过了, 但是每隔一段时间, 我总是会再次遇到这个问题, 于是我决定写下自己的经验.</p>
<p>请注意, 我是一个应用安全研究员, 我是从漏洞研究/安全审查/ bug 寻找/黑客攻击等角度来写这篇文章的.在安全领域还有很多其他的道路, 比如安全研发, 恶意软件分析等等, 这些我并不熟悉.</p>
<p>那么, 我是谁？为什么你要在这个话题上信任我呢？嗯, 首先我不是说你应该完全信任我, 因为每个人的经验和每个人的道路都是有所不同的.但如果您对我感到好奇, 我可以告诉您, 我现在是 Google Project Zero 的成员, 我曾经是谷歌安全团队的成员, 是多个安全工具的作者, 如果你在这个博客上滚动足够长的时间, 你会发现我已经从事安全工作十多年了.</p>
<p>我认识的安全研究员来自很多不同的背景, 但是我的背景有所不同, 我有相当强的学术背景, 这在我的同行中是非常不典型的, 当然这并不是进入安全领域的要求.然而, 我所知道的安全研究员中的大多数人都有一些共同点, 这里我们来看第一条：</p>
<h2 id="自己做点东西"><a href="#自己做点东西" class="headerlink" title="自己做点东西"></a>自己做点东西</h2><p>对于我所知道的业内大多数人来说, 在从事相关工作之前, 安全只是一项业余爱好.当然, 如果你只是考虑如何学习安全, 在告诉你如何开始之前, 告诉你自己做点东西并不会有什么帮助.继续阅读, 我会在下面提到如何开始. 但是首先, 还有一件事你应该注意 (不要让它阻碍你, 我们将在后面看到如何解决它)</p>
<p>现在开始学习安全, 比十年前困难的多</p>
<p>我怀疑不是每个人都会承认, 但是安全在过去这些年, 确实有了很大提高.是的, 如果你足够深入的话, 你将会发现用十多年前的技术仍然可以运行的软件或者硬件, 例如 Web 浏览器.当我正在研究我的第一个 Windows 漏洞利用（堆溢出）时, 我感到十分沮丧, 因为微软最近引入了新的safe unlink 机制, 所以我读到的一些众所周知的堆漏洞利用技术已经不再有效. 10 年后, 刚开始学习安全的人们不仅需要处理 safe unlink 和 stack cookie , 还需要知道 SafeSEH / SEHOP, DEP, ASLR, CFG, ACG 还有浏览器的 sandbox 等等.并不限于 Web 浏览器, 如果你对比一下十年前和现在的 Web 应用框架, 你会发现在安全技术上已经了显著的不同.</p>
<p>不要害怕上面这一段文字, 那么你应该如何对付日益陡峭的学习曲线呢?</p>
<h2 id="利用好学习资源"><a href="#利用好学习资源" class="headerlink" title="利用好学习资源"></a>利用好学习资源</h2><p>一般而言, 刚开始入门的难度比较高, 实际上, 现在的学习资源也比以前要丰富.</p>
<p>但是另一个警告是: 你需要能够走出去并且自主学习, 没有人会牵着你的手, 或者成为你的导师 (可能总是有厉害的师父来帮助学徒, 但是黑客很少这样做) . 如果你喜欢按照预先设定的课程进行 (就像我承认的我的大部分教育所做的那样) , 那么你可能就不会在安全方面走得太远.</p>
<p>在获得正确的学习资源之前, 您需要正确地提问. 谷歌搜索 “如何成为黑客” 和类似的问题, 在现在仍然会得到与以前一样的胡说八道. 相反, 请尝试更加细致的问题, 例如:</p>
<p>我感兴趣的这个软件/硬件是如何工作的？ 它基于什么技术？ 有我可以阅读的源代码？教程? 图书吗？<br>有人已经设法成功破解了我想要破解的这一软件/硬件吗？ 他们发布了 WriteUp 吗？Exp 呢？ 会议介绍呢？ 我真的明白他们是怎么做的了么？<br>由此可见, 你自己必须在技术上相当不错, 以了解由别人制作的真实软件或硬件是如何工作的. 虽然编写代码和阅读代码的技能并不完全相同, 但仍存在相当大的重叠, 所以如果您不习惯写代码, 在进一步深入研究安全之前, 您可能需要改进这一点.</p>
<p>不要忘记第二点. 虽然之前我对技术性的东西还算是比较好的, 但是直到我开始阅读其他人发布的漏洞研究和 Exp 后, 我才真正理解安全.</p>
<p>还有另一个警告: 当你遇到你不了解的东西时, 不要放弃. 特别是在刚开始阅读各种资源时, 你遇到的很多问题. 跳过这些部分是简单的方法, 但也是错误的方法. 相反, 想想遇到的每一比特信息都是你不了解的, 把它们作为线索, 想想你还需要学习什么.</p>
<p>虽然我写到没有人会牵着你的手, 但这并不意味着你不应该提问. 事实上, 你应该自在一点. 人们不会为你而放下自己所做的工作, 但如果你卡住了, 他们可能会给你一个正确的方向.</p>
<h2 id="使用推特"><a href="#使用推特" class="headerlink" title="使用推特"></a>使用推特</h2><p>拥护一个特定的社交网络看起来很奇怪, 但一个重要事实是很多安全团队都使用 Twitter 来分享新闻, 而且更重要的是那些最近的研究、漏洞、 PoC 、会议演讲和其他类似的链接. 我真的不知道这些是怎么发生的, 也许是短消息的形式让人们更方便地分享资源链接, 而不用受到漫长而不必要的讨论的困扰. 所以, 在 Twitter 上找那些研究或发表你感兴趣东西的人, 然后翻阅他们的推特吧.</p>
<p>除了 Twitter 以外, 你可以找到有趣资源的其他地方是 r / netsec 和 Hacker News (尽管它除了安全性外还有其他的东西) . 你还可以看看安全会议的演讲和录音 (它们有很多, 但并不都是好的. 重点集中于技术性较强的那些会议) .</p>
<h2 id="打-CTF-是一种很好的学习方式"><a href="#打-CTF-是一种很好的学习方式" class="headerlink" title="打 CTF 是一种很好的学习方式"></a>打 CTF 是一种很好的学习方式</h2><p>另一个我给你们的奇怪建议是我自己几乎从不玩 CTF , 但是还记得我写的有关难度曲线的内容吗 ? CTF 可以让你的学习经历更加循序渐进, 因为 CTF 的赛题有多种难度级别 (你通常可以通过每个赛题的分数来分辨) , 所以你可以从更简单的开始, 然后从那里开始一点点学习. 举个例子, 在关闭缓解措施之后练习漏洞利用. 知道这儿有一个 bug 或方式来解决它，也是一些安慰.</p>
<p>几乎每个星期在一个地方都有一个 CTF , 其中大部分都是可以在线解题, 你可以在这里找到时间安排. 如果你不能解决赛题, 不要忘了他人解题的 WriteUp .</p>
<p>CTF 可以成为一种很有趣的经历, 但当你学会一些东西之后, 别忘了继续研究真实世界的目标, 你可能会感到十分惊喜!</p>
<h2 id="但是不要害怕失败-哪怕一次又一次"><a href="#但是不要害怕失败-哪怕一次又一次" class="headerlink" title="但是不要害怕失败, 哪怕一次又一次."></a>但是不要害怕失败, 哪怕一次又一次.</h2><p>现在漏洞研究的工作常常是让人十分沮丧的, 大部分你尝试的东西都不会成功, 但你必须接受这一点. 但不要因此而泄气. 这不仅仅是发生在你身上, 对于每一个富有经验的研究员来说也是如此. 我们往往只能看到别人的成功, 却不知道背后的代价. 当你失败的时候, 在继续前进之前一定要弄明白失败的原因.</p>
<h2 id="你比你想象的更加聪明-反之亦然-其他人并不像你想的那样聪明"><a href="#你比你想象的更加聪明-反之亦然-其他人并不像你想的那样聪明" class="headerlink" title="你比你想象的更加聪明(反之亦然: 其他人并不像你想的那样聪明)."></a>你比你想象的更加聪明(反之亦然: 其他人并不像你想的那样聪明).</h2><p>这可能是一个有争议的观点, 因为其他人提出了 “你不比开发者更聪明” 的建议. 虽然这是真实的, 对于业内很多人来说, 这是一个很好的建议, 但对许多刚刚入门或正在考虑入门的人来说, 这可能是错误的, 事实是, 在看到别的聪明人做什么之后, 如果自己没有在这个领域做任何事情, 就很容易怀疑自己的能力. 让我举个例子: 现在你可能听起来很奇怪, 但是当我开始把安全作为一种爱好时, 我认为我从来没有足够的能力去发现 Windows 中的漏洞。我从来没有尝试过，但是我偶然发现了我的第一个 Windows 漏洞：我 fuzz 了一些蹩脚的图像库，过了一段时间，我有一些崩溃样本. 而当我意外地点击 Windows 中的其中一个崩溃样本时，Windows 资源管理器崩溃了 - 这是 CVE-2008-3013。</p>
<p>另外一个例子: 在对一个软件进行审查的时候, 你可能会有一个想法, 然后想 “不，这太愚蠢了，开发人员肯定会想到这个”. 事实是, 他们经常没有. 公平地说, 那不是因为他们愚蠢, 那是因为他们当时想到了其他问题, 但是, 如果“我比他们聪明”的思维方式有助于突破你为自己设定的人为限制.</p>
<p>当你和别人, 特别是开发者交谈的时候, 请记住，他们是代码方面的专家，但是你是安全方面的专家.</p>
<h2 id="我如何证明自己的能力"><a href="#我如何证明自己的能力" class="headerlink" title="我如何证明自己的能力?"></a>我如何证明自己的能力?</h2><p>可以从赚钱开始: 很多公司都有 bug bounty program: Google, FB, MS, etc</p>
<p>即使你挖到的漏洞拿不到奖金, 但能帮助到他人, 仍然能够帮助证明你的实力.</p>
<p>挖漏洞并不是唯一的途径, 开发安全工具, 做防御性的研究, 同样是很有价值的.</p>
<h2 id="还有什么是我需要知道的"><a href="#还有什么是我需要知道的" class="headerlink" title="还有什么是我需要知道的?"></a>还有什么是我需要知道的?</h2><p>安全研究员的人生可能并不像你想象的那么光鲜亮丽, 为了成为一个大牛, 你需要在电脑面前坐到<strong>天荒地老</strong>. 这是一份有挑战性的工作, 并且需要花费相当大的精力.</p>
<p>原文地址:<a href="http://ifsec.blogspot.jp/2018/02/so-you-want-to-work-in-security-and-for.html" target="_blank" rel="noopener">http://ifsec.blogspot.jp/2018/02/so-you-want-to-work-in-security-and-for.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/07/jni/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/jni/" itemprop="url">Android JNI入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T18:47:45+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h1><h2 id="JNI引入"><a href="#JNI引入" class="headerlink" title="JNI引入"></a>JNI引入</h2><ul>
<li>JNI : Java本地接口,Java Native Interface, 它是一个协议, 该协议用来沟通Java代码和外部的本地C/C++代码, 通过该协议 Java代码可以调用外部的本地代码, 外部的C/C++ 代码可以调用Java代码;</li>
<li>C和Java的侧重 :<br>C语言 : C语言中最重要的是函数 function;<br>Java语言 : Java中最重要的是 JVM, class类, 以及class中的方法;</li>
<li>C与Java如何交流 :<br>JNI规范 : C语言与Java语言交流需要一个适配器, 中间件, 即 JNI, JNI提供了一种规范;<br>C语言中调用Java方法 : 可以让我们在C代码中找到Java代码class中的方法, 并且调用该方法;<br>Java语言中调用C语言方法 : 同时也可以在Java代码中, 将一个C语言的方法映射到Java的某个方法上;<br>JNI桥梁作用 : JNI提供了一个桥梁, 打通了C语言和Java语言之间的障碍;</li>
<li>JNI中的一些概念 :<br>native : Java语言中修饰本地方法的修饰符, 被该修饰符修饰的方法没有方法体;<br>Native方法 : 在Java语言中被native关键字修饰的方法是Native方法;<br>JNI层 : Java声明Native方法的部分;<br>JNI函数 : JNIEnv提供的函数, 这些函数在jni.h中进行定义;<br>JNI方法 : Native方法对应的JNI层实现的 C/C++方法, 即在jni目录中实现的那些C语言代码;<h2 id="JNI在Android中作用"><a href="#JNI在Android中作用" class="headerlink" title="JNI在Android中作用"></a>JNI在Android中作用</h2>JNI可以调用本地代码库(即C/C++代码), 并通过 Dalvik虚拟机 与应用层 和 应用框架层进行交互, Android中JNI代码主要位于应用层 和 应用框架层;<br>应用层 : 该层是由JNI开发, 主要使用标准JNI编程模型;<br>应用框架层 : 使用的是Android中自定义的一套JNI编程模型, 该自定义的JNI编程模型弥补了标准JNI编程模型的不足;<br>JNI是连接框架层 (Framework - C/C++) 和应用框架层(Application Framework - Java)的纽带;<br>Android中JNI源码位置 : 在应用框架层中, 主要的JNI代码位于 framework/base目录下, 这些模块被编译成共享库之后放在 /system/lib 目录下;<br>NDK与JNI区别 : </li>
<li>NDK: NDK是Google开发的一套开发和编译工具集, 主要用于Android的JNI开发;</li>
<li>JNI : JNI是一套编程接口, 用来实现Java代码与本地的C/C++代码进行交互;<h2 id="JNI编程步骤"><a href="#JNI编程步骤" class="headerlink" title="JNI编程步骤:"></a>JNI编程步骤:</h2></li>
</ul>
<ol>
<li>声明native方法 : 在Java代码中声明 native method()方法;</li>
<li>实现JNI的C/C++方法 : 在JNI层实现Java中声明的native方法, 这里使用javah工具生成带方法签名的头文件, 该JNI层的C/C++代码将被编译成动态库;</li>
<li>加载动态库 : 在Java代码中的静态代码块中加载JNI编译后的动态共享库;</li>
</ol>
<h1 id="Android中的应用程序框架"><a href="#Android中的应用程序框架" class="headerlink" title="Android中的应用程序框架"></a>Android中的应用程序框架</h1><h2 id="正常情况下的Android框架"><a href="#正常情况下的Android框架" class="headerlink" title="正常情况下的Android框架"></a>正常情况下的Android框架</h2><p>最顶层是Android的应用程序代码, 上层的应用层 和 应用框架层 主要是Java代码, 中间有一层的Framework框架层代码是 C/C++代码, 通过Framework进行系统调用, 调用底层的库 和linux 内核;<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo82wjl40oj30fd08xmxm.jpg" alt=""></p>
<h2 id="使用JNI时的Android框架"><a href="#使用JNI时的Android框架" class="headerlink" title="使用JNI时的Android框架"></a>使用JNI时的Android框架</h2><p>绕过Framework提供的调用底层的代码, 直接调用自己写的C代码, 该代码最终会编译成为一个库, 这个库通过JNI提供的一个Stable的ABI 调用linux kernel;ABI是二进制程序接口 application binary interface.<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo82ym8zujj30fe0ait99.jpg" alt=""></p>
<h1 id="JNI详解"><a href="#JNI详解" class="headerlink" title="JNI详解"></a>JNI详解</h1><h2 id="JNIEnv详解"><a href="#JNIEnv详解" class="headerlink" title="JNIEnv详解"></a>JNIEnv详解</h2><ul>
<li>JNIEnv作用 : JNIEnv 是一个指针,指向了一组JNI函数, 这些函数可以在jni.h中查询到,通过这些函数可以实现 Java层 与 JNI层的交互 , 通过JNIEnv 调用JNI函数 可以访问java虚拟机, 操作java对象;<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo83l5gywfj30fb0b7myf.jpg" alt=""></li>
<li><p>JNI线程相关性 : JNIEnv只在当前的线程有效,JNIEnv不能跨线程传递, 相同的Java线程调用本地方法, 所使用的JNIEnv是相同的, 一个Native方法不能被不同的Java线程调用;</p>
</li>
<li><p>JNIEnv结构体系 : JNIEnv指针指向一个线程相关的结构,线程相关结构指向一个指针数组,指针数组中的每个元素最终指向一个JNI函数.</p>
<h3 id="JNIEnv的C-C-声明"><a href="#JNIEnv的C-C-声明" class="headerlink" title="JNIEnv的C/C++声明"></a>JNIEnv的C/C++声明</h3><p><strong>jni.h中声明JNIEnv</strong>:C语言中定义的JNIEnv 是 JNINativeInterface* , C++中定义的JNIEnv 是 _JNIEnv;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">JNIEnv</span>;</span>  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">JavaVM</span>;</span>  </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">C_JNIEnv</span>;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cplusplus)    <span class="comment">//为了兼容C 和 C++两种代码 使用该 宏加以区分  </span></span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv;     <span class="comment">//C++ 中的JNIEnv类型  </span></span><br><span class="line"><span class="keyword">typedef</span> _JavaVM JavaVM;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">JNIEnv</span>;</span><span class="comment">//C语言中的JNIEnv类型  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface</span>* <span class="title">JavaVM</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="C语言中的JNIEnv"><a href="#C语言中的JNIEnv" class="headerlink" title="C语言中的JNIEnv"></a>C语言中的JNIEnv</h3><p>关于JNIEnv指针调用解析 : C中JNIEnv就是 <code>const struct JNINativeInterface*</code>, <code>JNIEnv * env</code> 等价于 <code>JNINativeInterface** env</code>, 因此要得到JNINativeInterface结构体中定义的函数指针, 就必须先获取到 JNINativeInterface的一级指针对象 即 <em>env , 该一级指针对象就是 `JNINativeInterface</em> <code>, 然后通过该一级指针对象调用JNI函数 :</code>(*env)-&gt;NewStringUTF(env, “hello”)`;<br>在JNINativeInterface结构体中定义了一系列的关于Java操作的相关方法 :<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Table of interface function pointers. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">void</span>*       reserved0;  </span><br><span class="line">    <span class="keyword">void</span>*       reserved1;  </span><br><span class="line">      </span><br><span class="line">    ... ...  </span><br><span class="line">      </span><br><span class="line">    jboolean    (*CallStaticBooleanMethodV)(JNIEnv*, jclass, jmethodID,  </span><br><span class="line">                        va_list);  </span><br><span class="line">    jboolean    (*CallStaticBooleanMethodA)(JNIEnv*, jclass, jmethodID,  </span><br><span class="line">                        jvalue*);  </span><br><span class="line">    jbyte       (*CallStaticByteMethod)(JNIEnv*, jclass, jmethodID, ...);  </span><br><span class="line">    jbyte       (*CallStaticByteMethodV)(JNIEnv*, jclass, jmethodID, va_list);  </span><br><span class="line">      </span><br><span class="line">    ... ...  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">void</span>*       (*GetDirectBufferAddress)(JNIEnv*, jobject);  </span><br><span class="line">    jlong       (*GetDirectBufferCapacity)(JNIEnv*, jobject);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* added in JNI 1.6 */</span>  </span><br><span class="line">    jobjectRefType (*GetObjectRefType)(JNIEnv*, jobject);  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="C-中的JNIEnv"><a href="#C-中的JNIEnv" class="headerlink" title="C++中的JNIEnv"></a>C++中的JNIEnv</h3><p>C++ 中的JNIEnv: C++ 中的JNIEnv 就是 _JNIEnv 结构体, 二者是等同的; 因此在调用 JNI函数的时候, 只需要使用 env-&gt;NewStringUTF(env, “hello”)方法即可, 不用在进行*运算;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * C++ object wrapper. </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This is usually overlaid on a C struct whose first element is a </span></span><br><span class="line"><span class="comment"> * JNINativeInterface*.  We rely somewhat on compiler behavior. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">JNIEnv</span> &#123;</span>  </span><br><span class="line">    <span class="comment">/* do not rename this; it does not seem to be entirely opaque */</span>  </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">functions</span>;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cplusplus)  </span></span><br><span class="line">  </span><br><span class="line">    <span class="function">jint <span class="title">GetVersion</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;GetVersion(<span class="keyword">this</span>); &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function">jlong <span class="title">GetDirectBufferCapacity</span><span class="params">(jobject buf)</span>  </span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;GetDirectBufferCapacity(<span class="keyword">this</span>, buf); &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* added in JNI 1.6 */</span>  </span><br><span class="line">    <span class="function">jobjectRefType <span class="title">GetObjectRefType</span><span class="params">(jobject obj)</span>  </span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;GetObjectRefType(<span class="keyword">this</span>, obj); &#125;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/*__cplusplus*/</span>  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="JNI方法命名规则-标准JNI规范"><a href="#JNI方法命名规则-标准JNI规范" class="headerlink" title="JNI方法命名规则(标准JNI规范)"></a>JNI方法命名规则(标准JNI规范)</h2><p>JNI实现的方法 与 Java中Native方法的映射关系 : 使用方法名进行映射,可以使用 javah 工具进入 bin/classes 目录下执行命令, 即可生成头文件;<br>例如<br>java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jni.demo;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNIDemo</span> </span>&#123;</span><br><span class="line">	<span class="comment">//定义一个本地方法</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		<span class="comment">//调用动态链接库</span></span><br><span class="line">		System.loadLibrary(<span class="string">"JNIDemo"</span>);</span><br><span class="line">		JNIDemo jniDemo = <span class="keyword">new</span> JNIDemo();</span><br><span class="line">		jniDemo.sayHello();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>c++<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"com_jni_demo_JNIDemo.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_jni_demo_JNIDemo_sayHello</span> <span class="params">(JNIEnv * env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;<span class="string">"Hello World"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JNI方法参数介绍: </p>
<ul>
<li>参数① : 第一个参数是JNI接口指针 JNIEnv;</li>
<li>参数② : 如果Native方法是非静态的, 那么第二个参数就是对Java对象的引用, 如果Native方法是静态的, 那么第二个参数就是对Java类的Class对象的引用;</li>
</ul>
<p>JNI方法名规范 : 返回值 + Java前缀 + 全路径类名 + 方法名 + 参数① JNIEnv + 参数② jobject + 其它参数;<br><em>注意分隔符 : Java前缀 与 类名 以及类名之间的包名 和 方法名之间 使用 “_” 进行分割;</em></p>
<p>声明<strong>非静态</strong>方法: </p>
<ul>
<li>Native方法 : public int hello (String str, int i); </li>
<li>JNI方法: jint Java_shuliang_han_Hello_hello(JNIEnv * env, jobject obj, jstring str, jint i);</li>
</ul>
<p>声明<strong>静态</strong>方法 : </p>
<ul>
<li>Native方法 : public static int hello (String str, int i); </li>
<li>JNI方法 : jint Java_shuliang_han_Hello_hello(JNIEnv * env, jobject clazz, jstring str, jint i);</li>
</ul>
<p>两种规范 : 以上是Java的标准JNI规范, 在Android中还有一套自定义的规范, 该规范是Android应用框架层 和 框架层交互使用的JNI规范, 依靠方法注册 映射 Native方法 和 JNI方法;</p>
<h2 id="JNI方法签名规则"><a href="#JNI方法签名规则" class="headerlink" title="JNI方法签名规则"></a>JNI方法签名规则</h2><p>JNI识别Java方法 : JNI依靠函数名 和 方法签名 识别方法, 函数名是不能唯一识别一个方法的, 因为方法可以重载, 类型签名代表了 参数 和 返回值;</p>
<ul>
<li><p>签名规则 : (参数1类型签名 参数2类型签名 参数3类型签名 参数N类型签名…) 返回值类型签名<br><strong>注意参数列表中没有任何间隔</strong>;</p>
</li>
<li><p>Java类型 与 类型签名对照表 : 注意 boolean 与 long 不是大写首字母, 分别是 Z 与 J,  类是L全限定类名, 数组是[元素类型签名;</p>
</li>
<li>类的签名规则 :L + 全限定名 + ;三部分, 全限定类名以 / 分割;</li>
</ul>
<p>Java类型    类型签名<br>boolean Z<br>byte    B<br>char    C<br>short    S<br>int    I<br>long    J<br>float    F<br>double    D<br>类    L全限定类名;<br>数组    [元素类型签名<br>eg. long function(int n, String str, int[] arr);<br>该方法的签名 :(ILjava/lang/String;[I)J</p>
<p>方法签名介绍 :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloFromJava</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">"hello from java"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">//C调用java中的带两个int参数的方法  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Add</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> x + y;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">//C调用java中参数为string的方法  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printString</span><span class="params">(String s)</span></span>&#123;  </span><br><span class="line">        System.out.println(s);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>返回值null, 参数null : void helloFromJava() 方法的签名是 “()V”, 括号里什么都没有代表参数为null, V代表返回值是void;</li>
<li>返回值int, 参数两个int : int Add(int x,int y) 方法的签名是 “(II)I”, 括号中II表示两个int类型参数, 右边括号外的I代表返回值是int类型;</li>
<li>返回值null, 参数String : void printString(String s) 方法签名是 “(Ljava/lang/String;)V”, 括号中的Ljava/lang/String; 表示参数是String类型, V表示返回值是void;</li>
</ul>
<h2 id="Java中调用JNI"><a href="#Java中调用JNI" class="headerlink" title="Java中调用JNI"></a>Java中调用JNI</h2><h3 id="JNI数据类型"><a href="#JNI数据类型" class="headerlink" title="JNI数据类型"></a>JNI数据类型</h3><p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo89hw3cstj30pw0cewfe.jpg" alt=""><br>数据类型表示方法 : int数组类型 jintArray , boolean数组 jbooleanArray …<br>头文件定义类型 : 这些基本的数据类型在<a href="https://android.googlesource.com/platform/libnativehelper/+/brillo-m9-dev/include/nativehelper/jni.h" target="_blank" rel="noopener">jni.h</a> 中都有相应的定义 :<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Primitive types that match up with Java equivalents. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint8_t</span>  jboolean; <span class="comment">/* unsigned 8 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int8_t</span>   jbyte;    <span class="comment">/* signed 8 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint16_t</span> jchar;    <span class="comment">/* unsigned 16 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int16_t</span>  jshort;   <span class="comment">/* signed 16 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int32_t</span>  jint;     <span class="comment">/* signed 32 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int64_t</span>  jlong;    <span class="comment">/* signed 64 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">float</span>    jfloat;   <span class="comment">/* 32-bit IEEE 754 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span>   jdouble;  <span class="comment">/* 64-bit IEEE 754 */</span></span><br><span class="line"><span class="comment">/* "cardinal indices and sizes" */</span></span><br><span class="line"><span class="keyword">typedef</span> jint     jsize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Reference types, in C++</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jobject</span> &#123;</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jclass</span> :</span> <span class="keyword">public</span> _jobject &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jstring</span> :</span> <span class="keyword">public</span> _jobject &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jarray</span> :</span> <span class="keyword">public</span> _jobject &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jobjectArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jbooleanArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jbyteArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jcharArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jshortArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jintArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jlongArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jfloatArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jdoubleArray</span> :</span> <span class="keyword">public</span> _jarray &#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> _<span class="title">jthrowable</span> :</span> <span class="keyword">public</span> _jobject &#123;&#125;;</span><br><span class="line"><span class="keyword">typedef</span> _jobject*       jobject;</span><br><span class="line"><span class="keyword">typedef</span> _jclass*        jclass;</span><br><span class="line"><span class="keyword">typedef</span> _jstring*       jstring;</span><br><span class="line"><span class="keyword">typedef</span> _jarray*        jarray;</span><br><span class="line"><span class="keyword">typedef</span> _jobjectArray*  jobjectArray;</span><br><span class="line"><span class="keyword">typedef</span> _jbooleanArray* jbooleanArray;</span><br><span class="line"><span class="keyword">typedef</span> _jbyteArray*    jbyteArray;</span><br><span class="line"><span class="keyword">typedef</span> _jcharArray*    jcharArray;</span><br><span class="line"><span class="keyword">typedef</span> _jshortArray*   jshortArray;</span><br><span class="line"><span class="keyword">typedef</span> _jintArray*     jintArray;</span><br><span class="line"><span class="keyword">typedef</span> _jlongArray*    jlongArray;</span><br><span class="line"><span class="keyword">typedef</span> _jfloatArray*   jfloatArray;</span><br><span class="line"><span class="keyword">typedef</span> _jdoubleArray*  jdoubleArray;</span><br><span class="line"><span class="keyword">typedef</span> _jthrowable*    jthrowable;</span><br><span class="line"><span class="keyword">typedef</span> _jobject*       jweak;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* not __cplusplus */</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Reference types, in C.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>*           jobject;</span><br><span class="line"><span class="keyword">typedef</span> jobject         jclass;</span><br><span class="line"><span class="keyword">typedef</span> jobject         jstring;</span><br><span class="line"><span class="keyword">typedef</span> jobject         jarray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jobjectArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jbooleanArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jbyteArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jcharArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jshortArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jintArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jlongArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jfloatArray;</span><br><span class="line"><span class="keyword">typedef</span> jarray          jdoubleArray;</span><br><span class="line"><span class="keyword">typedef</span> jobject         jthrowable;</span><br><span class="line"><span class="keyword">typedef</span> jobject         jweak;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* not __cplusplus */</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">jfieldID</span>;</span>                       <span class="comment">/* opaque structure */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">jfieldID</span>* <span class="title">jfieldID</span>;</span>     <span class="comment">/* field IDs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">jmethodID</span>;</span>                      <span class="comment">/* opaque structure */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">jmethodID</span>* <span class="title">jmethodID</span>;</span>   <span class="comment">/* method IDs */</span></span><br></pre></td></tr></table></figure></p>
<h3 id="JNI在Java和C语言之间传递int类型"><a href="#JNI在Java和C语言之间传递int类型" class="headerlink" title="JNI在Java和C语言之间传递int类型"></a>JNI在Java和C语言之间传递int类型</h3><p>Java中定义的方法 :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将Java中的两个int值 传给C语言, 进行相加后, 返回java语言</span></span><br><span class="line"><span class="comment">//shuliang.han.ndkparameterpassing.DataProvider  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>java中调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> R.id.add:  </span><br><span class="line">    <span class="keyword">int</span> result = dataProvider.add(<span class="number">1</span>, <span class="number">2</span>);  </span><br><span class="line">    Toast.makeText(getApplicationContext(), <span class="string">"the add result : "</span> + result, Toast.LENGTH_LONG).show();  </span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>C语言中定义的方法 :<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;  </span></span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//方法签名, Java环境 和 调用native方法的类 必不可少, 后面的参数就是native方法的参数  </span></span><br><span class="line"><span class="function">jint <span class="title">Java_shuliang_han_ndkparameterpassing_DataProvider_add</span><span class="params">(JNIEnv * env, jobject obj, jint x, jint y)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> x + y;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="数组参数处理"><a href="#数组参数处理" class="headerlink" title="数组参数处理"></a>数组参数处理</h3><ul>
<li>获取数组长度方法 : jni中定义 - <code>jsize (*GetArrayLength)(JNIEnv*, jarray)</code>;</li>
<li><p>创建数组的相关方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jbooleanArray (*NewBooleanArray)(JNIEnv*, jsize);    </span><br><span class="line">jbyteArray    (*NewByteArray)(JNIEnv*, jsize);    </span><br><span class="line">jcharArray    (*NewCharArray)(JNIEnv*, jsize);    </span><br><span class="line">jshortArray   (*NewShortArray)(JNIEnv*, jsize);    </span><br><span class="line">jintArray     (*NewIntArray)(JNIEnv*, jsize);    </span><br><span class="line">jlongArray    (*NewLongArray)(JNIEnv*, jsize);    </span><br><span class="line">jfloatArray   (*NewFloatArray)(JNIEnv*, jsize);    </span><br><span class="line">jdoubleArray  (*NewDoubleArray)(JNIEnv*, jsize);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数组元素相关方法 : </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jboolean*   (*GetBooleanArrayElements)(JNIEnv*, jbooleanArray, jboolean*);    </span><br><span class="line">jbyte*      (*GetByteArrayElements)(JNIEnv*, jbyteArray, jboolean*);    </span><br><span class="line">jchar*      (*GetCharArrayElements)(JNIEnv*, jcharArray, jboolean*);    </span><br><span class="line">jshort*     (*GetShortArrayElements)(JNIEnv*, jshortArray, jboolean*);    </span><br><span class="line">jint*       (*GetIntArrayElements)(JNIEnv*, jintArray, jboolean*);    </span><br><span class="line">jlong*      (*GetLongArrayElements)(JNIEnv*, jlongArray, jboolean*);    </span><br><span class="line">jfloat*     (*GetFloatArrayElements)(JNIEnv*, jfloatArray, jboolean*);    </span><br><span class="line">jdouble*    (*GetDoubleArrayElements)(JNIEnv*, jdoubleArray, jboolean*);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>example</strong><br>c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jintArray <span class="title">Java_shuliang_han_ndkparameterpassing_DataProvider_intMethod</span><span class="params">(JNIEnv *env, jobject obj, jintArray arr)</span>    </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="comment">//获取arr大小    </span></span><br><span class="line">    <span class="keyword">int</span> len = (*env)-&gt;GetArrayLength(env, arr);    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">//在LogCat中打印出arr的大小    </span></span><br><span class="line">    LOGI(<span class="string">"the length of array is %d"</span>, len);    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">//如果长度为0, 返回arr    </span></span><br><span class="line">    <span class="keyword">if</span>(len == <span class="number">0</span>)    </span><br><span class="line">        <span class="keyword">return</span> arr;    </span><br><span class="line">            </span><br><span class="line">    <span class="comment">//如果长度大于0, 那么获取数组中的每个元素    </span></span><br><span class="line">    jint* p = (*env)-&gt;GetIntArrayElements(env, arr, <span class="number">0</span>);    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">//打印出数组中每个元素的值    </span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;    </span><br><span class="line">    <span class="keyword">for</span>(; i &lt; len; i ++)    </span><br><span class="line">    &#123;    </span><br><span class="line">        LOGI(<span class="string">"arr[%d] = %d"</span>, i, *(p + i));    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> arr;    </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> R.id.intMethod:    </span><br><span class="line">    <span class="keyword">int</span>[] array = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;    </span><br><span class="line">    dataProvider.intMethod(array);    </span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="C代码回调Java方法或者使用java类的字段"><a href="#C代码回调Java方法或者使用java类的字段" class="headerlink" title="C代码回调Java方法或者使用java类的字段"></a>C代码回调Java方法或者使用java类的字段</h2><p>C语言回调Java方法场景 : </p>
<ul>
<li>复用方法 : 使用Java对象, 复用Java中的方法;</li>
<li>激活Java : C程序后台运行, 该后台程序一直运行, 某个时间出发后需要启动Java服务, 激活Android中的某个界面, 例如使用Intent启动一个Activity;</li>
</ul>
<h3 id="1-找到java对应的Class"><a href="#1-找到java对应的Class" class="headerlink" title="1 找到java对应的Class"></a>1 找到java对应的Class</h3><p>为了能够在C/C++中使用Java类，jni.h头文件中专门定义了jclass类型来表示Java中的Class类<br>JNIEnv类中有如下几个简单的函数可以取得jclass:</p>
<ul>
<li><p><code>jclass FindClass(const char* clsName)</code>:通过类的名称(类的全名，这时候包名不是用.号，而是用/来区分的)来获取jclass<br>如: <code>jclass str = env-&gt;FindClass(“java/lang/String”)</code>;获取Java中的String对象的class对象。</p>
</li>
<li><p><code>jclass GetObjectClass(jobject obj)</code>:通过对象实例来获取jclass，相当于java中的getClass方法</p>
</li>
<li><p><code>jclass GetSuperClass(jclass obj)</code>:通过jclass可以获取其父类的jclass对象</p>
</li>
</ul>
<p><em>在C/C++本地代码中访问Java端的代码，一个常见的应用就是获取类的属性和调用类的方法，为了在C/C++中表示属性和方法，JNI在jni.h头文件中定义了jfieldId,jmethodID类型来分别代表Java端的属性和方法</em></p>
<h3 id="2-1-找到要使用的java字段的fieledID和使用"><a href="#2-1-找到要使用的java字段的fieledID和使用" class="headerlink" title="2.1 找到要使用的java字段的fieledID和使用"></a>2.1 找到要使用的java字段的fieledID和使用</h3><p>使用JNIEnv的：<br>GetFieldID/GetMethodID<br>GetStaticFieldID/GetStaticMethodID<br>来取得相应的jfieldID和jmethodID</p>
<p>下面来具体看一下这几个方法：</p>
<p><code>GetFieldID(jclass clazz,const char* name,const char* sign)</code></p>
<p>方法的参数说明:</p>
<p>clazz:这个简单就是这个字段依赖的类对象的class对象</p>
<p>name:这个是这个字段的名称</p>
<p>sign:这个是这个字段的签名(我们知道每个变量，每个方法都是有签名的)</p>
<p><strong>例子：在Java代码中定义一个属性，然后再C++代码中将其设置成另外的值，并且输出来</strong><br>java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jni.demo;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNIDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number = <span class="number">0</span>;<span class="comment">//定义一个属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个本地方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//调用动态链接库</span></span><br><span class="line">        System.loadLibrary(<span class="string">"JNIDemo"</span>);</span><br><span class="line">        JNIDemo jniDemo = <span class="keyword">new</span> JNIDemo();</span><br><span class="line">        jniDemo.sayHello();</span><br><span class="line">        System.out.print(jniDemo.number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>c++<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"com_jni_demo_JNIDemo.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_jni_demo_JNIDemo_sayHello</span> <span class="params">(JNIEnv * env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取obj中对象的class对象</span></span><br><span class="line">    jclass clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">    <span class="comment">//获取Java中的number字段的id(最后一个参数是number的签名)</span></span><br><span class="line">    jfieldID id_number = env-&gt;GetFieldID(clazz,<span class="string">"number"</span>,<span class="string">"I"</span>);</span><br><span class="line">    <span class="comment">//获取number的值</span></span><br><span class="line">    jint number = env-&gt;GetIntField(obj,id_number);</span><br><span class="line">    <span class="comment">//输出到控制台</span></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;number&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">//修改number的值为100,这里要注意的是jint对应C++是long类型,所以后面要加一个L</span></span><br><span class="line">    env-&gt;SetIntField(obj,id_number,<span class="number">100L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-找到要调用的方法的methodID"><a href="#2-2-找到要调用的方法的methodID" class="headerlink" title="2.2 找到要调用的方法的methodID"></a>2.2 找到要调用的方法的methodID</h3><p><code>GetMethodID(jclass clazz,const char* name,const char* sign)</code></p>
<p>方法的参数说明:</p>
<p>clazz:这个简单就是这个方法依赖的类对象的class对象</p>
<p>name:这个是这个方法的名称</p>
<p>sign:这个是这个方法的签名(我们知道每个变量，每个方法都是有签名的)</p>
<h3 id="3-在C语言中调用相应方法"><a href="#3-在C语言中调用相应方法" class="headerlink" title="3 在C语言中调用相应方法"></a>3 在C语言中调用相应方法</h3><p>JNIEnv提供了众多的Call<type>Method和CallStatic<type>Method，还有CallNonvirtual<type>Method函数， 需要通过GetMethodID取得相应方法的jmethodID来传入到上述函数的参数中</type></type></type></p>
<p>调用示例方法的三种形式:</p>
<ul>
<li><p>Call<type>Method(jobject obj,jmethodID id,….);第一种是最常用的方式</type></p>
</li>
<li><p>Call<type>Method(jobject obj,jmethodID id,va_list lst);第二种是当调用这个函数的时候有一个指向参数表的va_list变量时使用的(很少使用)</type></p>
</li>
<li><p>Call<type>Method(jobject obj,jmethodID id,jvalue* v);第三种是当调用这个函数的时候有一个指向jvalue或jvalue数组的指针时用的<br>jvalue在jni.h头文件中定义是一个union联合体，在C/C++中，我们知道union是可以存放不同类型的值，但是当你给其中一个类型赋值之后，这个union就是这种类型了，比如你给jvalue中的s赋值的话， jvalue就变成了jshort类型了，所以我们可以定义一个jvalue数组(这样就可以包含多种类型的参数了)传递到方法中。<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo8b17xs19j305r05bwfa.jpg" alt=""></type></p>
</li>
</ul>
<p>假如现在Java中有这样的一个方法:</p>
<p>boolean function(int a,double b,char c)</p>
<p>{</p>
<p>……..</p>
<p>}<br>(1) 在C++中使用第一种方式调用function方法:</p>
<p><code>env-&gt;CallBooleanMethod(obj , id_function , 10L, 3.4 , L’a’)</code></p>
<p>id_function是方法function的id;可以通过GetMethodID()方法获取</p>
<p>然后就是对应的参数，这个和Java中的可变参数类似，对于最后一个char类型的参数L’a’,为什么前面要加一个L,原因是Java中的字符时Unicode双字节的，而C++中的字符时单字节的，所以要变成宽字符，前面加一个L</p>
<p>(2) 在C++中使用第三种方式调用function方法:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jvalue* args = <span class="keyword">new</span> jvalue[<span class="number">3</span>];<span class="comment">//定义jvalue数组</span></span><br><span class="line"></span><br><span class="line">args[<span class="number">0</span>].i = <span class="number">10L</span>;<span class="comment">//i是jvalue中的jint值</span></span><br><span class="line"></span><br><span class="line">args[<span class="number">1</span>].d = <span class="number">3.44</span>;</span><br><span class="line"></span><br><span class="line">args[<span class="number">2</span>].c = L’a’;</span><br><span class="line"></span><br><span class="line">env-&gt;CallBooleanMethod(obj, id_function, args);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span>[] args;<span class="comment">//释放指针堆内存</span></span><br></pre></td></tr></table></figure></p>
<p><strong>例子:C++中调用Java中的方法:</strong></p>
<p>Java代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">max</span><span class="params">(<span class="keyword">double</span> value1,<span class="keyword">double</span> value2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value1&gt;value2 ? value1:value2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在C++中的代码:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_jni_demo_JNIDemo_sayHello</span> <span class="params">(JNIEnv * env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取obj中对象的class对象</span></span><br><span class="line">    jclass clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">    <span class="comment">//获取Java中的max方法的id(最后一个参数是max方法的签名)</span></span><br><span class="line">    jmethodID id_max = env-&gt;GetMethodID(clazz,<span class="string">"max"</span>,<span class="string">"(DD)D"</span>);</span><br><span class="line">    <span class="comment">//调用max方法</span></span><br><span class="line">    jdouble doubles = env-&gt;CallDoubleMethod(obj,id_max,<span class="number">1.2</span>,<span class="number">3.4</span>);</span><br><span class="line">    <span class="comment">//输出返回值</span></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;doubles&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://github.com/eternalsakura/ctf_pwn/tree/master/android逆向/Log日志分析源码" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/tree/master/android逆向/Log日志分析源码</a><br><a href="http://blog.csdn.net/shulianghan/article/details/18964835" target="_blank" rel="noopener">http://blog.csdn.net/shulianghan/article/details/18964835</a><br><a href="http://www.wjdiankong.cn/java中jni的使用详解第一篇helloworld/" target="_blank" rel="noopener">http://www.wjdiankong.cn/java中jni的使用详解第一篇helloworld/</a><br><a href="http://www.wjdiankong.cn/java中jni的使用详解第二篇jnienv类型和jobject类型的解释/" target="_blank" rel="noopener">http://www.wjdiankong.cn/java中jni的使用详解第二篇jnienv类型和jobject类型的解释/</a><br><a href="http://www.wjdiankong.cn/java中jni的使用详解第三篇jnienv类型中方法的使用/" target="_blank" rel="noopener">http://www.wjdiankong.cn/java中jni的使用详解第三篇jnienv类型中方法的使用/</a><br><a href="https://android.googlesource.com/platform/libnativehelper/+/brillo-m9-dev/include/nativehelper/jni.h" target="_blank" rel="noopener">https://android.googlesource.com/platform/libnativehelper/+/brillo-m9-dev/include/nativehelper/jni.h</a><br><a href="https://github.com/han1202012/NDKParameterPassing" target="_blank" rel="noopener">https://github.com/han1202012/NDKParameterPassing</a><br><a href="https://github.com/han1202012/NDK_Callback/blob/master/jni/jni.c" target="_blank" rel="noopener">https://github.com/han1202012/NDK_Callback/blob/master/jni/jni.c</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/07/mobicrackNDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/mobicrackNDK/" itemprop="url">福建海峡两岸CTF 2015:一个APK，逆向试试吧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T16:59:18+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index">
                    <span itemprop="name">CTF</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/android-reverse/" itemprop="url" rel="index">
                    <span itemprop="name">android reverse</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="考察知识点"><a href="#考察知识点" class="headerlink" title="考察知识点"></a>考察知识点</h2><p>JNI_Onload 中通过 RegisterNatives 动态注册 jni 函数<br>.init_array</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p><a href="http://eternalsakura13.com/2018/02/08/jni2/">http://eternalsakura13.com/2018/02/08/jni2/</a><br><a href="http://eternalsakura13.com/2018/02/08/jnienv/">http://eternalsakura13.com/2018/02/08/jnienv/</a></p>
<h2 id="赛题链接"><a href="#赛题链接" class="headerlink" title="赛题链接"></a>赛题链接</h2><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/android逆向/mobicrackNDK.apk" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/blob/master/android逆向/mobicrackNDK.apk</a></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>看一下apk是什么样的。<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa3sg083lj30ui0pqafd.jpg" alt=""><br>用jadx反编译，然后导出android工程，用as打开<br>查看AndroidManifest.xml<br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1foa3opf5wyj31kw0mrjxj.jpg" alt=""><br>在java代码中定位<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa3tr1sg0j316e184dop.jpg" alt=""><br>可以看出，调用了一个native方法testFlag，将输入的flag字符串传入testFlag进行验证，验证成功则弹出输入的字符串，否则就wrong answer。<br>用IDA打开so文件查看。<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa3yorrawj30x80a2goo.jpg" alt=""><br>发现没有testFlag对应的c函数，怀疑是动态注册<br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1foa3zvvj7wj30kw1e8go4.jpg" alt=""><br>找到JNI_Onload()<br><img src="https://ws4.sinaimg.cn/large/006tNc79ly1foa4r4w73ej31kw0w3n8a.jpg" alt=""><br>用y把参数都改改<br>首先,JNI_Onload()的参数是JavaVM *vm<br>再看GetEnv，它的第一个参数是JavaVM,然后第二个参数就是用来存得到的env指针<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line"> jint (*GetEnv)(JavaVM*, <span class="keyword">void</span>**, jint);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">JavaVM</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface</span>* <span class="title">functions</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    ...</span><br><span class="line"> <span class="function">jint <span class="title">GetEnv</span><span class="params">(<span class="keyword">void</span>** env, jint version)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;GetEnv(<span class="keyword">this</span>, env, version); &#125;</span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/*__cplusplus*/</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1foa50ueretj31bo06gmym.jpg" alt=""><br>所以我们把v7修改为env。<br>v2=env,所以v2也是<code>JNIEnv *</code>类型。<br>再看v4，v4是FindClass的返回值,类型是jclass<br><code>jclass (*FindClass)(JNIEnv*, const char*);</code><br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1foa576k6dxj31go0e878u.jpg" alt=""><br>这样修改后我们的反编译代码就好看多了，这种技巧非常有用，除非你已经很熟练了，否则这样多改改最好。(改类型按y，改名字按n)<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa5e7e2nkj31kw0ttgu5.jpg" alt=""><br>这样我们就找到了函数映射表。<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa5glaz6yj31c60b4gps.jpg" alt=""><br>很显然abcdefghijklmn就是testFlag的native实现，双击切过去重命名为Java_com_testFlag。<br>具体的验证算法就在这里。</p>
<h2 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h2><p>像刚刚那样修正一下参数类型。<br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1foa6avmsj0j31e21ayto9.jpg" alt=""></p>
<h3 id="前8位校验"><a href="#前8位校验" class="headerlink" title="前8位校验"></a>前8位校验</h3><p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1foa6bc72wjj318o0bon08.jpg" alt=""><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">	s2[i] = input[i] - i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将s2和seed比较，seed的内容是<img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa6cnh3zij30dw01qweh.jpg" alt=""></p>
<h3 id="后8位校验"><a href="#后8位校验" class="headerlink" title="后8位校验"></a>后8位校验</h3><p>首先调用了java层的calcKey方法，计算得到一个key<br>Calc.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mobicrackndk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Calc</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">calcKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        key = <span class="keyword">new</span> StringBuffer(<span class="string">"c7^WVHZ,"</span>).reverse().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后将后八位处理一下，存入字符串<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">8</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">	s3[i - <span class="number">8</span>] = input[i] - i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1foa6i25zw1j31fq0ncqas.jpg" alt=""></p>
<p>于是写出脚本计算flag<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">seed=<span class="string">'QflMn`fH'</span></span><br><span class="line">key=<span class="string">'c7^WVHZ,'</span>[::<span class="number">-1</span>]</span><br><span class="line">cyphertext=seed+key</span><br><span class="line">plaintext=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    plaintext.append(chr(ord(cyphertext[i])+i))</span><br><span class="line"><span class="keyword">print</span> <span class="string">""</span>.join(c <span class="keyword">for</span> c <span class="keyword">in</span> plaintext)</span><br></pre></td></tr></table></figure></p>
<p>算出QgnPrelO4cRackEr，然而wrong answer.</p>
<h2 id="继续分析"><a href="#继续分析" class="headerlink" title="继续分析"></a>继续分析</h2><p>在JNI_Onload之前执行的只能是<code>.init_array</code>段了。</p>
<h3 id="init-array"><a href="#init-array" class="headerlink" title=".init_array"></a>.init_array</h3><p>根据 linker 源码, section 的执行顺序为 .preinit_array -&gt; .init -&gt; .init_array 。但 so 是不会执行 .preinit_array 的, 可以忽略。</p>
<p>.init_array 是一个函数指针数组。编写代码时在函数声明时加上 <code>__attribute__((constructor))</code> 使之成为共享构造函数，即可使该函数出现在 .init_array section 中。</p>
<p>IDA 动态调试时 ‘ctrl+s’ 查看 section 信息即可定位这两个 setction，特别的，对于 .init_array，可通过搜索 <code>Calling %s @ %p for &#39;%s&#39;</code> 定位。</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1foa7pcpgbpj316i0kmjzb.jpg" alt=""><br><img src="https://ws4.sinaimg.cn/large/006tNc79ly1foa7zei3nuj30yk09g0vj.jpg" alt=""><br>进入<code>__init_my</code>看看<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa7zztvb9j30oi0k8tca.jpg" alt=""><br>确实在这里对seed字符串进行了修改。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">	t[i] = seed[i] - <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">seed = t</span><br></pre></td></tr></table></figure></p>
<p>所以最终我们的reverse脚本是<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">seed = <span class="string">'QflMn`fH'</span></span><br><span class="line">seed = <span class="string">""</span>.join(chr(ord(c) - <span class="number">3</span>) <span class="keyword">for</span> c <span class="keyword">in</span> seed)</span><br><span class="line">key = <span class="string">'c7^WVHZ,'</span>[::<span class="number">-1</span>]</span><br><span class="line">cyphertext = seed + key</span><br><span class="line">plaintext = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    plaintext.append(chr(ord(cyphertext[i]) + i))</span><br><span class="line"><span class="keyword">print</span> <span class="string">""</span>.join(c <span class="keyword">for</span> c <span class="keyword">in</span> plaintext)</span><br></pre></td></tr></table></figure></p>
<p>flag是NdkMobiL4cRackEr<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1foa8f823vbj31kw0whtch.jpg" alt=""></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.zybuluo.com/cxm-2016/note/566623" target="_blank" rel="noopener">https://www.zybuluo.com/cxm-2016/note/566623</a><br><a href="https://github.com/toToCW/CTF-Mobile/blob/master/2015海峡两岸CTF/一个APK，逆向试试吧ndk/WriteUp/2015海峡两岸CTF-一个APK，逆向试试吧.md" target="_blank" rel="noopener">https://github.com/toToCW/CTF-Mobile/blob/master/2015海峡两岸CTF/一个APK，逆向试试吧ndk/WriteUp/2015海峡两岸CTF-一个APK，逆向试试吧.md</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/06/ss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/06/ss/" itemprop="url">shadowsocks配置和优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-06T18:14:17+08:00">
                2018-02-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂项/" itemprop="url" rel="index">
                    <span itemprop="name">杂项</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://teddysun.com/486.html" target="_blank" rel="noopener">https://teddysun.com/486.html</a></p>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -O shadowsocks-all.sh https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks-all.sh</span><br><span class="line">chmod +x shadowsocks-all.sh</span><br><span class="line">./shadowsocks-all.sh 2&gt;&amp;1 | tee shadowsocks-all.log</span><br></pre></td></tr></table></figure>
<h2 id="脚本使用参考我的截图"><a href="#脚本使用参考我的截图" class="headerlink" title="脚本使用参考我的截图"></a>脚本使用参考我的截图</h2><p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo6w9tna4lj31kw0uzniz.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo6waxwx7dj30x20d844c.jpg" alt=""></p>
<p>选shadowsocks-python<br>服务器端口最好设置为443<br>加密方式选aes-256-cfb</p>
<h2 id="配置文件位置和使用"><a href="#配置文件位置和使用" class="headerlink" title="配置文件位置和使用"></a>配置文件位置和使用</h2><p>/etc/shadowsocks-python/config.json</p>
<p>/etc/init.d/shadowsocks-python start | stop | restart | status</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>针对OVZ</p>
<h3 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://sometimesnaive.org/article/linux/bash/tcp_nanqinlang-rinetd#检查-rinetd-bbr-运行状态" target="_blank" rel="noopener">https://sometimesnaive.org/article/linux/bash/tcp_nanqinlang-rinetd#检查-rinetd-bbr-运行状态</a></p>
<h3 id="shell-1"><a href="#shell-1" class="headerlink" title="shell"></a>shell</h3><p>centos7 64位<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/nanqinlang-tcp/tcp_nanqinlang/releases/download/rinetd/tcp_nanqinlang-rinetd-centos.sh</span><br><span class="line">bash tcp_nanqinlang-rinetd-centos.sh</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/05/xposed1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/05/xposed1/" itemprop="url">Xposed hook系统方法实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-05T23:34:26+08:00">
                2018-02-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://eternalsakura13.com/2018/02/04/hook2/">项目构建</a>和<a href="http://eternalsakura13.com/2018/01/19/nexus51/">xposed下载</a>参考我之前的文章。</p>
<h2 id="Hook类的名称进行内部查找方法（findAndHookMethod"><a href="#Hook类的名称进行内部查找方法（findAndHookMethod" class="headerlink" title="Hook类的名称进行内部查找方法（findAndHookMethod)"></a>Hook类的名称进行内部查找方法（findAndHookMethod)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook_method</span><span class="params">(String className, ClassLoader classLoader, String methodName, Object... parameterTypesAndCallback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            XposedHelpers.findAndHookMethod(className, classLoader, methodName, parameterTypesAndCallback);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XposedBridge.log(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="反射找到具体方法"><a href="#反射找到具体方法" class="headerlink" title="反射找到具体方法"></a>反射找到具体方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook_method2</span><span class="params">(String className, String methodName, XC_MethodHook xmh)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="keyword">for</span> (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(methodName)</span><br><span class="line">                        &amp;&amp; !Modifier.isAbstract(method.getModifiers())</span><br><span class="line">                        &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                    XposedBridge.hookMethod(method, xmh);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XposedBridge.log(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="案例测试"><a href="#案例测试" class="headerlink" title="案例测试"></a>案例测试</h2><h3 id="新建一个class，实现xposed"><a href="#新建一个class，实现xposed" class="headerlink" title="新建一个class，实现xposed"></a>新建一个class，实现xposed</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposeddemo;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by sakura on 2018/2/5.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="comment">//第一个参数是Hook的类的名称，第二个参数是类的classloader，第三个参数是Hook的具体方法，第四个参数是Hook之后的回调，一般有before和after</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook_method</span><span class="params">(String className, ClassLoader classLoader, String methodName, Object... parameterTypesAndCallback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            XposedHelpers.findAndHookMethod(className, classLoader, methodName, parameterTypesAndCallback);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XposedBridge.log(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook_method2</span><span class="params">(String className, String methodName, XC_MethodHook xmh)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="keyword">for</span> (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(methodName)</span><br><span class="line">                        &amp;&amp; !Modifier.isAbstract(method.getModifiers())</span><br><span class="line">                        &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                    XposedBridge.hookMethod(method, xmh);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XposedBridge.log(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"sakura"</span>, <span class="string">"pkg:"</span> + lpp.packageName);</span><br><span class="line">        hook_method2(<span class="string">"android.telephony.TelephonyManager"</span>, <span class="string">"getDeviceId"</span>, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.i(<span class="string">"sakura"</span>, <span class="string">"hook getDeviceId..."</span>);</span><br><span class="line">                Object obj = param.getResult();</span><br><span class="line">                Log.i(<span class="string">"sakura"</span>, <span class="string">"imei args:"</span> + obj);</span><br><span class="line">                param.setResult(<span class="string">"sakura"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MainActivity.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposeddemo;</span><br><span class="line"><span class="keyword">import</span> android.Manifest;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.ActivityCompat;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.telephony.TelephonyManager;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TextView imeiTxt;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        imeiTxt = (TextView) findViewById(R.id.imei);</span><br><span class="line">        TelephonyManager telephonyManager = (TelephonyManager) <span class="keyword">this</span>.getSystemService(Context.TELEPHONY_SERVICE);</span><br><span class="line">        <span class="keyword">if</span> (ActivityCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.READ_PHONE_STATE) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Consider calling</span></span><br><span class="line">            <span class="comment">// ActivityCompat#requestPermissions</span></span><br><span class="line">            <span class="comment">// here to request the missing permissions, and then overriding</span></span><br><span class="line">            <span class="comment">// public void onRequestPermissionsResult(int requestCode, String[] permissions,</span></span><br><span class="line">            <span class="comment">// int[] grantResults)</span></span><br><span class="line">            <span class="comment">// to handle the case where the user grants the permission. See the documentation</span></span><br><span class="line">            <span class="comment">// for ActivityCompat#requestPermissions for more details.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String imei = telephonyManager.getDeviceId();</span><br><span class="line">        imeiTxt.setText(<span class="string">"imei:"</span> + imei);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fo5zk72n4uj30u01eon0j.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fo5zmy36l6j30uy1gejv4.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/04/trick2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/04/trick2/" itemprop="url">修改Nexus5的boot.img - 打开系统调试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-04T23:20:43+08:00">
                2018-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用须知"><a href="#使用须知" class="headerlink" title="使用须知"></a>使用须知</h2><h3 id="工具备注："><a href="#工具备注：" class="headerlink" title="工具备注："></a>工具备注：</h3><p>mkbootimg和unpackbootimg可能只能用在linux x86的系统上，那我的linux x64怎么能使用这两个工具，需要下载支持x86程序运行的库。<br>你可以参考这些命令去下载运行库。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y upgrade</span><br><span class="line">sudo apt-get -y install binutils nasm</span><br><span class="line">sudo apt-get -y install gcc-multilib g++-multilib</span><br><span class="line">sudo apt-get -y install libc6-dev-i386</span><br></pre></td></tr></table></figure></p>
<h3 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h3><p>linux上使用，mac和windows均不可以。<br>在ubuntu14.04 64位测试通过。</p>
<h3 id="boot-img"><a href="#boot-img" class="headerlink" title="boot.img"></a>boot.img</h3><p>我编译好了两个版本的，Nexus5手机，<a href="https://github.com/eternalsakura/ctf_pwn/blob/master/boot/newboot4.4.4.img" target="_blank" rel="noopener">android4.4.4</a>和<a href="https://github.com/eternalsakura/ctf_pwn/blob/master/boot/newboot5.0.1.img" target="_blank" rel="noopener">android5.0.1</a>。<br>实体机测试通过，需要自取。</p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>下载<a href="https://github.com/eternalsakura/ctf_pwn/tree/master/boot" target="_blank" rel="noopener">工具包</a>和<a href="https://developers.google.com/android/images" target="_blank" rel="noopener">android源码(根据自己的android版本)</a></p>
<h2 id="解压源码，找到boot-img"><a href="#解压源码，找到boot-img" class="headerlink" title="解压源码，找到boot.img"></a>解压源码，找到boot.img</h2><p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo4r56t97zj30kw04y3zu.jpg" alt=""></p>
<h2 id="将工具包的路径加入环境变量"><a href="#将工具包的路径加入环境变量" class="headerlink" title="将工具包的路径加入环境变量"></a>将工具包的路径加入环境变量</h2><p><code>export PATH=/home/sakura/工具:$PATH</code><br>将上面的/home/sakura/工具替换成你自己的工具包路径。<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4r8oul5kj30mq03xgmn.jpg" alt=""><br>这样工具包里的程序就可以使用了。</p>
<h2 id="boot-img解包"><a href="#boot-img解包" class="headerlink" title="boot.img解包"></a>boot.img解包</h2><p><code>split-bootimg.pl boot.img</code><br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo4rahvjmuj30wt078gns.jpg" alt=""></p>
<h2 id="处理boot-img-ramdisk-gz"><a href="#处理boot-img-ramdisk-gz" class="headerlink" title="处理boot.img-ramdisk.gz"></a>处理boot.img-ramdisk.gz</h2><p>运行下面的命令，对boot.img-ramdisk.gz进行解压：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ramdisk</span><br><span class="line">cd ramdisk</span><br><span class="line">gzip -dc ../boot.img-ramdisk.gz | cpio -i</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4rbe97i7j311j04jq4k.jpg" alt=""></p>
<h2 id="修改default-prop，打开系统调试标志"><a href="#修改default-prop，打开系统调试标志" class="headerlink" title="修改default.prop，打开系统调试标志"></a>修改default.prop，打开系统调试标志</h2><p>找到解压出来的default.prop文件，将其中的ro.debuggable=0修改为ro.debuggable=1<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo4rc3yqj8j30dp0ad3zg.jpg" alt=""></p>
<h2 id="ramdisk目录打包"><a href="#ramdisk目录打包" class="headerlink" title="ramdisk目录打包"></a>ramdisk目录打包</h2><p>返回ramdisk的上层目录<br><code>cd ..</code><br>输入命令：<br><code>mkbootfs ./ramdisk | gzip &gt; ramdisk.img</code><br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo4re3q4kgj30zu02i0tj.jpg" alt=""></p>
<h2 id="打包出新的boot-img"><a href="#打包出新的boot-img" class="headerlink" title="打包出新的boot.img"></a>打包出新的boot.img</h2><p>命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkbootimg --base 0x00000000 --ramdisk_offset 0x02900000 --second_offset 0x00F00000 --tags_offset 0x02700000 --cmdline &apos;console=ttyHSL0 androidboot.hardware=hammerhead user_debug=31 maxcpus=2 msm_watchdog_v2.enable=1 earlyprintk&apos; --kernel boot.img-kernel --ramdisk ramdisk.img -o newboot.img</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4rexfgzkj312c04cmyq.jpg" alt=""></p>
<h2 id="将新的boot-img刷入手机"><a href="#将新的boot-img刷入手机" class="headerlink" title="将新的boot.img刷入手机"></a>将新的boot.img刷入手机</h2><p><code>adb reboot bootloader</code><br><code>fastboot oem unlock</code><br><code>fastboot flash boot newboot.img</code><br><code>fastboot reboot</code><br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4s0nhq7wj30rs0h20yx.jpg" alt=""></p>
<h2 id="确认刷入成功-debuggable修改为1"><a href="#确认刷入成功-debuggable修改为1" class="headerlink" title="确认刷入成功,debuggable修改为1"></a>确认刷入成功,debuggable修改为1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">getprop | grep debuggable</span><br></pre></td></tr></table></figure>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4ssdw7shj30mk02mgmf.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/04/hook2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/04/hook2/" itemprop="url">Xposed项目搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-04T16:04:11+08:00">
                2018-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo4gkfn5i3j30bv0mqmz4.jpg" alt=""></p>
<h2 id="新建一个lib文件夹，然后将api-82-jar复制进去"><a href="#新建一个lib文件夹，然后将api-82-jar复制进去" class="headerlink" title="新建一个lib文件夹，然后将api-82.jar复制进去"></a>新建一个lib文件夹，然后将api-82.jar复制进去</h2><p>新建一个lib文件夹，然后将api-82.jar复制进去<br><a href="https://jcenter.bintray.com/de/robv/android/xposed/api/" target="_blank" rel="noopener">下载链接</a><br>下载如下两个文件：<a href="https://bintray.com/rovo89/de.robv.android.xposed/download_file?file_path=de%2Frobv%2Fandroid%2Fxposed%2Fapi%2F82%2Fapi-82-sources.jar" target="_blank" rel="noopener">api-82-sources.jar</a>和<a href="https://bintray.com/rovo89/de.robv.android.xposed/download_file?file_path=de%2Frobv%2Fandroid%2Fxposed%2Fapi%2F82%2Fapi-82.jar" target="_blank" rel="noopener">api-82.jar</a></p>
<h2 id="在app的build-gradle中将添加如下语句"><a href="#在app的build-gradle中将添加如下语句" class="headerlink" title="在app的build.gradle中将添加如下语句"></a>在app的build.gradle中将添加如下语句</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">provided <span class="title">files</span><span class="params">(<span class="string">'lib/api-82.jar'</span>)</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo4h1qcqnej30nw0gbjuc.jpg" alt=""><br>作用：将libs中的Xposed框架API引用到项目中（构建依赖）</p>
<h2 id="在AndroidManifest-xml将自己标识为一个Xposed模块，语句添加在如下位置"><a href="#在AndroidManifest-xml将自己标识为一个Xposed模块，语句添加在如下位置" class="headerlink" title="在AndroidManifest.xml将自己标识为一个Xposed模块，语句添加在如下位置"></a>在AndroidManifest.xml将自己标识为一个Xposed模块，语句添加在如下位置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name=<span class="string">"xposedmodule"</span></span><br><span class="line">    android:value=<span class="string">"true"</span> /&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=<span class="string">"xposeddescription"</span></span><br><span class="line">    android:value=<span class="string">"我是一个Xposed例程"</span> /&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=<span class="string">"xposedminversion"</span></span><br><span class="line">    android:value=<span class="string">"30"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo4glg5gp9j30gu0estbb.jpg" alt=""><br>作用：</p>
<ul>
<li>xposedmodule：value为true，表示自己是一个xposed模块</li>
<li>xposeddescription：value中的文字就是对模块的描述，这些能够在手机上的Xposed框架中看到</li>
<li>xposedminversion：xposed最低版本</li>
</ul>
<h2 id="在类里编写hook代码"><a href="#在类里编写hook代码" class="headerlink" title="在类里编写hook代码"></a>在类里编写hook代码</h2><p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4el2kqptj30sc0d475m.jpg" alt=""><br>这里我新建了一个HookToast类，但是你可以在MainActivity里写，只要在后面写好xposed模块的入口点就好了。<br>之前在AndroidManifest.xml中标识了我们的项目是一个Xposed模块，可是我们可能会有许多Activity，<br>它怎么才能知道模块的入口在哪呢？<br>所以，下面要告诉Xposed框架，我们的应用中，Xposed模块的入口到底在哪。<br>具体代码不给出，我只是记录一下，应该怎么编辑项目而已。</p>
<h2 id="标注Xposed模块入口"><a href="#标注Xposed模块入口" class="headerlink" title="标注Xposed模块入口"></a>标注Xposed模块入口</h2><p>右键点击 main ， 选择new –&gt; Folder –&gt;Assets Folder，然后确认即可。<br>在assets中new一个file，文件名为xposed_init（文件类型选text），并在其中写上入口类的完整路径（下面是我的类路径，你们填自己的，就是activity中packege后面的包名）<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4eok5zihj31g00w0q96.jpg" alt=""><br>这样，xposed框架就能够读取xposed_init中的信息来找到模块的入口。</p>
<h2 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h2><p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo4h18eaarj30s70ikq62.jpg" alt=""><br>请确保禁用Instant Run（File -&gt; Settings -&gt; Build, Execution, Deployment -&gt; Instant Run），否则您的类不会直接包含在APK中，导致HOOK失败。<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo4h4j6ub3j30ju02waav.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/02/04/hook1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/04/hook1/" itemprop="url">hook native层学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-04T00:50:14+08:00">
                2018-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android逆向/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://github.com/zhengmin1989/TheSevenWeapons/tree/master/LiBieGou" target="_blank" rel="noopener">https://github.com/zhengmin1989/TheSevenWeapons/tree/master/LiBieGou</a><br><a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="noopener">http://man7.org/linux/man-pages/man2/ptrace.2.html</a><br>在阅读之前，最好先看一下我的另一篇文章，关于<a href="http://eternalsakura13.com/2018/02/02/hello-arm/">怎么编译ARM程序</a><br>以及关于<a href="http://eternalsakura13.com/2018/02/01/ptrace/">ptrace的基础知识</a></p>
<h1 id="Playing-with-Ptrace-Android"><a href="#Playing-with-Ptrace-Android" class="headerlink" title="Playing with Ptrace Android"></a>Playing with Ptrace Android</h1><h2 id="示例代码target-c"><a href="#示例代码target-c" class="headerlink" title="示例代码target.c"></a>示例代码target.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sevenWeapons</span><span class="params">(<span class="keyword">int</span> number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* str = <span class="string">"Hello,LiBieGou!"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s %d\n"</span>,str,number);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sevenWeapons(count);</span><br><span class="line">        count++;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="hook程序hook1-c"><a href="#hook程序hook1-c" class="headerlink" title="hook程序hook1.c"></a>hook程序hook1.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getSysCallNo</span><span class="params">(<span class="keyword">int</span> pid, struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> scno = <span class="number">0</span>;</span><br><span class="line">    scno = ptrace(PTRACE_PEEKTEXT, pid, (<span class="keyword">void</span> *)(regs-&gt;ARM_pc - <span class="number">4</span>), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(scno == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scno == <span class="number">0xef000000</span>) &#123;</span><br><span class="line">        scno = regs-&gt;ARM_r7;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((scno &amp; <span class="number">0x0ff00000</span>) != <span class="number">0x0f900000</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        scno &amp;= <span class="number">0x000fffff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scno;    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hookSysCallBefore</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sysCallNo = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);    </span><br><span class="line">    sysCallNo = getSysCallNo(pid, &amp;regs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Before SysCallNo = %d\n"</span>,sysCallNo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sysCallNo == __NR_write)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"__NR_write: %ld %p %ld\n"</span>,regs.ARM_r0,(<span class="keyword">void</span>*)regs.ARM_r1,regs.ARM_r2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hookSysCallAfter</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sysCallNo = <span class="number">0</span>;</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);  </span><br><span class="line">    sysCallNo = getSysCallNo(pid, &amp;regs);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"After SysCallNo = %d\n"</span>,sysCallNo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sysCallNo == __NR_write)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"__NR_write return: %ld\n"</span>,regs.ARM_r0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;pid to be traced&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> != ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Trace process failed:%d.\n"</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        wait(&amp;status); <span class="comment">//wait函数会延迟父进程的执行，直到被调试的进程切换为停止状态或者终止为止.</span></span><br><span class="line">        hookSysCallBefore(pid);</span><br><span class="line">        ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        wait(&amp;status);</span><br><span class="line">        hookSysCallAfter(pid);</span><br><span class="line">        ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PTRACE_SYSCALL<br>使被调试进程继续运行,但是在下一个系统调用的<strong>入口处或出口处</strong>停下,或者是执行完一条指令后停下.<br>例如,调试进程可以监视被调试进程系统调用入口处的参数,接着再使用SYSCALL,监视系统调用的返回值.</li>
</ul>
<p>每当目标程序调用system call前的时候，就会暂停下载。然后我们就可以读取寄存器的值来获取system call的各项信息。然后我们再一次使用ptrace(PTRACE_SYSCALL, pid, NULL, NULL)这个函数就可以让system call在调用完后再一次暂停下来，并获取system call的返回值。</p>
<h2 id="获取system-call编号"><a href="#获取system-call编号" class="headerlink" title="获取system call编号"></a>获取system call编号</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getSysCallNo</span><span class="params">(<span class="keyword">int</span> pid, struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> scno = <span class="number">0</span>;</span><br><span class="line">    scno = ptrace(PTRACE_PEEKTEXT, pid, (<span class="keyword">void</span> *)(regs-&gt;ARM_pc - <span class="number">4</span>), <span class="literal">NULL</span>); <span class="comment">//读出指令</span></span><br><span class="line">    <span class="keyword">if</span>(scno == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scno == <span class="number">0xef000000</span>) &#123; <span class="comment">//如果指令是EABI</span></span><br><span class="line">        scno = regs-&gt;ARM_r7; <span class="comment">//直接从r7从取出调用号</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//如果指令是OABI</span></span><br><span class="line">        <span class="keyword">if</span> ((scno &amp; <span class="number">0x0ff00000</span>) != <span class="number">0x0f900000</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        scno &amp;= <span class="number">0x000fffff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scno;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARM架构上，所有的系统调用都是通过SWI来实现的。并且在ARM 架构中有两个SWI指令，分别针对EABI和OABI：<br>[EABI] 机器码：<br>1110 1111 0000 0000 – SWI 0<br>具体的调用号存放在寄存器r7中.<br>[OABI] 机器码：<br>1101 1111 vvvv vvvv – SWI immed_8<br>调用号进行转换以后得到指令中的立即数。立即数=调用号 | 0x900000<br>既然需要兼容两种方式的调用，我们在代码上就要分开处理。首先要获取SWI指令判断是EABI还是OABI，如果是EABI，可从r7中获取调用号。如果是OABI，则从SWI指令中获取立即数，反向计算出调用号。</p>
<p><strong>OABI和EABI的区别</strong><br>两种ABI在如下方面有区别：<br>A。调用规则（包括参数如何传递及如何获得返回值）<br>B。系统调用的数目以及应用程序应该如何去做系统调用<br>C。目标文件的二进制格式，程序库等<br>D。结构体中的填充（padding/packing）和对齐。</p>
<p>PTRACE_PEEKTEXT, PTRACE_PEEKDATA<br>形式：ptrace(PTRACE_PEEKTEXT, pid, addr, data)<br>         ptrace(PTRACE_PEEKDATA, pid, addr, data)<br>描述：从内存地址中读取一个字节，pid表示被跟踪的子进程，内存地址由addr给出，data为用户变量地址用于返回读到的数据。在Linux（i386）中用户代码段与用户数据段重合所以读取代码段和数据段数据处理是一样的。</p>
<h2 id="hook程序运行逻辑"><a href="#hook程序运行逻辑" class="headerlink" title="hook程序运行逻辑"></a>hook程序运行逻辑</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="number">0</span> != ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Trace process failed:%d.\n"</span>, errno);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    wait(&amp;status); <span class="comment">//wait函数会延迟父进程的执行，直到被调试的进程切换为停止状态或者终止为止.</span></span><br><span class="line">    hookSysCallBefore(pid);</span><br><span class="line">    ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    wait(&amp;status);</span><br><span class="line">    hookSysCallAfter(pid);</span><br><span class="line">    ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被调试进程：被debugger attach  ——<em>被PTRACE_SYSCALL</em>——-&gt;在syscall的入口处停止—<em>被PTRACE_SYSCALL</em>—&gt;在syscall的出口处停止</p>
<p>进行调试的进程：attach要调试的进程——<em>PTRACE_SYSCALL/wait</em>——–&gt;等待被调试进程停止—-&gt;读取调用入口处的参数—<em>PTRACE_SYSCALL/wait</em>—&gt;监视系统调用的返回值</p>
<h2 id="hook-system-call前的函数，和hook-system-call后的函数"><a href="#hook-system-call前的函数，和hook-system-call后的函数" class="headerlink" title="hook system call前的函数，和hook system call后的函数"></a>hook system call前的函数，和hook system call后的函数</h2><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo3a2257haj30gv0eb421.jpg" alt=""><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hookSysCallBefore</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sysCallNo = <span class="number">0</span>;</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);    </span><br><span class="line">    sysCallNo = getSysCallNo(pid, &amp;regs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Before SysCallNo = %d\n"</span>,sysCallNo);</span><br><span class="line">    <span class="keyword">if</span>(sysCallNo == __NR_write)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"__NR_write: %ld %p %ld\n"</span>,regs.ARM_r0,(<span class="keyword">void</span>*)regs.ARM_r1,regs.ARM_r2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hookSysCallAfter</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sysCallNo = <span class="number">0</span>;</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);  </span><br><span class="line">    sysCallNo = getSysCallNo(pid, &amp;regs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"After SysCallNo = %d\n"</span>,sysCallNo);</span><br><span class="line">    <span class="keyword">if</span>(sysCallNo == __NR_write)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"__NR_write return: %ld\n"</span>,regs.ARM_r0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PTRACE_GETREGS<br>形式：ptrace(PTRACE_GETREGS, pid, 0, data)<br>描述：读取寄存器值，pid表示被跟踪的子进程，data为用户变量地址用于返回读到的数据。此功能将读取所有17个基本寄存器的值。</p>
<p>在获取了system call的number以后，我们可以进一步获取个个参数的值.比如说write这个system call。<br>在arm上，如果形参个数少于或等于4，则形参由R0,R1,R2,R3四个寄存器进行传递。<br>若形参个数大于4，大于4的部分必须通过堆栈进行传递。<br>而执行完函数后，函数的返回值会保存在R0这个寄存器里。</p>
<p>我们可以看到第一个SysCallNo是162，也就是sleep函数。第二个SysCallNo是4，也就是write函数，因为printf本质就是调用write这个系统调用来完成的。关于system call number对应的具体system call可以参考我在github上的reference文件夹中的systemcalllist.txt文件，里面有对应的列表。我们的hook1程序还对write的参数做了解析，比如1表示stdout，0xadf020表示字符串的地址，19代表字符串的长度。而返回值19表示write成功写入的长度，也就是字符串的长度。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>ps | grep target<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo39vwc2p1j30f8029jsb.jpg" alt=""><br>得到pid为10797<br>target<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo39xt0twkj30ck07maaa.jpg" alt=""><br>hook<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fo39xigwuuj30ei08kt9r.jpg" alt=""><br>我们可以看到第一个SysCallNo是162，也就是sleep函数。<br>第二个SysCallNo是4，也就是write函数，因为printf本质就是调用write这个系统调用来完成的。<br>关于system call number对应的具体system call<br>可以参考我在github上的reference文件夹中的<a href="https://github.com/zhengmin1989/TheSevenWeapons/blob/master/LiBieGou/reference/systemcalllist.txt" target="_blank" rel="noopener">systemcalllist.txt</a>文件，里面有对应的列表。<br>我们的hook1程序还对write的参数做了解析，比如1表示stdout，0x1459020表示字符串的地址，19代表字符串的长度。而返回值19表示write成功写入的长度，也就是字符串的长度。</p>
<h1 id="利用Ptrace动态修改内存"><a href="#利用Ptrace动态修改内存" class="headerlink" title="利用Ptrace动态修改内存"></a>利用Ptrace动态修改内存</h1><p>仅仅是用ptrace来获取system call的参数和返回值还不能体现出ptrace的强大，下面我们就来演示用ptrace读写内存。我们在hook1.c的基础上继续进行修改，在write被调用之前对要输出string进行翻转操作。<br>我们在hookSysCallBefore()函数中加入modifyString(pid, regs.ARM_r1, regs.ARM_r2)这个函数：</p>
<h2 id="修改内存，转置字符串"><a href="#修改内存，转置字符串" class="headerlink" title="修改内存，转置字符串"></a>修改内存，转置字符串</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hookSysCallBefore</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sysCallNo = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);    </span><br><span class="line">    sysCallNo = getSysCallNo(pid, &amp;regs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Before SysCallNo = %d\n"</span>,sysCallNo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sysCallNo == __NR_write)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"__NR_write: %ld %p %ld\n"</span>,regs.ARM_r0,(<span class="keyword">void</span>*)regs.ARM_r1,regs.ARM_r2);</span><br><span class="line">        modifyString(pid, regs.ARM_r1, regs.ARM_r2); <span class="comment">//r1是要打印的字符串的地址，r2是要打印的字符串的长度</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">modifyString</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">long</span> addr, <span class="keyword">long</span> <span class="built_in">strlen</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* str;</span><br><span class="line">    str = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>((<span class="built_in">strlen</span>+<span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>), <span class="number">1</span>);<span class="comment">//申请一块空间str，存放要被修改的字符串</span></span><br><span class="line">    getdata(pid, addr, str, <span class="built_in">strlen</span>);<span class="comment">//从要打印的字符串的地址读出字符串，将其存入申请的空间str</span></span><br><span class="line">    reverse(str); <span class="comment">//转置字符串</span></span><br><span class="line">    putdata(pid, addr, str, <span class="built_in">strlen</span>);<span class="comment">//将转置后的字符串放入要打印的字符串的地址，实现修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getdata和putdata"><a href="#getdata和putdata" class="headerlink" title="getdata和putdata"></a>getdata和putdata</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getdata</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">char</span> *laddr;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">union</span> u &#123;</span><br><span class="line">            <span class="keyword">long</span> val;</span><br><span class="line">            <span class="keyword">char</span> chars[long_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / long_size;</span><br><span class="line">    laddr = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        data.val = ptrace(PTRACE_PEEKDATA,</span><br><span class="line">                          child, addr + i * <span class="number">4</span>,</span><br><span class="line">                          <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(laddr, data.chars, long_size);</span><br><span class="line">        ++i;</span><br><span class="line">        laddr += long_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % long_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        data.val = ptrace(PTRACE_PEEKDATA,</span><br><span class="line">                          child, addr + i * <span class="number">4</span>,</span><br><span class="line">                          <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(laddr, data.chars, j);</span><br><span class="line">    &#125;</span><br><span class="line">    str[len] = <span class="string">'\0'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *laddr;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">union</span> u &#123;</span><br><span class="line">            <span class="keyword">long</span> val;</span><br><span class="line">            <span class="keyword">char</span> chars[long_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / long_size;</span><br><span class="line">    laddr = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.chars, laddr, long_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, child,</span><br><span class="line">               addr + i * <span class="number">4</span>, data.val);</span><br><span class="line">        ++i;</span><br><span class="line">        laddr += long_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % long_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.chars, laddr, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, child,</span><br><span class="line">               addr + i * <span class="number">4</span>, data.val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getdata()和putdata()分别使用PTRACE_PEEKDATA和PTRACE_POKEDATA对内存进行读写操作。<br>因为ptrace的内存操作一次只能控制4个字节，所以如果修改比较长的内容需要进行多次操作。</p>
<ul>
<li><p>PTRACE_PEEKTEXT, PTRACE_PEEKDATA<br>从内存地址中读取四个字节，内存地址由addr给出。</p>
</li>
<li><p>PTRACE_POKETEXT, PTRACE_POKEDATA<br>往内存地址中写入四个字节。内存地址由addr给出。</p>
</li>
</ul>
<p><strong>tip:</strong>arm里的word是指四个字节<br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo3ak60ksyj30n30b00um.jpg" alt=""><br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo3ajnjluij30l903ojs7.jpg" alt=""></p>
<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo3anfenaqj30db06g3zb.jpg" alt=""><br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fo3an95z3vj306g07sgm2.jpg" alt=""></p>
<h1 id="利用Ptrace动态执行sleep-函数——调用系统so库中的函数"><a href="#利用Ptrace动态执行sleep-函数——调用系统so库中的函数" class="headerlink" title="利用Ptrace动态执行sleep()函数——调用系统so库中的函数"></a>利用Ptrace动态执行sleep()函数——调用系统so库中的函数</h1><p>目标函数是libc.so中的sleep函数.<br>正常情况是每输出一次暂停一秒,现在我们让它暂停10秒</p>
<h2 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h2><p>获取目标进程sleep函数地址<br>在目标进程内执行sleep函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">old_regs</span>,<span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">long</span> sleep_addr;</span><br><span class="line">    <span class="comment">//save old regs</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;regs, &amp;old_regs, <span class="keyword">sizeof</span>(regs));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"getting remote sleep_addr:\n"</span>);</span><br><span class="line">    sleep_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span> *)sleep); <span class="comment">//获取目标进程sleep函数地址</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> parameters[<span class="number">1</span>];</span><br><span class="line">    parameters[<span class="number">0</span>] = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    ptrace_call(pid, sleep_addr, parameters, <span class="number">1</span>, &amp;regs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//restore old regs</span></span><br><span class="line">    ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="如何获取函数地址"><a href="#如何获取函数地址" class="headerlink" title="如何获取函数地址"></a>如何获取函数地址</h2><ul>
<li>已知条件: 本进程的基址、目标进程的基址、本进程中sleep函数的地址(当然,这些已知条件也是需要获得的。<br>/proc/pid/maps文件中存储的是进程内存映射详情,我们可以在这个文件中查询进程中so的基址;<br>sleep函数在本进程中的地址直接可以获得(void*)</li>
<li>求解: 目标进程中sleep函数地址</li>
<li>计算: 本进程sleep地址 - 本进程基址 + 目标进程基址</li>
</ul>
<h3 id="获取so库的加载基址"><a href="#获取so库的加载基址" class="headerlink" title="获取so库的加载基址"></a>获取so库的加载基址</h3><p>因为libc.so在内存中的地址是随机的，所以我们需要先获取目标进程的libc.so的加载地址，再获取自己进程的libc.so的加载地址和sleep()在内存中的地址。然后我们就能计算出sleep()函数在目标进程中的地址了。要注意的是获取目标进程和自己进程的libc.so的加载地址是通过解析/proc/[pid]/maps得到的。</p>
<p>打开/proc/pid/maps文件找到基址.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">get_module_base</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *f;        <span class="comment">//文件指针</span></span><br><span class="line">    <span class="keyword">long</span> addr = <span class="number">0</span>;    <span class="comment">//模块地址</span></span><br><span class="line">    <span class="keyword">char</span> filename[<span class="number">32</span>];    <span class="comment">//maps路径</span></span><br><span class="line">    <span class="keyword">char</span> *pch;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">1024</span>];    <span class="comment">//每行</span></span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/self/maps"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/%d/maps"</span>, pid);</span><br><span class="line">    &#125;</span><br><span class="line">    f = fopen(filename, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(f != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(fgets(line,<span class="keyword">sizeof</span>(line),f))&#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="built_in">strstr</span>(line, module_name)) &#123; <span class="comment">//找到该行是否含有module_name</span></span><br><span class="line">               pch = strtok(line,<span class="string">"-"</span>); <span class="comment">//分割出基址字符串</span></span><br><span class="line">               addr = strtoul(pch,<span class="literal">NULL</span>,<span class="number">0x10</span>); <span class="comment">//转换为16进制数</span></span><br><span class="line">               <span class="keyword">if</span>(addr == <span class="number">0x8000</span>) <span class="comment">//32位linux程序中默认的text加载地址为0x08408000,64位的改为0x00400000,此时计算base地址就没什么用了</span></span><br><span class="line">                   addr = <span class="number">0</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(f);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="计算目标进程中sleep函数地址"><a href="#计算目标进程中sleep函数地址" class="headerlink" title="计算目标进程中sleep函数地址"></a>计算目标进程中sleep函数地址</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">get_remote_addr</span><span class="params">(<span class="keyword">int</span> target_pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name, <span class="keyword">void</span>* local_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* local_handle = get_module_base(<span class="number">0</span>,module_name); <span class="comment">//本进程的基址</span></span><br><span class="line">    <span class="keyword">void</span>* remote_handle = get_module_base(target_pid,module_name); <span class="comment">//目标进程的基址</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"local_handle:%p remote_handle:%p\n"</span>, local_handle, remote_handle);</span><br><span class="line">    <span class="comment">//计算公式</span></span><br><span class="line">    <span class="keyword">long</span> remote_addr = (<span class="keyword">long</span>)((<span class="keyword">uint32_t</span>)local_addr - (<span class="keyword">uint32_t</span>)local_handle + (<span class="keyword">uint32_t</span>)remote_handle);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"remote_addr:%p\n"</span>, remote_addr);</span><br><span class="line">    <span class="keyword">return</span> remote_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="如何执行sleep函数"><a href="#如何执行sleep函数" class="headerlink" title="如何执行sleep函数"></a>如何执行sleep函数</h2><ul>
<li>设置函数参数,如果参数个数小于等于4,参数按顺序放入R0~R4寄存器中;如果参数个数大于4,多余的部分需要入栈.</li>
<li>设置pc寄存器的值,设置当前指令集标志位.</li>
<li>应用以上寄存器的修改使之生效.</li>
<li>等待函数执行.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//目标进程id,目标函数地址,参数地址,参数个数,寄存器地址</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_call</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">long</span> addr, <span class="keyword">long</span> *params, <span class="keyword">uint32_t</span> params_num, struct pt_regs* regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; params_num &amp;&amp; i &lt; <span class="number">4</span>; i++) &#123; <span class="comment">//设置少于4个的参数</span></span><br><span class="line">        regs-&gt;uregs[i] = params[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置多于4个的参数</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; params_num) &#123;</span><br><span class="line">        regs-&gt;ARM_sp -= (params_num - i) * long_size; <span class="comment">//抬高栈顶指针(分配空间)</span></span><br><span class="line">        writeData(pid, (<span class="keyword">long</span>)regs-&gt;ARM_sp, (<span class="keyword">char</span>*)&amp;params[i], (params_num - i) * long_size); <span class="comment">//写入</span></span><br><span class="line">    &#125;</span><br><span class="line">    regs-&gt;ARM_pc = addr; <span class="comment">//设置pc</span></span><br><span class="line">    <span class="keyword">if</span> (regs-&gt;ARM_pc &amp; <span class="number">1</span>) &#123; <span class="comment">//判断是否是Thumb指令</span></span><br><span class="line">        regs-&gt;ARM_pc &amp;= (~<span class="number">1u</span>); <span class="comment">//Thumb的pc最后一位总是0</span></span><br><span class="line">        regs-&gt;ARM_cpsr |= CPSR_T_MASK; <span class="comment">//T标志位为1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//arm</span></span><br><span class="line">        regs-&gt;ARM_cpsr &amp;= ~CPSR_T_MASK; <span class="comment">//T标志位为0</span></span><br><span class="line">    &#125;</span><br><span class="line">    regs-&gt;ARM_lr = <span class="number">0</span>; <span class="comment">//为了使sleep函数执行完毕后产生“内存访问错误”,这样我们就知道什么时候执行完了</span></span><br><span class="line">    <span class="keyword">if</span>(ptrace_setregs(pid,regs)==<span class="number">-1</span> || ptrace_continue(pid)==<span class="number">-1</span>)&#123; <span class="comment">//目标进程继续执行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> stat = <span class="number">0</span>; <span class="comment">//WUNTRACED表示如果pid进程进入暂停状态，那么waitpid函数立即返回</span></span><br><span class="line">    waitpid(pid,&amp;stat,WUNTRACED); <span class="comment">//等待sleep函数执行,等待过程中本进程暂停执行</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, stat);</span><br><span class="line">    <span class="keyword">while</span> (stat != <span class="number">0xb7f</span>) &#123; <span class="comment">//0xb7f表示目标进程进入暂停状态</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, stat);</span><br><span class="line">        <span class="keyword">if</span> (ptrace_continue(pid) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        waitpid(pid,&amp;stat,WUNTRACED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="完整hook代码"><a href="#完整hook代码" class="headerlink" title="完整hook代码"></a>完整hook代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPSR_T_MASK ( 1u &lt;&lt; 5 )</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *libc_path = <span class="string">"/system/lib/libc.so"</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> long_size = <span class="keyword">sizeof</span>(<span class="keyword">long</span>);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_setregs</span><span class="params">(<span class="keyword">pid_t</span> pid, struct pt_regs * regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, regs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"ptrace_setregs: Can not set register values"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_continue</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ptrace(PTRACE_CONT, pid, <span class="literal">NULL</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"ptrace_cont"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">char</span> *laddr;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">union</span> u &#123;</span><br><span class="line">            <span class="keyword">long</span> val;</span><br><span class="line">            <span class="keyword">char</span> chars[long_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / long_size;</span><br><span class="line">    laddr = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.chars, laddr, long_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, child,</span><br><span class="line">               addr + i * <span class="number">4</span>, data.val);</span><br><span class="line">        ++i;</span><br><span class="line">        laddr += long_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % long_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.chars, laddr, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, child,</span><br><span class="line">               addr + i * <span class="number">4</span>, data.val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">get_module_base</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">long</span> addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *pch;</span><br><span class="line">    <span class="keyword">char</span> filename[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/self/maps"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/%d/maps"</span>, pid);</span><br><span class="line">    &#125;</span><br><span class="line">    fp = fopen(filename, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), fp)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, module_name)) &#123;</span><br><span class="line">                pch = strtok( line, <span class="string">"-"</span> );</span><br><span class="line">                addr = strtoul( pch, <span class="literal">NULL</span>, <span class="number">16</span> );</span><br><span class="line">                <span class="keyword">if</span> (addr == <span class="number">0x8000</span>)</span><br><span class="line">                    addr = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(fp) ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">get_remote_addr</span><span class="params">(<span class="keyword">pid_t</span> target_pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name, <span class="keyword">void</span>* local_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* local_handle, *remote_handle;</span><br><span class="line">    local_handle = get_module_base(<span class="number">0</span>, module_name);</span><br><span class="line">    remote_handle = get_module_base(target_pid, module_name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"module_base: local[%p], remote[%p]\n"</span>, local_handle, remote_handle);</span><br><span class="line">    <span class="keyword">long</span> ret_addr = (<span class="keyword">long</span>)((<span class="keyword">uint32_t</span>)local_addr + (<span class="keyword">uint32_t</span>)remote_handle - (<span class="keyword">uint32_t</span>)local_handle);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"remote_addr: [%p]\n"</span>, (<span class="keyword">void</span>*) ret_addr); </span><br><span class="line">    <span class="keyword">return</span> ret_addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_call</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">long</span> addr, <span class="keyword">long</span> *params, <span class="keyword">uint32_t</span> num_params, struct pt_regs* regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_params &amp;&amp; i &lt; <span class="number">4</span>; i ++) &#123;</span><br><span class="line">        regs-&gt;uregs[i] = params[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// push remained params onto stack</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; num_params) &#123;</span><br><span class="line">        regs-&gt;ARM_sp -= (num_params - i) * <span class="keyword">sizeof</span>(<span class="keyword">long</span>) ;</span><br><span class="line">        putdata(pid, (<span class="keyword">long</span>)regs-&gt;ARM_sp, (<span class="keyword">char</span>*)&amp;params[i], (num_params - i) * <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    regs-&gt;ARM_pc = addr;</span><br><span class="line">    <span class="keyword">if</span> (regs-&gt;ARM_pc &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* thumb */</span></span><br><span class="line">        regs-&gt;ARM_pc &amp;= (~<span class="number">1u</span>);</span><br><span class="line">        regs-&gt;ARM_cpsr |= CPSR_T_MASK;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* arm */</span></span><br><span class="line">        regs-&gt;ARM_cpsr &amp;= ~CPSR_T_MASK;</span><br><span class="line">    &#125;</span><br><span class="line">    regs-&gt;ARM_lr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ptrace_setregs(pid, regs) == <span class="number">-1</span></span><br><span class="line">            || ptrace_continue(pid) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> stat = <span class="number">0</span>;</span><br><span class="line">    waitpid(pid, &amp;stat, WUNTRACED);</span><br><span class="line">    <span class="keyword">while</span> (stat != <span class="number">0xb7f</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ptrace_continue(pid) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"error\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        waitpid(pid, &amp;stat, WUNTRACED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">old_regs</span>,<span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">long</span> sleep_addr;</span><br><span class="line">    <span class="comment">//save old regs</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;regs, &amp;old_regs, <span class="keyword">sizeof</span>(regs));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"getting remote sleep_addr:\n"</span>);</span><br><span class="line">    sleep_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span> *)sleep);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> parameters[<span class="number">1</span>];</span><br><span class="line">    parameters[<span class="number">0</span>] = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    ptrace_call(pid, sleep_addr, parameters, <span class="number">1</span>, &amp;regs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//restore old regs</span></span><br><span class="line">    ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;pid to be traced&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> != ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Trace process failed:%d.\n"</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    inject(pid);</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于waitpid"><a href="#关于waitpid" class="headerlink" title="关于waitpid"></a>关于waitpid</h2><p>详细介绍可看<a href="https://support.sas.com/documentation/onlinedoc/sasc/doc/lr2/wait.htm" target="_blank" rel="noopener">官方文档</a>.</p>
<h3 id="参数status"><a href="#参数status" class="headerlink" title="参数status"></a>参数status</h3><p>wait函数调用过后,status指针指向可以被宏解析的值,这些宏在ndk目录下platforms/android-21/arch-arm/usr/include/sys/wait.h文件中定义.<br>高2字节用于表示导致子进程的退出或暂停状态信号值(WTERMSIG)，低2字节表示子进程是退出(0x0)还是暂停(0x7f)状态(WEXITSTATUS)。<br>如:0xb7f就表示子进程为暂停状态，导致它暂停的信号量为11即sigsegv错误。<br>关于错误代码的文档可看<a href="https://support.sas.com/documentation/onlinedoc/sasc/doc/lr1/lrv1ch5.htm" target="_blank" rel="noopener">这里</a>,<br>定义在ndk目录下platforms/android-21/arch-arm/usr/include/asm/signal.h中.</p>
<blockquote>
<p>其中两个宏:<br>WEXITSTATUS(<em>statusPtr):<br>if the child process terminates normally, this macro evaluates to the lower 8 bits of the value passed to the exit or _exit function or returned from main.<br>WTERMSIG(</em>statusPtr)<br>if the child process ends by a signal that was not caught, this macro evaluates to the number of that signal.</p>
</blockquote>
<h3 id="参数options"><a href="#参数options" class="headerlink" title="参数options"></a>参数options</h3><p>指定了waitpid的额外行动.选项有:</p>
<ul>
<li>WNOHANG:<br>告诉waitpid不等程序中止立即返回status信息.<br>正常情况是当主进程对子进程使用了waitpid,主进程就会阻塞直到waitpid返回status信息;如果指定了WNOHANG选项,主进程就不会阻塞了.<br>如果还没有可用的status信息,waitpid返回0.</li>
<li>WUNTRACED:<br>告诉waitpid，如果子进程进入暂停状态或者已经终止，那么就立即返回status信息,正常情况是子进程终止的时候才返回.<br>如果是被ptrace的子进程，那么即使不提供WUNTRACED参数，也会在子进程进入暂停状态的时候立即返回。<br>对于使用ptrace_cont运行的子进程，它会在3种情况下进入暂停状态：①下一次系统调用；②子进程退出；③子进程的执行发生错误。<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3>程序中的0xb7f就表示子进程进入了暂停状态，且发送的错误信号为11(SIGSEGV)，它表示试图访问未分配给自己的内存, 或试图往没有写权限的内存地址写数据。<br>当子进程执行完注入的函数后，由于我们在前面设置了regs-&gt;ARM_lr = 0，它就会返回到0地址处继续执行，这样就会产生SIGSEGV了.</li>
</ul>
<h2 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h2><p>正常的情况是target程序每秒输出一句话，但是用hook3程序hook后，就会暂停10秒钟的时间，因为我们利用ptrace运行了sleep(10)在目标程序中。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo3bly0dahj318u0ooh6r.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fo3bo4h798j30vm0g67e0.jpg" alt=""></p>
<h1 id="利用Ptrace动态加载so并执行自定义函数"><a href="#利用Ptrace动态加载so并执行自定义函数" class="headerlink" title="利用Ptrace动态加载so并执行自定义函数"></a>利用Ptrace动态加载so并执行自定义函数</h1><h2 id="总体思路-1"><a href="#总体思路-1" class="headerlink" title="总体思路"></a>总体思路</h2><ul>
<li>保存当前寄存器的状态</li>
<li>获取目标程序的mmap, dlopen, dlsym, dlclose函数地址</li>
<li>调用mmap分配空间保存参数信息</li>
<li>调用dlopen加载so库</li>
<li>调用dlsym找到目标函数地址</li>
<li>执行目标函数</li>
<li>调用dlclose卸载so库</li>
<li>恢复寄存器的状态</li>
</ul>
<h2 id="保存当前寄存器的状态"><a href="#保存当前寄存器的状态" class="headerlink" title="保存当前寄存器的状态"></a>保存当前寄存器的状态</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">old_regs</span>,<span class="title">regs</span>;</span></span><br><span class="line">ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;regs,&amp;old_regs,<span class="keyword">sizeof</span>(regs));</span><br></pre></td></tr></table></figure>
<h2 id="获取目标程序的mmap-dlopen-dlsym-dlclose函数地址"><a href="#获取目标程序的mmap-dlopen-dlsym-dlclose函数地址" class="headerlink" title="获取目标程序的mmap, dlopen, dlsym, dlclose函数地址"></a>获取目标程序的mmap, dlopen, dlsym, dlclose函数地址</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> mmap_addr,dlopen_addr,dlsym_addr,dlclose_addr;</span><br><span class="line">mmap_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span>*)mmap);</span><br><span class="line">dlopen_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span>*)dlopen);</span><br><span class="line">dlsym_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span>*)dlsym);</span><br><span class="line">dlclose_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span>*)dlclose);</span><br></pre></td></tr></table></figure>
<h2 id="调用mmap分配空间保存参数信息"><a href="#调用mmap分配空间保存参数信息" class="headerlink" title="调用mmap分配空间保存参数信息"></a>调用mmap分配空间保存参数信息</h2><p>mmap的原型如下:<br><code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</code><br>参数    描述</p>
<ul>
<li>addr    映射的起始地址,为0表示由系统决定映射的起始地址</li>
<li>length    映射的长度</li>
<li>prot    映射的内存保存属性,不能与文件的打开模式冲突</li>
<li>flags    指定映射对象的类型,映射选项和映射页是否可以共享</li>
<li>fd    有效的文件描述符,一般是由open()函数返回;其值也可以设置为-1,此时需要指定flags参数中的MAP_ANON,表明进行的是匿名映射</li>
<li>offset    被映射对象内容的起点</li>
</ul>
<p>这里我们需要的调用语句是<br><code>mmap(0,0x4000,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANONYMOUS|MAP_PRIVATE,0,0)</code></p>
<ul>
<li>PROT_EXEC表示可执行.</li>
<li>PROT_READ表示可读.</li>
<li>PROT_WRITE表示可写.</li>
<li>MAP_PRIVATE表示建立一个写入时拷贝的私有映射.内存区域的写入不会影响到原文件.这个标志和以上标志是互斥的,只能使用其中一个.</li>
<li>MAP_ANONYMOUS表示匿名映射,映射区不与任何文件关联.</li>
</ul>
<p>mmap()可以用来将一个文件或者其它对象映射进内存，如果我们把flag设置为MAP_ANONYMOUS并且把参数fd设置为0的话就相当于直接映射一段内容为空的内存。<br>则:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> parameters[<span class="number">10</span>];    </span><br><span class="line">parameters[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">//构造参数</span></span><br><span class="line">parameters[<span class="number">1</span>] = <span class="number">0x4000</span>;</span><br><span class="line">parameters[<span class="number">2</span>] = PROT_READ | PROT_WRITE | PROT_EXEC;</span><br><span class="line">parameters[<span class="number">3</span>] = MAP_ANONYMOUS | MAP_PRIVATE;</span><br><span class="line">parameters[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">parameters[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">ptrace_call(pid,mmap_addr,parameters,<span class="number">6</span>,&amp;regs);</span><br><span class="line"><span class="comment">//调用结束后获得r0中保存的返回值</span></span><br><span class="line">ptrace(PTRACE_GETREGS,pid,<span class="literal">NULL</span>,&amp;regs);</span><br><span class="line"><span class="keyword">long</span> mapping_base = regs.ARM_r0;</span><br></pre></td></tr></table></figure></p>
<p>在我们使用ptrace_call(pid, mmap_addr, parameters, 6, &amp;regs)调用完mmap()函数之后，要记得使用ptrace(PTRACE_GETREGS, pid, NULL, &amp;regs); 用来获取保存返回值的regs.ARM_r0，这个返回值也就是映射的内存的起始地址。<br>mmap()映射的内存主要用来保存我们传给其他函数的参数。比如接下来我们需要用dlopen()去加载”/data/local/tmp/libinject.so”这个文件，所以我们需要先用putdata()将”/data/local/tmp/libinject.so”这个字符串放置在mmap()所映射的内存中，然后就可以将这个映射的地址作为参数传递给dlopen()了。接下来的dlsym()，so中的目标函数，dlclose()都是相同调用的方式，这里就不一一赘述了。</p>
<h2 id="调用dlsym找到目标函数地址"><a href="#调用dlsym找到目标函数地址" class="headerlink" title="调用dlsym找到目标函数地址"></a>调用dlsym找到目标函数地址</h2><p>原型:<br>void <em>dlsym(void </em>handle, const char *symbol);<br>参数    描述<br>handle    so库的基址<br>symbol    函数名地址<br>这里我们需要的调用语句是dlsym(handle, function_name),则:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">writeData(pid, mapping_base, function_name, <span class="built_in">strlen</span>(function_name)+<span class="number">1</span>);</span><br><span class="line">parameters[<span class="number">0</span>] = handle;</span><br><span class="line">parameters[<span class="number">1</span>] = mapping_base;</span><br><span class="line">ptrace_call(pid, dlsym_addr, parameters, <span class="number">2</span>, &amp;regs);</span><br><span class="line">ptrace(PTRACE_GETREGS,pid,<span class="literal">NULL</span>,&amp;regs); <span class="comment">//调用结束后获得r0中保存的返回值</span></span><br><span class="line"><span class="keyword">long</span> function_addr = regs.ARM_r0;</span><br></pre></td></tr></table></figure></p>
<h2 id="执行目标函数"><a href="#执行目标函数" class="headerlink" title="执行目标函数"></a>执行目标函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">writeData(pid, mapping_base, function_parameters, <span class="built_in">strlen</span>(function_parameters)+<span class="number">1</span>);</span><br><span class="line">parameters[<span class="number">0</span>] = mapping_base;</span><br><span class="line">ptrace_call(pid, function_addr, parameters, <span class="number">1</span>, &amp;regs);</span><br></pre></td></tr></table></figure>
<h2 id="调用dlclose卸载so库"><a href="#调用dlclose卸载so库" class="headerlink" title="调用dlclose卸载so库"></a>调用dlclose卸载so库</h2><p>原型:<code>int dlclose(void *handle);</code><br>则:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parameters[<span class="number">0</span>] = handle;</span><br><span class="line">ptrace_call(pid,dlclose_addr,parameters,<span class="number">1</span>,&amp;regs);</span><br></pre></td></tr></table></figure></p>
<h2 id="恢复寄存器的状态"><a href="#恢复寄存器的状态" class="headerlink" title="恢复寄存器的状态"></a>恢复寄存器的状态</h2><p><code>ptrace(PTRACE_SETREGS,pid,NULL,&amp;old_regs);</code></p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPSR_T_MASK     ( 1u &lt;&lt; 5 )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *libc_path = <span class="string">"/system/lib/libc.so"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> long_size = <span class="keyword">sizeof</span>(<span class="keyword">long</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_setregs</span><span class="params">(<span class="keyword">pid_t</span> pid, struct pt_regs * regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, regs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"ptrace_setregs: Can not set register values"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_continue</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ptrace(PTRACE_CONT, pid, <span class="literal">NULL</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"ptrace_cont"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="keyword">char</span> *laddr;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">union</span> u &#123;</span><br><span class="line">            <span class="keyword">long</span> val;</span><br><span class="line">            <span class="keyword">char</span> chars[long_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / long_size;</span><br><span class="line">    laddr = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.chars, laddr, long_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, child,</span><br><span class="line">               addr + i * <span class="number">4</span>, data.val);</span><br><span class="line">        ++i;</span><br><span class="line">        laddr += long_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % long_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.chars, laddr, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, child,</span><br><span class="line">               addr + i * <span class="number">4</span>, data.val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">get_module_base</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">long</span> addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *pch;</span><br><span class="line">    <span class="keyword">char</span> filename[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/self/maps"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"/proc/%d/maps"</span>, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fp = fopen(filename, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), fp)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, module_name)) &#123;</span><br><span class="line">                pch = strtok( line, <span class="string">"-"</span> );</span><br><span class="line">                addr = strtoul( pch, <span class="literal">NULL</span>, <span class="number">16</span> );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (addr == <span class="number">0x8000</span>)</span><br><span class="line">                    addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fclose(fp) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">get_remote_addr</span><span class="params">(<span class="keyword">pid_t</span> target_pid, <span class="keyword">const</span> <span class="keyword">char</span>* module_name, <span class="keyword">void</span>* local_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* local_handle, *remote_handle;</span><br><span class="line"></span><br><span class="line">    local_handle = get_module_base(<span class="number">0</span>, module_name);</span><br><span class="line">    remote_handle = get_module_base(target_pid, module_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> ret_addr = (<span class="keyword">long</span>)((<span class="keyword">uint32_t</span>)local_addr + (<span class="keyword">uint32_t</span>)remote_handle - (<span class="keyword">uint32_t</span>)local_handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_call</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">uint32_t</span> addr, <span class="keyword">long</span> *params, <span class="keyword">uint32_t</span> num_params, struct pt_regs* regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_params &amp;&amp; i &lt; <span class="number">4</span>; i ++) &#123;</span><br><span class="line">        regs-&gt;uregs[i] = params[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// push remained params onto stack</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; num_params) &#123;</span><br><span class="line">        regs-&gt;ARM_sp -= (num_params - i) * <span class="keyword">sizeof</span>(<span class="keyword">long</span>) ;</span><br><span class="line">        putdata(pid, regs-&gt;ARM_sp, (<span class="keyword">char</span>*)&amp;params[i], (num_params - i) * <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    regs-&gt;ARM_pc = addr;</span><br><span class="line">    <span class="keyword">if</span> (regs-&gt;ARM_pc &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* thumb */</span></span><br><span class="line">        regs-&gt;ARM_pc &amp;= (~<span class="number">1u</span>);</span><br><span class="line">        regs-&gt;ARM_cpsr |= CPSR_T_MASK;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* arm */</span></span><br><span class="line">        regs-&gt;ARM_cpsr &amp;= ~CPSR_T_MASK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    regs-&gt;ARM_lr = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ptrace_setregs(pid, regs) == <span class="number">-1</span></span><br><span class="line">            || ptrace_continue(pid) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> stat = <span class="number">0</span>;</span><br><span class="line">    waitpid(pid, &amp;stat, WUNTRACED);</span><br><span class="line">    <span class="keyword">while</span> (stat != <span class="number">0xb7f</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ptrace_continue(pid) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"error\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        waitpid(pid, &amp;stat, WUNTRACED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">injectSo</span><span class="params">(<span class="keyword">pid_t</span> pid,<span class="keyword">char</span>* so_path, <span class="keyword">char</span>* function_name,<span class="keyword">char</span>* parameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> <span class="title">old_regs</span>,<span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">long</span> mmap_addr, dlopen_addr, dlsym_addr, dlclose_addr;</span><br><span class="line"></span><br><span class="line"><span class="comment">//save old regs</span></span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;regs, &amp;old_regs, <span class="keyword">sizeof</span>(regs));</span><br><span class="line"></span><br><span class="line"><span class="comment">//get remote addres</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"getting remote addres:\n"</span>);</span><br><span class="line">    mmap_addr = get_remote_addr(pid, libc_path, (<span class="keyword">void</span> *)mmap);</span><br><span class="line">    dlopen_addr = get_remote_addr( pid, libc_path, (<span class="keyword">void</span> *)dlopen );</span><br><span class="line">    dlsym_addr = get_remote_addr( pid, libc_path, (<span class="keyword">void</span> *)dlsym );</span><br><span class="line">    dlclose_addr = get_remote_addr( pid, libc_path, (<span class="keyword">void</span> *)dlclose );</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mmap_addr=%p dlopen_addr=%p dlsym_addr=%p dlclose_addr=%p\n"</span>,</span><br><span class="line">    (<span class="keyword">void</span>*)mmap_addr,(<span class="keyword">void</span>*)dlopen_addr,(<span class="keyword">void</span>*)dlsym_addr,(<span class="keyword">void</span>*)dlclose_addr);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">long</span> parameters[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//mmap</span></span><br><span class="line"></span><br><span class="line">    parameters[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">//address</span></span><br><span class="line">    parameters[<span class="number">1</span>] = <span class="number">0x4000</span>; <span class="comment">//size</span></span><br><span class="line">    parameters[<span class="number">2</span>] = PROT_READ | PROT_WRITE | PROT_EXEC; <span class="comment">//WRX</span></span><br><span class="line">    parameters[<span class="number">3</span>] = MAP_ANONYMOUS | MAP_PRIVATE; <span class="comment">//flag</span></span><br><span class="line">    parameters[<span class="number">4</span>] = <span class="number">0</span>; <span class="comment">//fd</span></span><br><span class="line">    parameters[<span class="number">5</span>] = <span class="number">0</span>; <span class="comment">//offset</span></span><br><span class="line">    </span><br><span class="line">    ptrace_call(pid, mmap_addr, parameters, <span class="number">6</span>, &amp;regs);</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> map_base = regs.ARM_r0;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"map_base = %p\n"</span>, (<span class="keyword">void</span>*)map_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">//dlopen</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"save so_path = %s to map_base = %p\n"</span>, so_path, (<span class="keyword">void</span>*)map_base);</span><br><span class="line">    putdata(pid, map_base, so_path, <span class="built_in">strlen</span>(so_path) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    parameters[<span class="number">0</span>] = map_base;</span><br><span class="line">    parameters[<span class="number">1</span>] = RTLD_NOW| RTLD_GLOBAL;</span><br><span class="line"></span><br><span class="line">    ptrace_call(pid, dlopen_addr, parameters, <span class="number">2</span>, &amp;regs);</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">long</span> handle = regs.ARM_r0;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"handle = %p\n"</span>,(<span class="keyword">void</span>*) handle);</span><br><span class="line"></span><br><span class="line"><span class="comment">//dlsym</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"save function_name = %s to map_base = %p\n"</span>, function_name, (<span class="keyword">void</span>*)map_base);</span><br><span class="line">    putdata(pid, map_base, function_name, <span class="built_in">strlen</span>(function_name) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    parameters[<span class="number">0</span>] = handle;</span><br><span class="line">    parameters[<span class="number">1</span>] = map_base;</span><br><span class="line"></span><br><span class="line">    ptrace_call(pid, dlsym_addr, parameters, <span class="number">2</span>, &amp;regs);</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">long</span> function_ptr = regs.ARM_r0;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"function_ptr = %p\n"</span>, (<span class="keyword">void</span>*)function_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//function_call</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"save parameter = %s to map_base = %p\n"</span>, parameter, (<span class="keyword">void</span>*)map_base);</span><br><span class="line">    putdata(pid, map_base, parameter, <span class="built_in">strlen</span>(parameter) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    parameters[<span class="number">0</span>] = map_base;</span><br><span class="line"></span><br><span class="line">    ptrace_call(pid, function_ptr, parameters, <span class="number">1</span>, &amp;regs);</span><br><span class="line"></span><br><span class="line"><span class="comment">//dlcose</span></span><br><span class="line"></span><br><span class="line">    parameters[<span class="number">0</span>] = handle;</span><br><span class="line"></span><br><span class="line">    ptrace_call(pid, dlclose_addr, parameters, <span class="number">1</span>, &amp;regs);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//restore old regs</span></span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, &amp;old_regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;pid to be traced&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">                                                                                                     </span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> != ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Trace process failed:%d.\n"</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>* so_path = <span class="string">"/data/local/tmp/libinject.so"</span>;</span><br><span class="line">    <span class="keyword">char</span>* function_name = <span class="string">"mzhengHook"</span>;</span><br><span class="line">    <span class="keyword">char</span>* parameter = <span class="string">"sevenWeapons"</span>;</span><br><span class="line">    injectSo(pid, so_path, function_name, parameter);</span><br><span class="line">    </span><br><span class="line">    ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">sakura</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">96</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sakura</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
